<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronoweave - Competitive Textile Challenge</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Performance optimizations */
        .challenge-card, .grid-cell, .quiz-option {
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* Reduce animation complexity for better performance */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 107, 107, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(78, 205, 196, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: backgroundPulse 10s ease-in-out infinite;
        }
        
        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .screen, .container {
            position: relative;
            z-index: 1;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00d4ff, #4ecdc4);
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.3);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #4ecdc4, #00d4ff);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .screen {
            display: none;
            min-height: 100vh;
            padding: 2rem;
            animation: screenFadeIn 0.5s ease-out;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes screenFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .registration-form {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 2.5rem 4rem;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            max-width: 700px;
            width: 90%;
            margin: 3vh auto;
            max-height: 94vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: formFloat 3s ease-in-out infinite;
        }
        
        @keyframes formFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .main-title {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #ff6b6b, #4ecdc4, #ffd700);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 4s ease-in-out infinite;
            margin-bottom: 0.8rem;
            letter-spacing: 3px;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
        }
        
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            letter-spacing: 1px;
            animation: subtitleFade 2s ease-in-out infinite;
        }
        
        @keyframes subtitleFade {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        input, select {
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.12));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: #ffffff;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 212, 255, 0.1));
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.4), inset 0 0 15px rgba(0, 212, 255, 0.1);
            transform: translateY(-2px);
        }
        
        input:hover, select:hover {
            border-color: rgba(0, 212, 255, 0.5);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.15));
        }
        
        input::placeholder {
            color: #a0a0a0;
        }
        
        .enter-btn, .game-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #00d4ff, #4ecdc4, #00d4ff);
            background-size: 200% 200%;
            border: none;
            border-radius: 12px;
            color: #000;
            font-family: inherit;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 0.5rem;
            position: relative;
            z-index: 100;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            overflow: hidden;
        }
        
        .enter-btn::before, .game-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .enter-btn:hover::before, .game-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .enter-btn {
            width: 100%;
        }
        
        .enter-btn:hover, .game-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.5);
            background-position: 100% 50%;
        }
        
        .enter-btn:active, .game-btn:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }
        
        .dashboard {
            text-align: center;
        }
        
        .welcome-message {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: #00d4ff;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.6);
            animation: welcomePulse 3s ease-in-out infinite;
        }
        
        @keyframes welcomePulse {
            0%, 100% { 
                text-shadow: 0 0 30px rgba(0, 212, 255, 0.6);
                transform: scale(1);
            }
            50% { 
                text-shadow: 0 0 40px rgba(0, 212, 255, 0.8), 0 0 60px rgba(0, 212, 255, 0.4);
                transform: scale(1.02);
            }
        }
        
        .player-stats {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.12));
            padding: 2.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            border: 2px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .stat {
            text-align: center;
            margin: 1rem;
            padding: 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .stat:hover {
            background: rgba(0, 212, 255, 0.1);
            transform: translateY(-3px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00d4ff;
            display: block;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            animation: statGlow 2s ease-in-out infinite;
        }
        
        @keyframes statGlow {
            0%, 100% { text-shadow: 0 0 20px rgba(0, 212, 255, 0.5); }
            50% { text-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 40px rgba(0, 212, 255, 0.4); }
        }
        
        .challenge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .challenge-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.12));
            padding: 2rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .challenge-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .challenge-card:hover::before {
            left: 100%;
        }
        
        .challenge-card:hover {
            transform: translateY(-8px) scale(1.02);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.2));
            border-color: rgba(0, 212, 255, 0.5);
            box-shadow: 0 15px 50px rgba(0, 212, 255, 0.3);
        }
        
        .challenge-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            animation: iconBounce 2s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(0, 212, 255, 0.3));
        }
        
        @keyframes iconBounce {
            0%, 100% { 
                transform: translateY(0px) scale(1);
            }
            50% { 
                transform: translateY(-10px) scale(1.05);
            }
        }
        
        .avatar-option {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .avatar-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.3), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .avatar-option:hover::before {
            width: 200%;
            height: 200%;
        }
        
        .avatar-option:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.15));
            transform: scale(1.15) rotate(3deg);
            border-color: rgba(255, 105, 180, 0.5);
            box-shadow: 0 5px 20px rgba(255, 105, 180, 0.3);
        }
        
        .avatar-option.selected {
            border-color: #ff69b4;
            box-shadow: 0 0 25px rgba(255, 105, 180, 0.8);
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.2), rgba(255, 105, 180, 0.1));
            transform: scale(1.1);
            animation: selectedPulse 2s ease-in-out infinite;
        }
        
        @keyframes selectedPulse {
            0%, 100% { 
                box-shadow: 0 0 25px rgba(255, 105, 180, 0.8);
            }
            50% { 
                box-shadow: 0 0 35px rgba(255, 105, 180, 1);
            }
        }
        
        #avatar-preview {
            position: relative;
        }
        
        #avatar-display {
            position: relative;
        }
        
        #avatar-accessory {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 80px;
        }
        
        /* Challenge Screens */
        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
            padding: 1.5rem 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .back-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #ffffff;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-family: inherit;
            position: relative;
            z-index: 100;
            pointer-events: auto;
            transition: all 0.3s ease;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        .back-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-color: #00d4ff;
            transform: translateX(-5px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }
        
        .back-btn:active {
            transform: translateX(-3px) scale(0.95);
        }
        
        .challenge-timer {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
            animation: timerPulse 1s ease-in-out infinite;
            padding: 0.5rem 1rem;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 12px;
            border: 2px solid rgba(255, 107, 107, 0.3);
        }
        
        @keyframes timerPulse {
            0%, 100% { 
                text-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
            }
            50% { 
                text-shadow: 0 0 30px rgba(255, 107, 107, 0.8), 0 0 40px rgba(255, 107, 107, 0.4);
            }
        }
        
        /* Heritage Challenge */
        .heritage-theme {
            background: linear-gradient(135deg, #2c1810 0%, #4a2c1a 100%);
        }
        
        .pattern-info {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.08));
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.2);
        }
        
        .grid-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            gap: 4rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .grid-section {
            text-align: center;
        }
        
        .grid-game {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-width: 280px;
            margin: 1rem auto;
        }
        
        .grid-cell {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(5px);
            will-change: transform;
        }
        
        .grid-cell:hover {
            transform: scale(1.05);
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        
        .grid-cell.target {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 215, 0, 0.2));
            color: #ffd700;
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            animation: targetPulse 3s ease-in-out infinite;
            transform: translateZ(0);
        }
        
        @keyframes targetPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .grid-cell.selected {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.7), rgba(255, 215, 0, 0.5));
            border-color: #ffd700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            transform: scale(1.05) translateZ(0);
        }
        
        .grid-cell.correct {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.5), rgba(0, 255, 0, 0.3));
            border-color: #00ff00;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.6);
            animation: correctPulse 0.5s ease-out;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Innovation Challenge */
        .innovation-theme {
            background: linear-gradient(135deg, #1a2332 0%, #2d4a6b 100%);
        }
        
        .quiz-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }
        
        .question-display {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.25), rgba(70, 130, 180, 0.15));
            border-radius: 15px;
            border-left: 5px solid #4682b4;
            box-shadow: 0 5px 20px rgba(70, 130, 180, 0.2);
            backdrop-filter: blur(10px);
            animation: questionSlideIn 0.5s ease-out;
        }
        
        @keyframes questionSlideIn {
            from { 
                opacity: 0;
                transform: translateX(-30px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .quiz-option {
            padding: 1.2rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(70, 130, 180, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: left;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .quiz-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, #4682b4, #00bfff);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .quiz-option:hover::before {
            transform: scaleY(1);
        }
        
        .quiz-option:hover {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.25), rgba(70, 130, 180, 0.15));
            border-color: #4682b4;
            transform: translateX(10px);
            box-shadow: 0 5px 25px rgba(70, 130, 180, 0.3);
        }
        
        .quiz-option.correct {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.4), rgba(76, 175, 80, 0.2));
            border-color: #4caf50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
            animation: correctAnswer 0.6s ease-out;
        }
        
        @keyframes correctAnswer {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .quiz-option.incorrect {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.4), rgba(244, 67, 54, 0.2));
            border-color: #f44336;
            box-shadow: 0 0 30px rgba(244, 67, 54, 0.5);
            animation: shake 0.5s ease-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .quiz-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(70, 130, 180, 0.1);
            border-radius: 10px;
        }
        
        /* Heritage Video Styles */
        .heritage-video-intro {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .heritage-story {
            position: relative;
            min-height: 300px;
            margin: 2rem 0;
        }
        
        .story-scene {
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateY(20px) scale(0.98);
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            pointer-events: none;
        }
        
        .story-scene.active {
            opacity: 1;
            position: relative;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        
        .ancient-weaver {
            text-align: center;
        }
        
        .weaver-silhouette {
            font-size: 4rem;
            animation: float 3s ease-in-out infinite;
        }
        
        .loom-animation {
            position: relative;
            width: 200px;
            height: 150px;
            margin: 2rem auto;
        }
        
        .loom-threads-vertical {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                #ffd700 0px,
                #ffd700 3px,
                transparent 3px,
                transparent 15px
            );
            animation: weaveVertical 2s ease-in-out infinite;
        }
        
        .shuttle {
            position: absolute;
            width: 40px;
            height: 10px;
            background: #ff8c00;
            border-radius: 5px;
            top: 50%;
            animation: shuttleMove 2s ease-in-out infinite;
        }
        
        .pattern-showcase {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            font-size: 2rem;
            color: #ffd700;
            animation: patternPulse 2s ease-in-out infinite;
        }
        
        .challenge-preview {
            text-align: center;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            max-width: 200px;
            margin: 0 auto;
        }
        
        .preview-cell {
            width: 50px;
            height: 50px;
            border: 2px solid #ffd700;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #ffd700;
            animation: cellGlow 1.5s ease-in-out infinite;
        }
        
        .story-text {
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 1.5rem;
            border-radius: 10px;
            max-width: 600px;
            backdrop-filter: blur(10px);
            animation: textSlideIn 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes textSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .story-text h4 {
            color: #ffd700;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .story-text p {
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        /* Engineering Video Styles */
        .engineering-video-intro {
            background: rgba(0, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid rgba(0, 255, 255, 0.3);
        }
        
        .engineering-story {
            position: relative;
            min-height: 300px;
            margin: 2rem 0;
        }
        
        .eng-scene {
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateX(30px) scale(0.97);
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            pointer-events: none;
        }
        
        .eng-scene.active {
            opacity: 1;
            position: relative;
            transform: translateX(0) scale(1);
            pointer-events: auto;
        }
        
        .smart-fabric-demo {
            position: relative;
            width: 250px;
            height: 200px;
        }
        
        .fabric-layer {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.1));
            border: 2px solid #00ffff;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .nano-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle, #00ffff 2px, transparent 2px);
            background-size: 30px 30px;
            animation: particleFloat 3s ease-in-out infinite;
        }
        
        .conductive-threads {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 20px,
                rgba(0, 255, 255, 0.3) 20px,
                rgba(0, 255, 255, 0.3) 22px
            );
            animation: threadFlow 2s linear infinite;
        }
        
        .engineering-diagram {
            width: 100%;
            max-width: 400px;
        }
        
        .property-bar {
            margin: 1rem 0;
        }
        
        .property-bar span {
            display: block;
            margin-bottom: 0.5rem;
            color: #00ffff;
            font-weight: 600;
        }
        
        .property-bar .bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .property-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #4ecdc4);
            border-radius: 10px;
            animation: barPulse 2s ease-in-out infinite;
        }
        
        .challenge-preview-eng {
            text-align: center;
        }
        
        .material-icons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .mat-icon {
            padding: 1rem;
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #00ffff;
            border-radius: 10px;
            font-weight: 600;
            animation: iconFloat 2s ease-in-out infinite;
        }
        
        .mat-icon:nth-child(2) { animation-delay: 0.5s; }
        .mat-icon:nth-child(3) { animation-delay: 1s; }
        .mat-icon:nth-child(4) { animation-delay: 1.5s; }
        
        /* Video Animations */
        @keyframes weaveVertical {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(5px); }
        }
        
        @keyframes shuttleMove {
            0%, 100% { left: 0%; }
            50% { left: calc(100% - 40px); }
        }
        
        @keyframes patternPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes cellGlow {
            0%, 100% { box-shadow: 0 0 5px #ffd700; }
            50% { box-shadow: 0 0 15px #ffd700; }
        }
        
        @keyframes particleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes threadFlow {
            from { background-position: 0 0; }
            to { background-position: 40px 40px; }
        }
        
        @keyframes barPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        /* Future Challenge - Engineering Simulator */
        .future-theme {
            background: linear-gradient(135deg, #0a1a1a 0%, #1a3333 100%);
        }
        
        .engineering-challenge {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .mission-brief {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.15), rgba(0, 255, 255, 0.08));
            border: 2px solid #00ffff;
            border-radius: 20px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .mission-brief::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent);
            animation: missionScan 3s ease-in-out infinite;
        }
        
        @keyframes missionScan {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .mission-text {
            font-size: 1.1rem;
            margin: 1rem 0;
            line-height: 1.6;
        }
        
        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .requirement-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .req-label {
            font-weight: 600;
            color: #a0a0a0;
        }
        
        .req-value {
            font-family: 'Orbitron', monospace;
            color: #00ffff;
            font-weight: 700;
        }
        
        .material-selection {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .material-card {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.12), rgba(0, 255, 255, 0.08));
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .material-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .material-card:hover::before {
            opacity: 1;
        }
        
        .material-card:hover {
            border-color: #00ffff;
            box-shadow: 0 10px 40px rgba(0, 255, 255, 0.4);
            transform: translateY(-5px) scale(1.02);
        }
        
        .material-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .material-icon {
            font-size: 1.5rem;
        }
        
        .material-name {
            font-weight: 700;
            color: #00ffff;
        }
        
        .material-stats {
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-bottom: 1rem;
            line-height: 1.8;
        }
        
        .material-slider {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffff, #4ecdc4);
            cursor: pointer;
            box-shadow: 0 0 15px #00ffff, 0 3px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px #00ffff, 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffff, #4ecdc4);
            cursor: pointer;
            box-shadow: 0 0 15px #00ffff, 0 3px 10px rgba(0, 0, 0, 0.3);
            border: none;
            transition: all 0.3s ease;
        }
        
        .slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px #00ffff, 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .slider-value {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: #00ffff;
            min-width: 45px;
        }
        
        .composition-warning {
            text-align: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            color: #ff6b6b;
            font-weight: 600;
        }
        
        .composition-warning.valid {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4caf50;
            color: #4caf50;
        }
        
        .results-dashboard {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .results-grid {
            display: grid;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .result-metric {
            display: grid;
            grid-template-columns: 150px 1fr 100px 50px;
            gap: 1rem;
            align-items: center;
        }
        
        .metric-label {
            font-weight: 600;
            color: #00ffff;
        }
        
        .metric-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .metric-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .metric-value {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-align: right;
        }
        
        .metric-status {
            font-size: 1.5rem;
            text-align: center;
        }
        
        .overall-score {
            text-align: center;
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .overall-score h4 {
            font-size: 2rem;
            color: #00ffff;
            margin-bottom: 1rem;
        }
        
        .score-breakdown {
            color: #a0a0a0;
            font-size: 0.9rem;
        }
        
        .canvas-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        #design-canvas {
            border: 3px solid #00ffff;
            border-radius: 15px;
            cursor: crosshair;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4), inset 0 0 20px rgba(0, 255, 255, 0.1);
            background: #000;
            transition: all 0.3s ease;
        }
        
        #design-canvas:hover {
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.6), inset 0 0 30px rgba(0, 255, 255, 0.15);
            transform: scale(1.01);
        }
        
        .canvas-controls {
            margin: 2rem 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .color-btn {
            width: 50px;
            height: 50px;
            border: 3px solid #00ffff;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        
        .color-btn::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .color-btn:hover {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }
        
        .color-btn:hover::before {
            border-color: rgba(0, 255, 255, 0.3);
        }
        
        .color-btn.active {
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.9);
            transform: scale(1.25);
            border-width: 4px;
        }
        
        .color-btn.active::before {
            border-color: #00ffff;
            animation: colorRing 1.5s ease-in-out infinite;
        }
        
        @keyframes colorRing {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.2);
                opacity: 0.5;
            }
        }
        
        .score-display {
            background: rgba(0, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 2rem;
        }
        
        /* Animated Narrative Video Styles */
        .narrative-video {
            position: relative;
            width: 100%;
            height: 70vh;
            min-height: 500px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            margin: 2rem 0;
            border: 3px solid #4682b4;
            box-shadow: 0 0 30px rgba(70, 130, 180, 0.5);
        }
        
        .video-screen {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .video-scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 1.5s cubic-bezier(0.4, 0, 0.2, 1), 
                        transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        .video-scene.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        
        /* Scene Backgrounds */
        .scene-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .ancient-world {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #CD853F 100%);
        }
        
        .industrial-era {
            background: linear-gradient(135deg, #2F4F4F 0%, #696969 50%, #A9A9A9 100%);
        }
        
        .laboratory {
            background: linear-gradient(135deg, #191970 0%, #4169E1 50%, #87CEEB 100%);
        }
        
        .digital-world {
            background: linear-gradient(135deg, #000080 0%, #4B0082 50%, #8A2BE2 100%);
        }
        
        .future-lab {
            background: linear-gradient(135deg, #000000 0%, #1a3333 50%, #00FFFF 100%);
        }
        
        .challenge-arena {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        /* Animated Elements */
        .floating-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .floating-particles::before,
        .floating-particles::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 215, 0, 0.8);
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        
        .floating-particles::before {
            top: 20%;
            left: 20%;
            animation-delay: 0s;
        }
        
        .floating-particles::after {
            top: 60%;
            right: 30%;
            animation-delay: 1.5s;
        }
        
        /* Ancient Loom Animation */
        .ancient-loom {
            position: relative;
            width: 200px;
            height: 150px;
            margin: 2rem auto;
        }
        
        .loom-frame {
            width: 100%;
            height: 100%;
            border: 4px solid #8B4513;
            border-radius: 10px;
            position: relative;
        }
        
        .loom-threads {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            background: repeating-linear-gradient(
                90deg,
                #FFD700 0px,
                #FFD700 2px,
                transparent 2px,
                transparent 8px
            );
            animation: weave 2s ease-in-out infinite;
        }
        
        .weaver-hands {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #D2691E;
            border-radius: 50%;
            animation: weaving 1.5s ease-in-out infinite;
        }
        
        /* Spinning Jenny Animation */
        .spinning-jenny {
            position: relative;
            width: 250px;
            height: 180px;
            margin: 2rem auto;
        }
        
        .jenny-wheel {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 80px;
            border: 6px solid #696969;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        
        .jenny-wheel::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 4px;
            background: #696969;
        }
        
        .jenny-spindles {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 150px;
            height: 140px;
            background: repeating-linear-gradient(
                0deg,
                #A9A9A9 0px,
                #A9A9A9 8px,
                transparent 8px,
                transparent 16px
            );
        }
        
        .jenny-threads {
            position: absolute;
            left: 20px;
            top: 50%;
            width: 180px;
            height: 2px;
            background: linear-gradient(90deg, #FFD700, transparent);
            animation: threadSpin 1s ease-in-out infinite;
        }
        
        /* Laboratory Animation */
        .lab-equipment {
            position: relative;
            width: 300px;
            height: 200px;
            margin: 2rem auto;
        }
        
        .beaker {
            position: absolute;
            left: 50px;
            bottom: 20px;
            width: 60px;
            height: 80px;
            background: linear-gradient(to top, #4169E1 0%, transparent 70%);
            border: 3px solid #87CEEB;
            border-radius: 0 0 30px 30px;
        }
        
        .beaker.bubbling::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: rgba(135, 206, 235, 0.6);
            border-radius: 50%;
            animation: bubble 1.5s ease-in-out infinite;
        }
        
        .test-tubes {
            position: absolute;
            right: 50px;
            bottom: 20px;
            width: 100px;
            height: 100px;
            background: repeating-linear-gradient(
                90deg,
                #87CEEB 0px,
                #87CEEB 15px,
                transparent 15px,
                transparent 25px
            );
        }
        
        .chemical-reaction {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 50px;
            background: radial-gradient(circle, #FFD700 0%, transparent 70%);
            animation: reaction 2s ease-in-out infinite;
        }
        
        /* Digital World Animation */
        .digital-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(138, 43, 226, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(138, 43, 226, 0.3) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 4s linear infinite;
        }
        
        .computer-screen {
            position: relative;
            width: 300px;
            height: 200px;
            background: #000;
            border: 4px solid #8A2BE2;
            border-radius: 10px;
            margin: 2rem auto;
            overflow: hidden;
        }
        
        .code-lines {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 100px;
            background: repeating-linear-gradient(
                0deg,
                #00FF00 0px,
                #00FF00 2px,
                transparent 2px,
                transparent 20px
            );
            animation: codeScroll 3s linear infinite;
        }
        
        .design-preview {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 60px;
            background: linear-gradient(45deg, #FF1493, #00BFFF, #FFD700);
            border-radius: 5px;
            animation: designUpdate 2s ease-in-out infinite;
        }
        
        /* Future Lab Animation */
        .holographic-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 100px;
            background: linear-gradient(45deg, transparent, #00FFFF, transparent);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            animation: hologram 3s ease-in-out infinite;
        }
        
        .smart-fabric {
            position: relative;
            width: 250px;
            height: 150px;
            margin: 2rem auto;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .led-fibers {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                45deg,
                #00FFFF 0px,
                #00FFFF 2px,
                transparent 2px,
                transparent 20px
            );
            animation: ledPulse 1.5s ease-in-out infinite;
        }
        
        .sensor-nodes {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 20px;
            height: 20px;
            background: #FF6B6B;
            border-radius: 50%;
            animation: sensorBlink 2s ease-in-out infinite;
        }
        
        .sensor-nodes::after {
            content: '';
            position: absolute;
            top: 100px;
            left: 180px;
            width: 20px;
            height: 20px;
            background: #4ECDC4;
            border-radius: 50%;
            animation: sensorBlink 2s ease-in-out infinite 0.5s;
        }
        
        /* Challenge Arena */
        .arena-lights {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 25% 25%, rgba(255, 215, 0, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 75% 75%, rgba(70, 130, 180, 0.3) 0%, transparent 50%);
            animation: arenaLights 3s ease-in-out infinite;
        }
        
        .knowledge-symbols {
            position: relative;
            width: 300px;
            height: 200px;
            margin: 2rem auto;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .symbol {
            font-size: 3rem;
            animation: symbolFloat 2s ease-in-out infinite;
        }
        
        .symbol:nth-child(1) { animation-delay: 0s; }
        .symbol:nth-child(2) { animation-delay: 0.5s; }
        .symbol:nth-child(3) { animation-delay: 1s; }
        .symbol:nth-child(4) { animation-delay: 1.5s; }
        
        /* Narrative Text */
        .narrative-text {
            position: relative;
            z-index: 10;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: narrativeSlideIn 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes narrativeSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .narrator-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4682b4;
            margin-bottom: 1rem;
            animation: titleGlow 3s ease-in-out infinite;
        }
        
        .narrator-voice {
            font-size: 1.3rem;
            line-height: 1.6;
            color: #ffffff;
            font-style: italic;
            animation: textFadeIn 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Video UI */
        .video-ui {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 2rem;
            z-index: 20;
        }
        
        .progress-container {
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4682b4, #00bfff);
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(70, 130, 180, 0.5);
        }
        
        .scene-indicators {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .scene-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .scene-dot.active {
            background: #4682b4;
            box-shadow: 0 0 10px #4682b4;
        }
        
        .video-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }
        
        .control-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: #ffffff;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 100;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            font-weight: 600;
        }
        
        .control-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.15));
            transform: translateY(-3px) scale(1.05);
            border-color: #00d4ff;
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }
        
        .control-btn:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        .video-timer {
            color: #4682b4;
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .timeline-video {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 0;
        }
        
        .timeline-video::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #4682b4, #00bfff);
            transform: translateX(-50%);
            animation: timelineGrow 8s ease-in-out;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            opacity: 0;
            animation: timelineItemAppear 1s ease-out forwards;
            position: relative;
        }
        
        .timeline-item:nth-child(1) { animation-delay: 0.5s; }
        .timeline-item:nth-child(2) { animation-delay: 1.5s; }
        .timeline-item:nth-child(3) { animation-delay: 2.5s; }
        .timeline-item:nth-child(4) { animation-delay: 3.5s; }
        .timeline-item:nth-child(5) { animation-delay: 4.5s; }
        .timeline-item:nth-child(6) { animation-delay: 5.5s; }
        
        .timeline-item:nth-child(odd) {
            flex-direction: row;
            text-align: left;
        }
        
        .timeline-item:nth-child(even) {
            flex-direction: row-reverse;
            text-align: right;
        }
        
        .timeline-item::before {
            content: attr(data-year);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: #4682b4;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            white-space: nowrap;
            z-index: 2;
        }
        
        .timeline-icon {
            font-size: 3rem;
            background: rgba(70, 130, 180, 0.3);
            border: 3px solid #4682b4;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2rem;
            animation: iconPulse 2s ease-in-out infinite;
            position: relative;
            z-index: 3;
        }
        
        .timeline-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid rgba(70, 130, 180, 0.3);
            max-width: 300px;
            backdrop-filter: blur(10px);
        }
        
        .timeline-content h4 {
            color: #4682b4;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        
        .timeline-content p {
            color: #a0a0a0;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .video-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 2rem 0;
            overflow: hidden;
        }
        
        .video-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4682b4, #00bfff);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(70, 130, 180, 0.5);
        }
        
        .video-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }
        
        .video-timer {
            color: #4682b4;
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        /* Narrative Video Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes weave {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(5px); }
        }
        
        @keyframes weaving {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }
        
        @keyframes threadSpin {
            0% { width: 180px; opacity: 1; }
            50% { width: 200px; opacity: 0.7; }
            100% { width: 180px; opacity: 1; }
        }
        
        @keyframes bubble {
            0% { transform: translateX(-50%) translateY(0px); opacity: 0; }
            50% { transform: translateX(-50%) translateY(-20px); opacity: 1; }
            100% { transform: translateX(-50%) translateY(-40px); opacity: 0; }
        }
        
        @keyframes reaction {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 0.7; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 1; }
        }
        
        @keyframes gridMove {
            from { transform: translate(0, 0); }
            to { transform: translate(50px, 50px); }
        }
        
        @keyframes codeScroll {
            from { transform: translateY(0px); }
            to { transform: translateY(-100px); }
        }
        
        @keyframes designUpdate {
            0%, 100% { transform: scale(1); filter: hue-rotate(0deg); }
            50% { transform: scale(1.1); filter: hue-rotate(180deg); }
        }
        
        @keyframes hologram {
            0%, 100% { 
                transform: translateX(-50%) translateY(0px);
                opacity: 0.7;
                filter: blur(0px);
            }
            50% { 
                transform: translateX(-50%) translateY(-10px);
                opacity: 1;
                filter: blur(1px);
            }
        }
        
        @keyframes ledPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        @keyframes sensorBlink {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 currentColor;
            }
            50% { 
                transform: scale(1.2);
                box-shadow: 0 0 0 10px transparent;
            }
        }
        
        @keyframes arenaLights {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        @keyframes symbolFloat {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
                text-shadow: 0 0 10px currentColor;
            }
            50% { 
                transform: translateY(-15px) rotate(180deg);
                text-shadow: 0 0 20px currentColor;
            }
        }
        
        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 10px #4682b4; }
            50% { text-shadow: 0 0 20px #4682b4, 0 0 30px #00bfff; }
        }
        
        @keyframes textFadeIn {
            0% { 
                opacity: 0; 
                transform: translateY(30px);
                filter: blur(5px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0);
                filter: blur(0);
            }
        }
        
        /* Slower animation speeds for better viewing */
        .narrator-voice {
            animation: textFadeIn 3s ease-in-out;
        }
        
        .floating-particles::before,
        .floating-particles::after {
            animation: float 4s ease-in-out infinite;
        }
        
        .weaver-hands {
            animation: weaving 2.5s ease-in-out infinite;
        }
        
        .jenny-wheel {
            animation: spin 3s linear infinite;
        }
        
        .beaker.bubbling::before {
            animation: bubble 2.5s ease-in-out infinite;
        }
        
        .digital-grid {
            animation: gridMove 6s linear infinite;
        }
        
        .code-lines {
            animation: codeScroll 4s linear infinite;
        }
        
        .holographic-display {
            animation: hologram 4s ease-in-out infinite;
        }
        
        .symbol {
            animation: symbolFloat 3s ease-in-out infinite;
        }
        
        /* Mobile Responsive for Timeline */
        @media (max-width: 768px) {
            .timeline-video::before {
                left: 30px;
            }
            
            .timeline-item {
                flex-direction: row !important;
                text-align: left !important;
                padding-left: 80px;
            }
            
            .timeline-item::before {
                left: 30px;
                transform: translateX(-50%);
            }
            
            .timeline-icon {
                position: absolute;
                left: 0;
                margin: 0;
            }
            
            .timeline-content {
                max-width: none;
                margin-left: 1rem;
            }
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .main-title {
                font-size: 2rem;
            }
            
            .grid-container {
                flex-direction: column;
            }
            
            .grid-cell {
                width: 50px;
                height: 50px;
            }
            
            .challenge-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Registration Screen -->
    <div id="registration" class="screen active">
        <div class="registration-form">
            <h1 class="main-title">CHRONOWEAVE</h1>
            <p class="subtitle">Competitive Textile History Challenge</p>
            
            <!-- Login/Register Toggle -->
            <div style="display: flex; gap: 1.5rem; margin-bottom: 2rem; justify-content: center;">
                <button class="game-btn" id="show-register" onclick="showRegisterForm()" style="background: linear-gradient(45deg, #00d4ff, #4ecdc4); flex: 1; max-width: 250px; padding: 1rem 2rem; font-size: 1.1rem;">Register</button>
                <button class="game-btn" id="show-login" onclick="showLoginForm()" style="background: rgba(255,255,255,0.1); flex: 1; max-width: 250px; padding: 1rem 2rem; font-size: 1.1rem;">Login</button>
            </div>
            
            <!-- Register Form -->
            <div id="register-form" style="display: block;">
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #00d4ff; margin-bottom: 0.5rem; font-size: 1.8rem;">Create Account</h3>
                    <p style="color: #a0a0a0; font-size: 1rem;">Join the chronoweaving adventure</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1.2rem; margin-bottom: 2rem;">
                    <input type="email" id="register-email" placeholder=" Enter your email" required>
                    <input type="text" id="register-name" placeholder=" Enter your weaver name" maxlength="20" required>
                    <input type="password" id="register-password" placeholder=" Create password (6+ characters)" minlength="6" required>
                    
                    <select id="register-difficulty">
                        <option value="apprentice"> Apprentice (Easy)</option>
                        <option value="artisan"> Artisan (Medium)</option>
                        <option value="master"> Master Weaver (Hard)</option>
                    </select>
                </div>
                
                <button class="enter-btn" onclick="registerNewPlayer()" style="margin-top: 1rem; padding: 1.2rem; font-size: 1.1rem;"> Create Account</button>
                
                <p style="color: #a0a0a0; font-size: 0.95rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    Already have an account? <a href="#" onclick="showLoginForm(); return false;" style="color: #00d4ff; text-decoration: none; font-weight: 600;">Login here </a>
                </p>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" style="display: none;">
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #00d4ff; margin-bottom: 0.5rem; font-size: 1.8rem;">Welcome Back</h3>
                    <p style="color: #a0a0a0; font-size: 1rem;">Continue your chronoweaving journey</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1.2rem; margin-bottom: 2rem;">
                    <input type="email" id="login-email" placeholder=" Enter your email" required>
                    <input type="password" id="login-password" placeholder=" Enter password" required>
                </div>
                
                <button class="enter-btn" onclick="loginPlayer()" style="margin-top: 1rem; padding: 1.2rem; font-size: 1.1rem;"> Login</button>
                
                <p style="color: #a0a0a0; font-size: 0.95rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    New to Chronoweave? <a href="#" onclick="showRegisterForm(); return false;" style="color: #00d4ff; text-decoration: none; font-weight: 600;">Register here </a>
                </p>
            </div>
            
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                <p style="color: #a0a0a0; font-size: 0.95rem;">
                     LIVE: <span id="live-players">247</span> players online |  Next competition: <span id="competition-timer">5:23:45</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard" class="screen">
        <div class="container">
            <div class="dashboard">
                <h2 class="welcome-message" id="welcome-text">Welcome, Weaver!</h2>
                
                <div style="text-align: center; margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <p style="color: #a0a0a0; font-size: 0.9rem;">
                         <span id="player-email">player@email.com</span> | 
                         Last played: <span id="last-played">Just now</span>
                    </p>
                </div>
                
                <div class="player-stats">
                    <div class="stat" onclick="openLeaderboard()" style="cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <span class="stat-number" id="player-rank">#156</span>
                        <span>Global Rank </span>
                        <div style="font-size: 0.7rem; color: #00d4ff; margin-top: 0.3rem;">Click to view</div>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="total-score">0</span>
                        <span>Total Score</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number" style="color: #ffd700;" id="player-coins">0 </span>
                        <span>Coins</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="player-level">Apprentice</span>
                        <span>Level</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="challenges-completed">0/3</span>
                        <span>Challenges</span>
                    </div>
                </div>
                
                <!-- Streak System -->
                <div style="background: linear-gradient(135deg, rgba(255,100,50,0.2), rgba(255,150,0,0.2)); padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border: 2px solid rgba(255,150,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="color: #ff9500; margin-bottom: 1rem;"> Daily Streak</h3>
                            <div style="display: flex; gap: 2rem; align-items: center;">
                                <div>
                                    <div style="font-size: 3rem; font-weight: 700; color: #ff9500;" id="current-streak">0</div>
                                    <div style="color: #a0a0a0;">Current Streak</div>
                                </div>
                                <div>
                                    <div style="font-size: 2rem; font-weight: 700; color: #ffd700;" id="longest-streak">0</div>
                                    <div style="color: #a0a0a0;">Longest Streak</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 10px;">
                                <div style="color: #a0a0a0; margin-bottom: 0.5rem;">Today's Progress:</div>
                                <div style="display: flex; gap: 1rem; justify-content: center;">
                                    <div id="streak-heritage" style="font-size: 2rem; opacity: 0.3;"></div>
                                    <div id="streak-innovation" style="font-size: 2rem; opacity: 0.3;"></div>
                                    <div id="streak-future" style="font-size: 2rem; opacity: 0.3;"></div>
                                </div>
                                <div style="color: #a0a0a0; font-size: 0.9rem; margin-top: 0.5rem;">Complete all 3 challenges today to maintain your streak!</div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: rgba(255,215,0,0.2); padding: 1.5rem; border-radius: 15px; border: 2px solid rgba(255,215,0,0.3);">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                                <div style="font-weight: 700; color: #ffd700; margin-bottom: 0.5rem;">Streak Saves: <span id="streak-saves">0</span></div>
                                <div style="color: #a0a0a0; font-size: 0.85rem; margin-bottom: 1rem;">Protect your streak if you miss a day!</div>
                                <button onclick="buyStreakSave()" class="game-btn" style="background: linear-gradient(45deg, #ffd700, #ff9500); color: #000; font-size: 0.9rem;">
                                    Buy Streak Save<br><span style="font-size: 0.8rem;">500 </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="challenge-grid">
                    <div class="challenge-card" data-challenge="heritage" style="position: relative; z-index: 10;">
                        <div class="challenge-icon"></div>
                        <h3>Heritage Challenge</h3>
                        <p>Master ancient weaving patterns from Mesopotamia, Celtic, and Aztec civilizations</p>
                        <div style="margin-top: 1rem; color: #ffd700;">
                            Best Score: <span id="heritage-best">0</span> pts
                        </div>
                    </div>
                    
                    <div class="challenge-card" data-challenge="innovation" style="position: relative; z-index: 10;">
                        <div class="challenge-icon"></div>
                        <h3>Innovation Quiz</h3>
                        <p>Test your knowledge of textile technology and industrial history</p>
                        <div style="margin-top: 1rem; color: #4682b4;">
                            Best Score: <span id="innovation-best">0</span> pts
                        </div>
                    </div>
                    
                    <div class="challenge-card" data-challenge="future" style="position: relative; z-index: 10;">
                        <div class="challenge-icon"></div>
                        <h3>Smart Textile Engineering</h3>
                        <p>Solve complex design problems by optimizing material properties, energy efficiency, and functionality</p>
                        <div style="margin-top: 1rem; color: #00ffff;">
                            Best Score: <span id="future-best">0</span> pts
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="openAvatarBuilder()" class="game-btn" style="background: rgba(255, 100, 255, 0.3); color: white;">
                         Avatar
                    </button>
                    <button onclick="openSettings()" class="game-btn" style="background: rgba(100, 100, 255, 0.3); color: white;">
                         Settings
                    </button>

                    <button onclick="saveProgress()" class="game-btn" style="background: rgba(76, 175, 80, 0.3); color: white;">
                         Save Progress
                    </button>
                    <button onclick="logoutPlayer()" class="game-btn" style="background: rgba(255,255,255,0.1); color: white;">
                         Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Builder Screen with 3D Character -->
    <div id="avatar-builder" class="screen">
        <div class="container">
            <div style="max-width: 1400px; margin: 0 auto;">
                <div class="challenge-header" style="margin-bottom: 2rem;">
                    <button class="back-btn" onclick="closeAvatarBuilder()"> Back to Dashboard</button>
                    <h2 style="color: #ff69b4;"> 3D Avatar Builder</h2>
                    <div style="color: #ffd700; font-size: 1.5rem;">
                         <span id="avatar-coins">0</span> Coins
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 600px; gap: 2rem;">
                    <!-- Controls Panel -->
                    <div id="avatar-shop-controls" style="background: rgba(255,255,255,0.05); border-radius: 20px; padding: 2rem; max-height: 80vh; overflow-y: auto;">
                        <!-- Skin Color (Always Free) -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #00d4ff; margin-bottom: 1rem;"> Skin Color</h3>
                            <div id="skin-colors-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;"></div>
                        </div>

                        <!-- Hair Style (Shop Items) -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #00d4ff; margin-bottom: 1rem;"> Hair Style</h3>
                            <div id="hair-styles-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;"></div>
                        </div>

                        <!-- Hair Color (Shop Items) -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #00d4ff; margin-bottom: 1rem;"> Hair Color</h3>
                            <div id="hair-colors-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;"></div>
                        </div>

                        <!-- Top Color (Shop Items) -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #00d4ff; margin-bottom: 1rem;"> Top Color</h3>
                            <div id="top-colors-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;"></div>
                        </div>

                        <!-- Bottom Color (Shop Items) -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #00d4ff; margin-bottom: 1rem;"> Bottom Color</h3>
                            <div id="bottom-colors-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;"></div>
                        </div>

                        <!-- Accessories (Shop Items) -->
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #00d4ff; margin-bottom: 1rem;"> Accessories</h3>
                            <div id="accessories-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;"></div>
                        </div>

                        <button class="game-btn" onclick="save3DAvatar()" style="width: 100%;"> Save Avatar</button>
                        <button class="game-btn" onclick="randomize3DAvatar()" style="width: 100%; background: rgba(255,255,255,0.1); color: white; margin-top: 1rem;"> Randomize</button>
                    </div>

                    <!-- 3D Preview Panel -->
                    <div style="background: rgba(255,255,255,0.05); border-radius: 20px; padding: 2rem; position: sticky; top: 2rem;">
                        <h3 style="color: #ff69b4; margin-bottom: 1rem; text-align: center;">3D Preview</h3>
                        <div id="avatar-3d-container" style="width: 100%; height: 500px; border-radius: 15px; overflow: hidden; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);"></div>
                        <p style="text-align: center; color: #a0a0a0; font-size: 0.9rem; margin-top: 1rem;"> Click and drag to rotate</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboard" class="screen">
        <div class="container">
            <div style="max-width: 900px; margin: 0 auto;">
                <div class="challenge-header" style="margin-bottom: 2rem;">
                    <button class="back-btn" onclick="closeLeaderboard()"> Back to Dashboard</button>
                    <h2 style="color: #ffd700;"> Weekly Leaderboard</h2>
                    <div style="text-align: right; color: #a0a0a0; font-size: 0.9rem;">
                        Resets every Monday
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,150,0,0.1)); padding: 2rem; border-radius: 20px; border: 2px solid rgba(255,215,0,0.3);">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 1.2rem; color: #a0a0a0; margin-bottom: 0.5rem;">Your Weekly Rank</div>
                        <div style="font-size: 3rem; font-weight: 700; color: #ffd700;" id="leaderboard-your-rank">#-</div>
                        <div style="color: #a0a0a0; margin-top: 0.5rem;">
                            <span id="leaderboard-your-score">0</span> points this week
                        </div>
                    </div>
                    
                    <div id="leaderboard-list" style="background: rgba(0,0,0,0.3); border-radius: 15px; padding: 1rem;">
                        <div style="text-align: center; color: #a0a0a0; padding: 2rem;">
                            Loading leaderboard...
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1.5rem; color: #a0a0a0; font-size: 0.9rem;">
                        Showing 5 players above and 5 players below your rank
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings" class="screen">
        <div class="container">
            <div style="max-width: 800px; margin: 0 auto;">
                <div class="challenge-header" style="margin-bottom: 2rem;">
                    <button class="back-btn" onclick="closeSettings()"> Back to Dashboard</button>
                    <h2 style="color: #00d4ff;"> Settings</h2>
                    <div></div>
                </div>
                
                <!-- Account Settings -->
                <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h3 style="color: #00d4ff; margin-bottom: 1.5rem;"> Account Settings</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #a0a0a0; margin-bottom: 0.5rem;">Email Address</label>
                        <input type="email" id="settings-email" readonly style="background: rgba(0,0,0,0.3); cursor: not-allowed;">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #a0a0a0; margin-bottom: 0.5rem;">Player Name</label>
                        <input type="text" id="settings-name" maxlength="20">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #a0a0a0; margin-bottom: 0.5rem;">Difficulty Level</label>
                        <select id="settings-level">
                            <option value="apprentice">Apprentice (Easy)</option>
                            <option value="artisan">Artisan (Medium)</option>
                            <option value="master">Master Weaver (Hard)</option>
                        </select>
                    </div>
                    
                    <button class="game-btn" onclick="updateAccountSettings()">
                         Save Account Changes
                    </button>
                </div>
                
                <!-- Game Settings -->
                <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h3 style="color: #00d4ff; margin-bottom: 1.5rem;"> Game Settings</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                            <input type="checkbox" id="settings-sound" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span> Sound Effects</span>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                            <input type="checkbox" id="settings-music" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span> Background Music</span>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #a0a0a0; margin-bottom: 0.5rem;"> Music Theme</label>
                        <select id="settings-music-theme" style="width: 100%;">
                            <option value="ambient"> Chill Lofi (Default)</option>
                            <option value="upbeat"> Future Bass</option>
                            <option value="speedrun"> Hyperpop Rush - Ultra Fast!</option>
                            <option value="mysterious"> Synthwave Night</option>
                            <option value="epic"> Cinematic Trap</option>
                            <option value="minimal"> Deep House</option>
                        </select>
                        <p style="color: #a0a0a0; font-size: 0.85rem; margin-top: 0.5rem;">
                             Modern electronic music for every mood!
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                            <input type="checkbox" id="settings-autosave" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span> Auto-Save Progress</span>
                        </label>
                    </div>
                    
                    <button class="game-btn" onclick="updateGameSettings()">
                         Save Game Settings
                    </button>
                </div>
                
                <!-- Password Change -->
                <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h3 style="color: #00d4ff; margin-bottom: 1.5rem;"> Change Password</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #a0a0a0; margin-bottom: 0.5rem;">Current Password</label>
                        <input type="password" id="settings-current-password" placeholder="Enter current password">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #a0a0a0; margin-bottom: 0.5rem;">New Password</label>
                        <input type="password" id="settings-new-password" placeholder="Enter new password" minlength="6" oninput="validatePasswordFields()">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #a0a0a0; margin-bottom: 0.5rem;">Confirm New Password</label>
                        <input type="password" id="settings-confirm-password" placeholder="Confirm new password" minlength="6" oninput="validatePasswordFields()">
                        <div id="password-match-indicator" style="margin-top: 0.5rem; font-size: 0.8rem;"></div>
                    </div>
                    
                    <button class="game-btn" onclick="changePassword()" id="change-password-btn">
                         Change Password
                    </button>
                    
                    <div style="margin-top: 1rem; color: #a0a0a0; font-size: 0.9rem;">
                        <p> <strong>Note:</strong> Your password must be at least 6 characters long.</p>
                        <p> For security, make sure to use a strong password with letters, numbers, and symbols.</p>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h3 style="color: #00d4ff; margin-bottom: 1.5rem;"> Your Statistics</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 10px;">
                            <div style="color: #a0a0a0; font-size: 0.9rem;">Account Created</div>
                            <div style="color: #00d4ff; font-size: 1.2rem; font-weight: 700;" id="stats-created">-</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 10px;">
                            <div style="color: #a0a0a0; font-size: 0.9rem;">Total Playtime</div>
                            <div style="color: #00d4ff; font-size: 1.2rem; font-weight: 700;" id="stats-playtime">-</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 10px;">
                            <div style="color: #a0a0a0; font-size: 0.9rem;">Challenges Completed</div>
                            <div style="color: #00d4ff; font-size: 1.2rem; font-weight: 700;" id="stats-completed">0/3</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 10px;">
                            <div style="color: #a0a0a0; font-size: 0.9rem;">Highest Score</div>
                            <div style="color: #00d4ff; font-size: 1.2rem; font-weight: 700;" id="stats-highest">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Danger Zone -->
                <div style="background: rgba(255,0,0,0.1); border: 2px solid rgba(255,0,0,0.3); padding: 2rem; border-radius: 15px;">
                    <h3 style="color: #ff6b6b; margin-bottom: 1.5rem;"> Danger Zone</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <button class="game-btn" onclick="resetProgress()" style="background: rgba(255,165,0,0.3); color: white;">
                             Reset All Progress
                        </button>
                        <p style="color: #a0a0a0; font-size: 0.85rem; margin-top: 0.5rem;">
                            This will reset all your scores and challenge progress, but keep your account.
                        </p>
                    </div>
                    
                    <div>
                        <button class="game-btn" onclick="deleteAccount()" style="background: rgba(255,0,0,0.3); color: white;">
                             Delete Account
                        </button>
                        <p style="color: #a0a0a0; font-size: 0.85rem; margin-top: 0.5rem;">
                            This will permanently delete your account and all data. This cannot be undone!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Heritage Challenge Screen - SPEED RUN QUIZ -->
    <div id="heritage-challenge" class="screen heritage-theme">
        <div class="container">
            <div class="challenge-header">
                <button class="back-btn" onclick="returnToDashboard()"> Back to Dashboard</button>
                <div>
                    <h2 style="color: #ffd700;"> Pattern Speed Run</h2>
                    <p style="color: #a0a0a0;">Complete as many patterns as possible!</p>
                </div>
                <div class="challenge-timer" id="heritage-timer" style="font-size: 3rem; color: #ff6b6b;">01:00</div>
            </div>
            
            <!-- Heritage Video Introduction -->
            <div id="heritage-video" class="heritage-video-intro">
                <div class="video-container">
                    <h3 style="color: #ffd700; margin-bottom: 2rem; text-align: center;">The Art of Ancient Weaving</h3>
                    
                    <div class="heritage-story">
                        <div class="story-scene active" id="heritage-scene-1">
                            <div class="ancient-weaver">
                                <div class="weaver-silhouette"></div>
                                <div class="loom-animation">
                                    <div class="loom-threads-vertical"></div>
                                    <div class="shuttle"></div>
                                </div>
                            </div>
                            <div class="story-text">
                                <h4>Heritage Challenge</h4>
                                <p>Welcome to the Heritage Challenge! Ancient weavers created sacred patterns that told stories and preserved history. Now it's your turn to master their craft!</p>
                            </div>
                        </div>
                        
                        <div class="story-scene" id="heritage-scene-2">
                            <div class="challenge-preview">
                                <div class="preview-grid">
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                    <div class="preview-cell"></div>
                                </div>
                            </div>
                            <div class="story-text">
                                <h4>How to Play</h4>
                                <p>Study the TARGET pattern on the left. Click cells in YOUR grid on the right to match it exactly. The more accurate you are, the more points you earn!</p>
                            </div>
                        </div>
                        
                        <div class="story-scene" id="heritage-scene-3">
                            <div class="pattern-showcase">
                                <div class="pattern-example">  </div>
                                <div class="pattern-example">  </div>
                                <div class="pattern-example">  </div>
                            </div>
                            <div class="story-text">
                                <h4>Ready for the Speed Run?</h4>
                                <p>You have 60 seconds to complete as many patterns as possible! Match each pattern with 70%+ accuracy to move to the next one. Go fast!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="video-progress-bar">
                        <div class="video-progress-fill" id="heritage-video-progress"></div>
                    </div>
                    
                    <div class="video-controls">
                        <button class="control-btn" onclick="previousHeritageScene()"> Back</button>
                        <button class="control-btn" onclick="pauseHeritageVideo()" id="heritage-pause-btn"> Pause</button>
                        <button class="control-btn" onclick="nextHeritageScene()"> Forward</button>
                        <div class="video-timer">
                            <span id="heritage-video-timer">0:20</span>
                        </div>
                        <button class="control-btn" onclick="startHeritageChallenge()" style="background: linear-gradient(45deg, #00d4ff, #4ecdc4); color: #000; font-weight: 700;"> Start Challenge</button>
                    </div>
                </div>
            </div>
            
            <!-- Pattern Speed Run Game -->
            <div id="heritage-game" style="display: none;">
                <!-- Speed Run Stats Bar -->
                <div style="background: rgba(255,215,0,0.1); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: #ffd700;" id="patterns-completed">0</div>
                        <div style="color: #a0a0a0; font-size: 0.9rem;">Patterns Completed</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: #4ecdc4;" id="total-speedrun-score">0</div>
                        <div style="color: #a0a0a0; font-size: 0.9rem;">Total Score</div>
                    </div>
                </div>

                <!-- Pattern Info -->
                <div class="pattern-info">
                    <h3 id="pattern-name">Pattern Name</h3>
                    <p><strong>Points:</strong> <span id="pattern-points">100</span> | <strong>Progress:</strong> <span id="pattern-progress">0/4</span></p>
                    <p><strong>Difficulty:</strong> </p>
                </div>
                
                <!-- Pattern Grids -->
                <div class="grid-container">
                    <div class="grid-section">
                        <h4>Target Pattern</h4>
                        <div id="target-grid" class="grid-game">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="grid-section">
                        <h4>Your Pattern</h4>
                        <div id="player-grid" class="grid-game">
                            <!-- Generated by JavaScript -->
                        </div>
                        <p style="color: #a0a0a0; font-size: 0.9rem; margin-top: 1rem;">Click cells to match the target pattern</p>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="text-align: center; margin-top: 2rem; display: flex; gap: 0.5rem; justify-content: center;">
                    <button class="game-btn" onclick="checkHeritagePattern()"> Submit Pattern</button>
                    <button class="game-btn" onclick="resetHeritagePattern()" style="background: rgba(255,107,107,0.3);"> Reset</button>
                </div>
                
                <!-- Speed Run Tip -->
                <div style="text-align: center; margin-top: 2rem; color: #ffd700;">
                    <p> Complete as many patterns as possible before time runs out!</p>
                    <p style="color: #a0a0a0; font-size: 0.9rem;">Need 70%+ accuracy to move to next pattern</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Innovation Challenge Screen -->
    <div id="innovation-challenge" class="screen innovation-theme">
        <div class="container">
            <div class="challenge-header">
                <button class="back-btn" onclick="returnToDashboard()"> Back to Dashboard</button>
                <div>
                    <h2 style="color: #4682b4;">Innovation Quiz: Textile Technology</h2>
                    <p style="color: #a0a0a0;">Test your knowledge of textile history and innovation</p>
                </div>
                <div class="challenge-timer" id="innovation-timer">05:00</div>
            </div>
            
            <!-- Animated Narrative Video -->
            <div id="innovation-video" class="narrative-video">
                <div class="video-screen">
                    <!-- APPRENTICE LEVEL SCENES (Basic Knowledge) -->
                    <div class="video-scene active apprentice-scene" id="scene-1">
                        <div class="scene-background ancient-world">
                            <div class="floating-particles"></div>
                            <div class="ancient-loom">
                                <div class="loom-frame"></div>
                                <div class="loom-threads"></div>
                                <div class="weaver-hands"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title"> Apprentice Tutorial: The Basics</h2>
                            <p class="narrator-voice">"Welcome! Let's learn textile basics. The LOOM is the basic tool for weaving - it holds threads in place while you create fabric."</p>
                        </div>
                    </div>

                    <div class="video-scene apprentice-scene" id="scene-2">
                        <div class="scene-background ancient-world">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Natural Fibers</h2>
                            <p class="narrator-voice">"Remember: WOOL comes from sheep , COTTON from plants , and SILK from silkworms . These are the three main natural fibers!"</p>
                        </div>
                    </div>

                    <div class="video-scene apprentice-scene" id="scene-3">
                        <div class="scene-background laboratory">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Royal Purple</h2>
                            <p class="narrator-voice">"PURPLE dye was the most expensive color in ancient times - it came from rare sea snails and was worth more than gold! Only royalty could afford it."</p>
                        </div>
                    </div>

                    <!-- ARTISAN LEVEL SCENES (Intermediate Knowledge) -->
                    <div class="video-scene artisan-scene" id="scene-4">
                        <div class="scene-background industrial-era">
                            <div class="spinning-jenny">
                                <div class="jenny-wheel"></div>
                                <div class="jenny-spindles"></div>
                                <div class="jenny-threads"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title"> Artisan Tutorial: Industrial Revolution</h2>
                            <p class="narrator-voice">"The SPINNING JENNY (1764) revolutionized textiles! One worker could spin 8 threads at once. This machine sparked the Industrial Revolution."</p>
                        </div>
                    </div>

                    <div class="video-scene artisan-scene" id="scene-5">
                        <div class="scene-background laboratory">
                            <div class="lab-equipment">
                                <div class="beaker bubbling"></div>
                                <div class="test-tubes"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">First Synthetic Fiber</h2>
                            <p class="narrator-voice">"NYLON (1935) was the first fully synthetic fiber! Created in a lab, it was stronger than silk and revolutionized stockings, parachutes, and clothing."</p>
                        </div>
                    </div>

                    <div class="video-scene artisan-scene" id="scene-6">
                        <div class="scene-background ancient-world">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">The Silk Road</h2>
                            <p class="narrator-voice">"The SILK ROAD was an ancient trade route connecting Asia to Europe. SILK was the primary luxury textile traded - China kept silk-making secret for centuries!"</p>
                        </div>
                    </div>

                    <div class="video-scene artisan-scene" id="scene-7">
                        <div class="scene-background digital-world">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Fiber to Yarn</h2>
                            <p class="narrator-voice">"SPINNING is the process that turns loose fiber into yarn! The spinning wheel twists fibers together to create strong thread for weaving."</p>
                        </div>
                    </div>

                    <!-- MASTER LEVEL SCENES (Advanced Knowledge) -->
                    <div class="video-scene master-scene" id="scene-8">
                        <div class="scene-background future-lab">
                            <div class="smart-fabric">
                                <div class="led-fibers"></div>
                                <div class="sensor-nodes"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title"> Master Tutorial: Advanced Science</h2>
                            <p class="narrator-voice">"Thermochromic materials change color with temperature through POLYMER CHAIN REORGANIZATION - molecular structures shift, altering light absorption!"</p>
                        </div>
                    </div>

                    <div class="video-scene master-scene" id="scene-9">
                        <div class="scene-background industrial-era">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Weave Structures</h2>
                            <p class="narrator-voice">"RIPSTOP WEAVE creates the strongest fabric! It uses reinforcement threads in a crosshatch pattern - if torn, the damage stops at reinforcement lines."</p>
                        </div>
                    </div>

                    <div class="video-scene master-scene" id="scene-10">
                        <div class="scene-background future-lab">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Carbon Nanotubes</h2>
                            <p class="narrator-voice">"CARBON NANOTUBES in smart textiles provide ELECTRICAL CONDUCTIVITY! These microscopic tubes conduct electricity while remaining flexible and lightweight."</p>
                        </div>
                    </div>

                    <div class="video-scene master-scene" id="scene-11">
                        <div class="scene-background ancient-world">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Silk Origins</h2>
                            <p class="narrator-voice">"CHINA first developed silk production around 3000 BCE! They guarded the secret for millennia - revealing silk-making techniques was punishable by death."</p>
                        </div>
                    </div>

                    <div class="video-scene master-scene" id="scene-12">
                        <div class="scene-background laboratory">
                            <div class="knowledge-symbols">
                                <div class="symbol"></div>
                                <div class="symbol"></div>
                                <div class="symbol">5</div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Spider Silk Strength</h2>
                            <p class="narrator-voice">"SPIDER SILK is 5X STRONGER than steel by weight! Its incredible tensile strength comes from protein chains that can stretch and absorb massive energy."</p>
                        </div>
                    </div>

                    <!-- Final Scene - All Levels -->
                    <div class="video-scene" id="scene-final">
                        <div class="scene-background challenge-arena">
                            <div class="arena-lights"></div>
                            <div class="knowledge-symbols">
                                <div class="symbol spinning"></div>
                                <div class="symbol spinning"></div>
                                <div class="symbol spinning"></div>
                            </div>
                        </div>
                        <div class="narrative-text">
                            <h2 class="narrator-title">Ready for the Quiz?</h2>
                            <p class="narrator-voice">"You've learned the key facts! Now test your knowledge. Remember what you learned and you'll ace this quiz. Good luck, Weaver!"</p>
                        </div>
                    </div>

                </div>
                
                <!-- Video UI Controls at Bottom -->
                <div class="video-ui">
                    <div class="video-progress-bar">
                        <div class="video-progress-fill" id="narrative-progress"></div>
                    </div>
                    
                    <div class="video-controls">
                        <button class="control-btn" onclick="previousInnovationScene()"> Back</button>
                        <button class="control-btn" onclick="pauseVideo()" id="pause-btn"> Pause</button>
                        <button class="control-btn" onclick="nextInnovationScene()"> Forward</button>
                        <div class="video-timer">
                            <span id="narrative-timer">0:30</span>
                        </div>
                        <button class="control-btn" onclick="startQuizAfterVideo()" style="background: linear-gradient(45deg, #4682b4, #5a9bd4); color: #fff; font-weight: 700;"> Start Quiz</button>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Container -->
            <div id="quiz-container-main" class="quiz-container" style="display: none;">
                <div class="quiz-stats">
                    <span>Question: <span id="current-question">1</span>/<span id="total-questions">5</span></span>
                    <span>Score: <span id="quiz-score">0</span></span>
                    <span>Streak: <span id="quiz-streak">0</span></span>
                </div>
                
                <div class="question-display" id="question-text">
                    Loading question...
                </div>
                
                <div class="quiz-options" id="quiz-options">
                    <!-- Quiz options will be generated here by JavaScript -->
                </div>
            </div>""
        </div>
    </div>

    <!-- Future Challenge Screen -->
    <div id="future-challenge" class="screen future-theme">
        <div class="container">
            <div class="challenge-header">
                <button class="back-btn" onclick="returnToDashboard()"> Back to Dashboard</button>
                <div>
                    <h2 style="color: #00ffff;">Smart Textile Engineering Challenge</h2>
                    <p style="color: #a0a0a0;">Optimize material properties to meet design specifications</p>
                </div>
                <div class="challenge-timer" id="future-timer">10:00</div>
            </div>
            
            <!-- Engineering Video Introduction -->
            <div id="engineering-video" class="engineering-video-intro">
                <div class="video-container">
                    <h3 style="color: #00ffff; margin-bottom: 2rem; text-align: center;">The Future of Smart Textiles</h3>
                    
                    <div class="engineering-story">
                        <div class="eng-scene active" id="eng-scene-1">
                            <div class="smart-fabric-demo">
                                <div class="fabric-layer">
                                    <div class="nano-particles"></div>
                                    <div class="conductive-threads"></div>
                                </div>
                            </div>
                            <div class="story-text">
                                <h4>Smart Textile Engineering</h4>
                                <p>Welcome to the future! Modern smart textiles integrate nanotechnology, conductive fibers, and responsive materials. You're the engineer - design the perfect fabric!</p>
                            </div>
                        </div>
                        
                        <div class="eng-scene" id="eng-scene-2">
                            <div class="challenge-preview-eng">
                                <div class="material-icons">
                                    <div class="mat-icon"> Carbon</div>
                                    <div class="mat-icon"> Silver</div>
                                    <div class="mat-icon"> Polymer</div>
                                    <div class="mat-icon"> Cotton</div>
                                </div>
                            </div>
                            <div class="story-text">
                                <h4>How to Play</h4>
                                <p>Use the sliders to mix 4 materials. Your composition must total 100%. Balance conductivity, weight, durability, and cost to meet all requirements!</p>
                            </div>
                        </div>
                        
                        <div class="eng-scene" id="eng-scene-3">
                            <div class="engineering-diagram">
                                <div class="property-bar">
                                    <span> Conductivity</span>
                                    <div class="bar"><div class="fill" style="width: 80%;"></div></div>
                                </div>
                                <div class="property-bar">
                                    <span> Weight</span>
                                    <div class="bar"><div class="fill" style="width: 60%;"></div></div>
                                </div>
                                <div class="property-bar">
                                    <span> Durability</span>
                                    <div class="bar"><div class="fill" style="width: 90%;"></div></div>
                                </div>
                            </div>
                            <div class="story-text">
                                <h4>Engineer the Future!</h4>
                                <p>Watch the performance bars update in real-time. Meet all targets to earn maximum points. The perfect fabric awaits your genius!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="video-progress-bar">
                        <div class="video-progress-fill" id="engineering-video-progress"></div>
                    </div>
                    
                    <div class="video-progress-bar">
                        <div class="video-progress-fill" id="engineering-video-progress"></div>
                    </div>
                    
                    <div class="video-controls">
                        <button class="control-btn" onclick="previousEngineeringScene()"> Back</button>
                        <button class="control-btn" onclick="pauseEngineeringVideo()" id="engineering-pause-btn"> Pause</button>
                        <button class="control-btn" onclick="nextEngineeringScene()"> Forward</button>
                        <div class="video-timer">
                            <span id="engineering-video-timer">0:20</span>
                        </div>
                        <button class="control-btn" onclick="startEngineeringChallenge()" style="background: linear-gradient(45deg, #00ffff, #4ecdc4); color: #000; font-weight: 700;"> Start Challenge</button>
                    </div>
                </div>
            </div>
            
            <!-- Engineering Challenge Game -->
            <div id="engineering-game" class="engineering-challenge" style="display: none;">
                <!-- Mission Brief -->
                <div class="mission-brief">
                    <h3> Engineering Mission</h3>
                    <div id="mission-description" class="mission-text">
                        Design a smart athletic wear fabric that must meet specific performance requirements.
                    </div>
                    <div class="requirements-grid">
                        <div class="requirement-item">
                            <span class="req-label">Target Conductivity:</span>
                            <span class="req-value" id="target-conductivity"> 75%</span>
                        </div>
                        <div class="requirement-item">
                            <span class="req-label">Max Weight:</span>
                            <span class="req-value" id="target-weight"> 200g/m</span>
                        </div>
                        <div class="requirement-item">
                            <span class="req-label">Min Durability:</span>
                            <span class="req-value" id="target-durability"> 80%</span>
                        </div>
                        <div class="requirement-item">
                            <span class="req-label">Budget:</span>
                            <span class="req-value" id="budget-limit"> $50/m</span>
                        </div>
                    </div>
                </div>

                <!-- Material Selection -->
                <div class="material-selection">
                    <h3> Material Composition</h3>
                    <p style="color: #a0a0a0; margin-bottom: 1rem;">Select and balance materials to meet requirements</p>
                    
                    <div class="materials-grid">
                        <div class="material-card" data-material="carbon">
                            <div class="material-header">
                                <span class="material-icon"></span>
                                <span class="material-name">Carbon Nanotubes</span>
                            </div>
                            <div class="material-stats">
                                <div>Conductivity: 95%</div>
                                <div>Weight: 50g/m</div>
                                <div>Durability: 90%</div>
                                <div>Cost: $30/m</div>
                            </div>
                            <div class="material-slider">
                                <input type="range" min="0" max="100" value="0" class="slider" id="carbon-slider" oninput="updateComposition()">
                                <span class="slider-value" id="carbon-value">0%</span>
                            </div>
                        </div>

                        <div class="material-card" data-material="silver">
                            <div class="material-header">
                                <span class="material-icon"></span>
                                <span class="material-name">Silver Fibers</span>
                            </div>
                            <div class="material-stats">
                                <div>Conductivity: 100%</div>
                                <div>Weight: 80g/m</div>
                                <div>Durability: 70%</div>
                                <div>Cost: $45/m</div>
                            </div>
                            <div class="material-slider">
                                <input type="range" min="0" max="100" value="0" class="slider" id="silver-slider" oninput="updateComposition()">
                                <span class="slider-value" id="silver-value">0%</span>
                            </div>
                        </div>

                        <div class="material-card" data-material="polymer">
                            <div class="material-header">
                                <span class="material-icon"></span>
                                <span class="material-name">Conductive Polymer</span>
                            </div>
                            <div class="material-stats">
                                <div>Conductivity: 60%</div>
                                <div>Weight: 40g/m</div>
                                <div>Durability: 95%</div>
                                <div>Cost: $15/m</div>
                            </div>
                            <div class="material-slider">
                                <input type="range" min="0" max="100" value="0" class="slider" id="polymer-slider" oninput="updateComposition()">
                                <span class="slider-value" id="polymer-value">0%</span>
                            </div>
                        </div>

                        <div class="material-card" data-material="cotton">
                            <div class="material-header">
                                <span class="material-icon"></span>
                                <span class="material-name">Organic Cotton</span>
                            </div>
                            <div class="material-stats">
                                <div>Conductivity: 0%</div>
                                <div>Weight: 120g/m</div>
                                <div>Durability: 85%</div>
                                <div>Cost: $5/m</div>
                            </div>
                            <div class="material-slider">
                                <input type="range" min="0" max="100" value="0" class="slider" id="cotton-slider" oninput="updateComposition()">
                                <span class="slider-value" id="cotton-value">0%</span>
                            </div>
                        </div>
                    </div>

                    <div class="composition-warning" id="composition-warning">
                         Total composition must equal 100%
                    </div>
                </div>

                <!-- Results Dashboard -->
                <div class="results-dashboard">
                    <h3> Performance Analysis</h3>
                    <div class="results-grid">
                        <div class="result-metric">
                            <div class="metric-label">Conductivity</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="result-conductivity" style="width: 0%; background: #00ffff;"></div>
                            </div>
                            <div class="metric-value" id="conductivity-text">0%</div>
                            <div class="metric-status" id="conductivity-status"></div>
                        </div>

                        <div class="result-metric">
                            <div class="metric-label">Weight</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="result-weight" style="width: 0%; background: #4ecdc4;"></div>
                            </div>
                            <div class="metric-value" id="weight-text">0 g/m</div>
                            <div class="metric-status" id="weight-status"></div>
                        </div>

                        <div class="result-metric">
                            <div class="metric-label">Durability</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="result-durability" style="width: 0%; background: #ffd700;"></div>
                            </div>
                            <div class="metric-value" id="durability-text">0%</div>
                            <div class="metric-status" id="durability-status"></div>
                        </div>

                        <div class="result-metric">
                            <div class="metric-label">Cost</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="result-cost" style="width: 0%; background: #ff6b6b;"></div>
                            </div>
                            <div class="metric-value" id="cost-text">$0/m</div>
                            <div class="metric-status" id="cost-status"></div>
                        </div>
                    </div>

                    <div class="overall-score">
                        <h4>Overall Score: <span id="engineering-score">0</span>/100</h4>
                        <div class="score-breakdown" id="score-breakdown"></div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="game-btn" onclick="submitEngineering()" id="submit-engineering" disabled>
                        Submit Design
                    </button>
                    <button class="game-btn" onclick="resetEngineering()" style="background: rgba(255,255,255,0.1); color: white;">
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Chronoweave loaded');
        
        // Global Variables
        let heritageVideoTimer = null;
        let heritageSceneIndex = 1;
        let heritageVideoPaused = false;
        
        // DOM Element Cache for Performance
        const domCache = {
            // Auth elements
            registerForm: null,
            loginForm: null,
            showRegister: null,
            showLogin: null,
            
            // Dashboard elements
            dashboard: null,
            registration: null,
            welcomeText: null,
            playerEmail: null,
            totalScore: null,
            playerLevel: null,
            lastPlayed: null,
            
            // Challenge stats
            heritageBest: null,
            innovationBest: null,
            futureBest: null,
            challengesCompleted: null,
            
            // Streak elements
            currentStreak: null,
            longestStreak: null,
            streakSaves: null,
            streakHeritage: null,
            streakInnovation: null,
            streakFuture: null,
            
            // Form inputs
            registerEmail: null,
            registerName: null,
            registerPassword: null,
            registerDifficulty: null,
            loginEmail: null,
            loginPassword: null,
            
            get: function(id) {
                if (!this[id]) {
                    this[id] = document.getElementById(id);
                }
                return this[id];
            }
        };
        
        // Heritage Challenge State
        let heritageSpeedRun = { patternsCompleted: 0, totalScore: 0, usedPatterns: [] };
        let currentPattern = null;
        let playerPattern = [];
        
        // Innovation Challenge Variables
        let narrativeTimer = null;
        let currentQuestionIndex = 0;
        let quizScore = 0;
        let quizStreak = 0;
        let currentScene = 1;
        let videoPaused = false;
        let currentQuestions = [];
        
        // Engineering Challenge Variables
        let engineeringVideoTimer = null;
        let engineeringComposition = { carbon: 0, silver: 0, polymer: 0, cotton: 0 };
        let engineeringResults = { conductivity: 0, weight: 0, durability: 0, cost: 0 };
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://zckwuqkmbmqkniltbvki.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpja3d1cWttYm1xa25pbHRidmtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMzY0MTksImV4cCI6MjA3ODkxMjQxOX0.fUUGaVoXYOBV3xjwcRrroHb4nhTPlgio71Ssg29YLqI';
        
        // Initialize Supabase
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        
        console.log(' Supabase initialized successfully!');
        
        // Heritage Challenge Pattern Data
        // Function to validate pattern uniqueness
        function validatePatternUniqueness() {
            Object.keys(heritagePatterns).forEach(level => {
                const patterns = heritagePatterns[level];
                const patternStrings = patterns.map(p => JSON.stringify(p.pattern.sort()));
                const uniquePatterns = [...new Set(patternStrings)];
                
                if (patternStrings.length !== uniquePatterns.length) {
                    console.warn(` Duplicate patterns found in ${level} level!`);
                    // Find and log duplicates
                    const duplicates = patternStrings.filter((item, index) => patternStrings.indexOf(item) !== index);
                    console.warn('Duplicate patterns:', duplicates);
                } else {
                    console.log(` All ${patterns.length} patterns in ${level} level are unique`);
                }
            });
        }
        
        const heritagePatterns = {
            apprentice: [
                { 
                    name: "Simple Cross", 
                    pattern: [1, 3, 4, 5, 7], 
                    points: 20, 
                    gridSize: 9,
                    history: "The cross pattern is one of humanity's oldest symbols, found in Neolithic textiles from 8000 BCE. Early weavers used this pattern to represent the four cardinal directions and the intersection of earth and sky.",
                    culture: "Universal",
                    period: "8000 BCE - Present"
                },
                { 
                    name: "Corner Dots", 
                    pattern: [0, 2, 6, 8], 
                    points: 15, 
                    gridSize: 9,
                    history: "Corner dot patterns originated in ancient Mesopotamian textiles around 3500 BCE. These dots represented stars and were believed to bring protection to the wearer during night travels.",
                    culture: "Mesopotamian",
                    period: "3500 BCE"
                },
                { 
                    name: "T-Shape", 
                    pattern: [0, 1, 2, 4, 7], 
                    points: 25, 
                    gridSize: 9,
                    history: "The T-pattern was sacred to ancient Egyptian weavers, symbolizing the Ankh (key of life). Found in tomb textiles from 2500 BCE, it was woven into burial shrouds to ensure safe passage to the afterlife.",
                    culture: "Ancient Egyptian",
                    period: "2500 BCE"
                },
                { 
                    name: "Diamond", 
                    pattern: [1, 4, 6, 7], 
                    points: 30, 
                    gridSize: 9,
                    history: "Diamond patterns appear in the earliest known woven textiles from atalhyk, Turkey (7000 BCE). They represented fertility and abundance, often woven into women's ceremonial garments.",
                    culture: "Neolithic Anatolia",
                    period: "7000 BCE"
                },
                { 
                    name: "L Shape", 
                    pattern: [0, 3, 6, 7, 8], 
                    points: 20, 
                    gridSize: 9,
                    history: "L-shaped patterns were fundamental in early European textile traditions, representing the carpenter's square - a symbol of honest work and craftsmanship in medieval guild textiles.",
                    culture: "Medieval European",
                    period: "800-1400 CE"
                },
                { 
                    name: "Zigzag", 
                    pattern: [0, 1, 4, 7, 8], 
                    points: 22, 
                    gridSize: 9,
                    history: "Zigzag patterns symbolized lightning and divine power in ancient cultures. Found in 4000-year-old Peruvian textiles, they were believed to channel the energy of storm gods.",
                    culture: "Ancient Peruvian",
                    period: "2000 BCE"
                },
                { 
                    name: "Border Frame", 
                    pattern: [0, 1, 2, 3, 5, 6, 7, 8], 
                    points: 35, 
                    gridSize: 9,
                    history: "Border patterns served as protective barriers in ancient textiles. Roman weavers used them to 'frame' important garments, believing they would protect the wearer from evil spirits and bad luck.",
                    culture: "Ancient Roman",
                    period: "100-400 CE"
                },
                { 
                    name: "X Pattern", 
                    pattern: [0, 2, 4, 6, 8], 
                    points: 28, 
                    gridSize: 9,
                    history: "The X-pattern, or saltire, has been woven into textiles for over 5000 years. In Celtic tradition, it represented the crossing of paths and was woven into cloaks worn by travelers for protection.",
                    culture: "Ancient Celtic",
                    period: "3000 BCE"
                }
            ],
            artisan: [
                { 
                    name: "Celtic Knot", 
                    pattern: [0, 1, 4, 5, 8, 9, 12, 13], 
                    points: 35, 
                    gridSize: 16,
                    history: "Celtic knot patterns emerged around 450 CE in Ireland and Scotland. These endless loops symbolized eternity and the interconnectedness of life. Master weavers spent years learning to create these complex interlacing patterns, which were reserved for nobility and religious ceremonies.",
                    culture: "Celtic Ireland/Scotland",
                    period: "450-1200 CE"
                },
                { 
                    name: "Aztec Sun", 
                    pattern: [1, 2, 4, 7, 8, 11, 13, 14], 
                    points: 40, 
                    gridSize: 16,
                    history: "The Aztec sun pattern, representing Tonatiuh the sun god, was woven into ceremonial textiles from 1345-1521 CE. Only the highest-ranking priests and nobles could wear garments featuring this sacred pattern, which required rare golden threads and took months to complete.",
                    culture: "Aztec Empire",
                    period: "1345-1521 CE"
                },
                { 
                    name: "Norse Rune", 
                    pattern: [0, 3, 5, 6, 9, 10, 12, 15], 
                    points: 45, 
                    gridSize: 16,
                    history: "Viking textile workers incorporated runic symbols into their weaving from 800-1100 CE. These patterns were believed to carry magical properties - warriors wore cloaks with runic patterns for protection in battle, and the patterns were thought to invoke the favor of Odin.",
                    culture: "Norse/Viking",
                    period: "800-1100 CE"
                },
                { 
                    name: "Egyptian Eye", 
                    pattern: [2, 3, 5, 6, 9, 10, 12, 13], 
                    points: 38, 
                    gridSize: 16,
                    history: "The Eye of Horus pattern was woven into Egyptian textiles from 3100 BCE. This powerful symbol of protection and royal power was found in Tutankhamun's tomb wrappings. The pattern required precise mathematical calculations that only master weavers possessed.",
                    culture: "Ancient Egyptian",
                    period: "3100 BCE - 30 BCE"
                },
                { 
                    name: "Mayan Glyph", 
                    pattern: [1, 4, 6, 7, 8, 9, 11, 14], 
                    points: 42, 
                    gridSize: 16,
                    history: "Mayan weavers created intricate glyph patterns representing their complex calendar system from 2000 BCE to 1500 CE. These textiles served as historical records, with each pattern telling stories of astronomical events, royal lineages, and religious ceremonies.",
                    culture: "Maya Civilization",
                    period: "2000 BCE - 1500 CE"
                },
                { 
                    name: "Roman Mosaic", 
                    pattern: [0, 2, 5, 7, 8, 10, 13, 15], 
                    points: 44, 
                    gridSize: 16,
                    history: "Roman textile workers adapted mosaic patterns from floor designs into their weaving around 100-400 CE. These geometric patterns demonstrated Roman engineering precision and were worn by senators and wealthy merchants as symbols of civilization and order.",
                    culture: "Roman Empire",
                    period: "100-400 CE"
                },
                { 
                    name: "Greek Key", 
                    pattern: [1, 3, 4, 6, 9, 11, 12, 14], 
                    points: 46, 
                    gridSize: 16,
                    history: "The Greek key (meander) pattern originated around 800 BCE and symbolized infinity and the eternal flow of life. Found on ancient Greek textiles and pottery, it was believed to represent the labyrinthine path of life and was woven into garments worn during important philosophical discussions.",
                    culture: "Ancient Greek",
                    period: "800-146 BCE"
                },
                { 
                    name: "Persian Flower", 
                    pattern: [2, 4, 6, 7, 8, 9, 11, 13], 
                    points: 48, 
                    gridSize: 16,
                    history: "Persian floral patterns reached their peak during the Safavid dynasty (1501-1736 CE). These intricate designs represented paradise gardens and were woven into silk carpets and royal garments using techniques passed down through generations of master craftsmen in Isfahan and Kashan.",
                    culture: "Persian/Safavid",
                    period: "1501-1736 CE"
                }
            ],
            master: [
                { 
                    name: "Byzantine Crown", 
                    pattern: [2, 3, 6, 8, 11, 13, 16, 18, 21, 22], 
                    points: 60, 
                    gridSize: 25,
                    history: "Byzantine crown patterns were woven into imperial silk textiles from 330-1453 CE in Constantinople. These patterns required gold and silver threads imported from across the empire. Only the imperial workshops could produce these designs, which took master weavers up to two years to complete a single garment.",
                    culture: "Byzantine Empire",
                    period: "330-1453 CE"
                },
                { 
                    name: "Persian Carpet", 
                    pattern: [0, 4, 5, 9, 10, 14, 15, 19, 20, 24], 
                    points: 65, 
                    gridSize: 25,
                    history: "The art of Persian carpet weaving reached its zenith during the reign of Shah Abbas I (1588-1629). These patterns, featuring the 'Shah Abbas palmette,' required over 1000 knots per square inch and could take a team of master weavers 3-5 years to complete a single royal carpet.",
                    culture: "Safavid Persia",
                    period: "1588-1629 CE"
                },
                { 
                    name: "Chinese Dragon", 
                    pattern: [1, 3, 6, 8, 11, 13, 16, 18, 21, 23], 
                    points: 70, 
                    gridSize: 25,
                    history: "Chinese dragon patterns were exclusively reserved for imperial use during the Ming (1368-1644) and Qing (1644-1912) dynasties. The five-clawed dragon could only be worn by the emperor, while four-clawed dragons were for princes. Unauthorized use was punishable by death.",
                    culture: "Imperial China",
                    period: "1368-1912 CE"
                },
                { 
                    name: "Japanese Sakura", 
                    pattern: [2, 7, 10, 12, 14, 17, 22], 
                    points: 55, 
                    gridSize: 25,
                    history: "Sakura (cherry blossom) patterns became prominent in Japanese textiles during the Heian period (794-1185). These delicate patterns were woven into court kimonos using a technique called 'nishiki,' requiring silk threads dyed with rare safflower pigments that cost more than gold.",
                    culture: "Heian Japan",
                    period: "794-1185 CE"
                },
                { 
                    name: "Indian Mandala", 
                    pattern: [0, 2, 4, 10, 12, 14, 20, 22, 24], 
                    points: 75, 
                    gridSize: 25,
                    history: "Mandala patterns in Indian textiles date back to 1500 BCE and represent the cosmic universe in Hindu and Buddhist traditions. Master weavers in Varanasi spent decades perfecting these sacred geometries, which were believed to bring spiritual enlightenment to both creator and wearer.",
                    culture: "Ancient India",
                    period: "1500 BCE - Present"
                },
                { 
                    name: "Aztec Calendar", 
                    pattern: [1, 5, 7, 9, 15, 17, 19, 23], 
                    points: 68, 
                    gridSize: 25,
                    history: "The Aztec calendar stone pattern was woven into ceremonial textiles used in Tenochtitlan's Great Temple from 1427-1521 CE. These patterns encoded complex astronomical calculations and were created by the 'pochteca' - elite merchant-weavers who held the secrets of the calendar system.",
                    culture: "Aztec Empire",
                    period: "1427-1521 CE"
                },
                { 
                    name: "Nordic Frost", 
                    pattern: [3, 4, 8, 12, 16, 20, 21], 
                    points: 62, 
                    gridSize: 25,
                    history: "Nordic frost patterns emerged in Scandinavia around 1000 CE, inspired by ice crystal formations. These patterns were woven into winter cloaks using wool from specially bred sheep. The geometric precision was believed to channel the protective power of winter spirits.",
                    culture: "Medieval Scandinavia",
                    period: "1000-1400 CE"
                },
                { 
                    name: "Moroccan Tile", 
                    pattern: [6, 7, 11, 13, 17, 18], 
                    points: 58, 
                    gridSize: 25,
                    history: "Moroccan geometric tile patterns, known as 'taqsim,' were adapted into textiles during the Almoravid dynasty (1040-1147 CE). These mathematical patterns, based on Islamic geometric principles, were woven into prayer rugs and required knowledge of advanced mathematics.",
                    culture: "Almoravid Morocco",
                    period: "1040-1147 CE"
                },
                { 
                    name: "Thai Silk", 
                    pattern: [1, 9, 11, 13, 15, 23], 
                    points: 72, 
                    gridSize: 25,
                    history: "Traditional Thai silk patterns reached their artistic peak during the Ayutthaya Kingdom (1351-1767 CE). The 'pha yok' technique created these intricate patterns using gold and silver threads. Master weavers were considered royal artisans and their techniques were closely guarded state secrets.",
                    culture: "Ayutthaya Thailand",
                    period: "1351-1767 CE"
                },
                { 
                    name: "Incan Textile", 
                    pattern: [5, 9, 10, 14, 15, 19], 
                    points: 66, 
                    gridSize: 25,
                    history: "Incan textile patterns, called 'tocapu,' were a form of writing system used from 1438-1533 CE. Each pattern conveyed specific information about the wearer's status, achievements, and lineage. The finest examples, made from vicua wool, were reserved for the Sapa Inca and required years to complete.",
                    culture: "Inca Empire",
                    period: "1438-1533 CE"
                }
            ]
        };
        
        // Innovation Quiz Questions Data
        const quizQuestions = {
            apprentice: [
                { question: "What is the basic tool used for weaving?", options: ["Loom", "Spindle", "Needle", "Scissors"], correct: 0, points: 10, time: 15 },
                { question: "Which fiber comes from sheep?", options: ["Cotton", "Wool", "Silk", "Linen"], correct: 1, points: 10, time: 15 },
                { question: "What color was most expensive in ancient times?", options: ["Red", "Blue", "Purple", "Gold"], correct: 2, points: 15, time: 15 },
                { question: "Which plant produces cotton?", options: ["Flax", "Cotton plant", "Hemp", "Bamboo"], correct: 1, points: 10, time: 15 },
                { question: "What insect produces silk?", options: ["Spider", "Silkworm", "Caterpillar", "Moth"], correct: 1, points: 10, time: 15 }
            ],
            artisan: [
                { question: "What machine revolutionized spinning in 1764?", options: ["Water Frame", "Spinning Jenny", "Power Loom", "Cotton Gin"], correct: 1, points: 20, time: 20 },
                { question: "What was the first synthetic fiber?", options: ["Polyester", "Nylon", "Rayon", "Acrylic"], correct: 1, points: 25, time: 20 },
                { question: "Which country first developed silk production?", options: ["India", "Japan", "China", "Persia"], correct: 2, points: 20, time: 20 },
                { question: "What natural dye creates indigo blue?", options: ["Woad plant", "Indigo plant", "Madder root", "Cochineal"], correct: 1, points: 25, time: 20 },
                { question: "When was the first textile factory built?", options: ["1750s", "1760s", "1770s", "1780s"], correct: 2, points: 30, time: 25 }
            ],
            master: [
                { question: "What makes spider silk 5x stronger than steel?", options: ["Protein chains", "Carbon bonds", "Crystalline structure", "Molecular alignment"], correct: 0, points: 40, time: 25 },
                { question: "Which nanotechnology enables electrical conductivity in smart textiles?", options: ["Silver nanoparticles", "Carbon nanotubes", "Graphene sheets", "All of the above"], correct: 3, points: 50, time: 30 },
                { question: "What punishment existed in ancient China for revealing silk secrets?", options: ["Exile", "Prison", "Death", "Heavy fine"], correct: 2, points: 35, time: 25 },
                { question: "Which property of Kevlar makes it bulletproof?", options: ["High tensile strength", "Low density", "Chemical resistance", "Heat resistance"], correct: 0, points: 45, time: 30 },
                { question: "What percentage of global textile production uses synthetic fibers today?", options: ["40%", "60%", "70%", "80%"], correct: 2, points: 40, time: 25 }
            ]
        };
        
        // Auto-login check
        async function checkAutoLogin() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    console.log('Found existing session for:', session.user.email);
                    currentUser = session.user;
                    
                    // Load player data
                    const { data, error } = await supabaseClient
                        .from('players')
                        .select('*')
                        .eq('user_id', session.user.id);
                    
                    if (data && data.length > 0) {
                        const dbData = data[0];
                        console.log(' Loaded from database:', dbData);
                        
                        // Convert snake_case to camelCase
                        playerData = {
                            email: dbData.email,
                            name: dbData.name,
                            level: dbData.level,
                            rank: dbData.rank || 156,
                            totalScore: dbData.total_score || 0,
                            coins: dbData.coins || 0,
                            challenges: dbData.challenges || {
                                heritage: { best: 0, completed: false },
                                innovation: { best: 0, completed: false },
                                future: { best: 0, completed: false }
                            },
                            streak: dbData.streak || {
                                current: 0,
                                longest: 0,
                                lastCompletedDate: null,
                                todayCompleted: {
                                    heritage: false,
                                    innovation: false,
                                    future: false
                                },
                                streakSaves: 0
                            },
                            lastPlayed: dbData.last_played
                        };
                        
                        // Ensure streak structure exists
                        if (!playerData.streak) {
                            playerData.streak = {
                                current: 0,
                                longest: 0,
                                lastCompletedDate: null,
                                todayCompleted: {
                                    heritage: false,
                                    innovation: false,
                                    future: false
                                },
                                streakSaves: 0
                            };
                        }
                        
                        // Ensure todayCompleted exists
                        if (!playerData.streak.todayCompleted) {
                            playerData.streak.todayCompleted = {
                                heritage: false,
                                innovation: false,
                                future: false
                            };
                        }
                        
                        console.log(' Auto-login successful');
                        console.log('Player data loaded:', playerData);
                        showDashboard();
                        startBackgroundMusic();
                    }
                }
            } catch (error) {
                console.log('No existing session found');
            }
        }

        
        // Login existing player
        async function loginPlayer() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showNotification('Please enter email and password!', 'error');
                return;
            }
            
            try {
                console.log(' Logging in:', email);
                
                // Sign in with Supabase
                const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                if (authData.user) {
                    currentUser = authData.user;
                    
                    // Load player data
                    const { data, error: dbError } = await supabaseClient
                        .from('players')
                        .select('*')
                        .eq('user_id', authData.user.id);
                    
                    if (dbError) throw dbError;
                    
                    if (data && data.length > 0) {
                        const dbData = data[0];
                        
                        // Convert snake_case to camelCase
                        playerData = {
                            email: dbData.email,
                            name: dbData.name,
                            level: dbData.level,
                            rank: dbData.rank || 156,
                            totalScore: dbData.total_score || 0,
                            coins: dbData.coins || 0,
                            challenges: dbData.challenges || {
                                heritage: { best: 0, completed: false },
                                innovation: { best: 0, completed: false },
                                future: { best: 0, completed: false }
                            },
                            streak: dbData.streak || {
                                current: 0,
                                longest: 0,
                                lastCompletedDate: null,
                                todayCompleted: {
                                    heritage: false,
                                    innovation: false,
                                    future: false
                                },
                                streakSaves: 0
                            },
                            lastPlayed: dbData.last_played
                        };
                        
                        // Ensure streak structure
                        if (!playerData.streak.todayCompleted) {
                            playerData.streak.todayCompleted = {
                                heritage: false,
                                innovation: false,
                                future: false
                            };
                        }
                        
                        console.log(' Login successful!');
                        playSound('success');
                        
                        showDashboard();
                        startBackgroundMusic();
                    }
                }
            } catch (error) {
                console.error(' Login error:', error);
                showNotification('Login failed: ' + error.message, 'error');
            }
        }
        
        // Toggle between login and register forms - Optimized
        function showRegisterForm() {
            const registerForm = domCache.get('register-form');
            const loginForm = domCache.get('login-form');
            const showRegister = domCache.get('show-register');
            const showLogin = domCache.get('show-login');
            
            if (registerForm) registerForm.style.display = 'block';
            if (loginForm) loginForm.style.display = 'none';
            if (showRegister) showRegister.style.background = 'linear-gradient(45deg, #00d4ff, #4ecdc4)';
            if (showLogin) showLogin.style.background = 'rgba(255,255,255,0.1)';
        }
        
        function showLoginForm() {
            const registerForm = domCache.get('register-form');
            const loginForm = domCache.get('login-form');
            const showRegister = domCache.get('show-register');
            const showLogin = domCache.get('show-login');
            
            if (registerForm) registerForm.style.display = 'none';
            if (loginForm) loginForm.style.display = 'block';
            if (showRegister) showRegister.style.background = 'rgba(255,255,255,0.1)';
            if (showLogin) showLogin.style.background = 'linear-gradient(45deg, #00d4ff, #4ecdc4)';
        }
        
        // Save player data
        async function savePlayerData() {
            if (currentUser && playerData) {
                try {
                    console.log(' Saving player data...', playerData);
                    
                    // Convert camelCase to snake_case for database
                    const dbData = {
                        name: playerData.name,
                        level: playerData.level,
                        rank: playerData.rank || 156,
                        total_score: playerData.totalScore || playerData.total_score || 0,
                        coins: playerData.coins || 0,
                        challenges: playerData.challenges || {
                            heritage: { best: 0, completed: false },
                            innovation: { best: 0, completed: false },
                            future: { best: 0, completed: false }
                        },
                        streak: playerData.streak || {
                            current: 0,
                            longest: 0,
                            lastCompletedDate: null,
                            todayCompleted: {
                                heritage: false,
                                innovation: false,
                                future: false
                            },
                            streakSaves: 0
                        },
                        last_played: new Date().toISOString()
                    };
                    
                    console.log(' Sending to database:', dbData);
                    
                    const { error } = await supabaseClient
                        .from('players')
                        .update(dbData)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                    console.log(' Player data saved to cloud successfully');
                } catch (error) {
                    console.error(' Failed to save player data:', error);
                    console.error('Error details:', error.message);
                }
            } else {
                console.warn(' Cannot save: currentUser or playerData missing');
            }
        }
        
        // Logout function
        async function logoutPlayer() {
            playSound('click');
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                playerData = {
                    email: '',
                    name: '',
                    level: 'apprentice',
                    rank: 156,
                    totalScore: 0,
                    coins: 0,
                    challenges: {
                        heritage: { best: 0, completed: false },
                        innovation: { best: 0, completed: false },
                        future: { best: 0, completed: false }
                    }
                };
                stopBackgroundMusic();
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('registration').classList.add('active');
                console.log(' Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Initialize on load
        checkAutoLogin();
        
        // Game state
        let playerData = {
            email: '',
            name: '',
            level: 'apprentice',
            rank: 156,
            totalScore: 0,
            coins: 0,
            unlockedItems: ['', '', '', '', '', ''],
            challenges: {
                heritage: { best: 0, completed: false },
                innovation: { best: 0, completed: false },
                future: { best: 0, completed: false }
            },
            streak: {
                current: 0,
                longest: 0,
                lastCompletedDate: null,
                todayCompleted: {
                    heritage: false,
                    innovation: false,
                    future: false
                },
                streakSaves: 0 // Number of streak saves owned
            },
            lastPlayed: null
        };
        
        let currentChallenge = null;
        let challengeTimer = null;
        
        // LocalStorage keys
        const STORAGE_KEY = 'chronoweave_players';
        const CURRENT_USER_KEY = 'chronoweave_current_user';
        
        // Audio Context for sound effects
        let audioContext = null;
        let bgMusicInterval = null;
        
        // Initialize Audio Context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        // Get game settings
        function getGameSettings() {
            return JSON.parse(localStorage.getItem('chronoweave_game_settings') || '{"sound": true, "music": true, "musicTheme": "ambient", "autosave": true}');
        }
        
        // Modern music themes with electronic production
        const musicThemes = {
            ambient: {
                name: 'Chill Lofi',
                chords: [220.00, 246.94, 293.66, 329.63], // Am - Bm - Dm - Em (modern lofi)
                duration: 3.5,
                waveType: 'triangle',
                filterFreq: 900,
                detune: 5
            },
            upbeat: {
                name: 'Future Bass',
                chords: [261.63, 329.63, 392.00, 293.66], // C - Em - G - D (EDM progression)
                duration: 1.5,
                waveType: 'sawtooth',
                filterFreq: 1400,
                detune: 10
            },
            speedrun: {
                name: 'Hyperpop Rush',
                chords: [349.23, 392.00, 440.00, 493.88], // F - G - A - B (high energy)
                duration: 0.75,
                waveType: 'square',
                filterFreq: 2000,
                detune: 15
            },
            mysterious: {
                name: 'Synthwave Night',
                chords: [220.00, 277.18, 329.63, 369.99], // Am - C#m - Em - F#m (80s synth)
                duration: 4,
                waveType: 'sawtooth',
                filterFreq: 1100,
                detune: 8
            },
            epic: {
                name: 'Cinematic Trap',
                chords: [174.61, 220.00, 261.63, 293.66], // F - Am - C - Dm (trap progression)
                duration: 2.5,
                waveType: 'sawtooth',
                filterFreq: 1300,
                detune: 12
            },
            minimal: {
                name: 'Deep House',
                chords: [196.00, 246.94, 293.66], // Gm - Bm - Dm (house music)
                duration: 5,
                waveType: 'sine',
                filterFreq: 700,
                detune: 3
            }
        };
        
        // Sound Effects using Web Audio API
        function playSound(type) {
            const settings = getGameSettings();
            if (!settings.sound) return;
            
            try {
                const ctx = initAudio();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                switch(type) {
                    case 'click':
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.1);
                        break;
                        
                    case 'success':
                        oscillator.frequency.value = 523.25; // C5
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.3);
                        
                        // Add harmony
                        setTimeout(() => {
                            const osc2 = ctx.createOscillator();
                            const gain2 = ctx.createGain();
                            osc2.connect(gain2);
                            gain2.connect(ctx.destination);
                            osc2.frequency.value = 659.25; // E5
                            osc2.type = 'sine';
                            gain2.gain.setValueAtTime(0.2, ctx.currentTime);
                            gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                            osc2.start(ctx.currentTime);
                            osc2.stop(ctx.currentTime + 0.3);
                        }, 100);
                        break;
                        
                    case 'error':
                        oscillator.frequency.value = 200;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.2);
                        break;
                        
                    case 'complete':
                        // Victory fanfare
                        const notes = [523.25, 587.33, 659.25, 783.99]; // C, D, E, G
                        notes.forEach((freq, i) => {
                            setTimeout(() => {
                                const osc = ctx.createOscillator();
                                const gain = ctx.createGain();
                                osc.connect(gain);
                                gain.connect(ctx.destination);
                                osc.frequency.value = freq;
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                                osc.start(ctx.currentTime);
                                osc.stop(ctx.currentTime + 0.4);
                            }, i * 150);
                        });
                        break;
                        
                    case 'hover':
                        oscillator.frequency.value = 600;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.05);
                        break;
                        
                    case 'tick':
                        oscillator.frequency.value = 1000;
                        oscillator.type = 'square';
                        gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.05);
                        break;
                }
            } catch (error) {
                console.error('Error playing sound:', error);
            }
        }
        
        // Background Music - Improved ambient soundscape with themes
        function startBackgroundMusic() {
            const settings = getGameSettings();
            if (!settings.music) return;
            
            stopBackgroundMusic(); // Stop any existing music
            
            try {
                const ctx = initAudio();
                const theme = musicThemes[settings.musicTheme || 'ambient'];
                
                console.log('Starting music theme:', theme.name);
                
                // Create bass line - Optimized
                const createBass = (frequency, duration, delay = 0) => {
                    const settings = getGameSettings();
                    if (!settings.music) return;
                    
                    setTimeout(() => {
                        
                        const now = ctx.currentTime;
                        
                        // Sub bass oscillator
                        const bassOsc = ctx.createOscillator();
                        const bassGain = ctx.createGain();
                        const bassFilter = ctx.createBiquadFilter();
                        
                        bassOsc.type = 'sine';
                        bassOsc.frequency.value = frequency * 0.5; // One octave down
                        
                        bassFilter.type = 'lowpass';
                        bassFilter.frequency.value = 200;
                        bassFilter.Q.value = 1;
                        
                        bassOsc.connect(bassFilter);
                        bassFilter.connect(bassGain);
                        bassGain.connect(ctx.destination);
                        
                        // Bass envelope - punchy
                        bassGain.gain.setValueAtTime(0, now);
                        bassGain.gain.linearRampToValueAtTime(0.08, now + 0.01);
                        bassGain.gain.exponentialRampToValueAtTime(0.04, now + 0.1);
                        bassGain.gain.setValueAtTime(0.04, now + duration - 0.1);
                        bassGain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                        
                        bassOsc.start(now);
                        bassOsc.stop(now + duration);
                    }, delay);
                };
                
                // Create lead synth
                const createLead = (frequency, duration, waveType, filterFreq, detune, delay = 0) => {
                    setTimeout(() => {
                        const settings = getGameSettings();
                        if (!settings.music) return;
                        
                        const now = ctx.currentTime;
                        
                        // Create super saw/unison effect
                        const oscillators = [];
                        const gains = [];
                        
                        for (let i = 0; i < 4; i++) {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            
                            osc.type = waveType;
                            osc.frequency.value = frequency * (i === 3 ? 2 : 1);
                            osc.detune.value = (i - 1.5) * detune;
                            
                            oscillators.push(osc);
                            gains.push(gain);
                        }
                        
                        // Lead filter with envelope
                        const filter = ctx.createBiquadFilter();
                        filter.type = 'lowpass';
                        filter.frequency.value = filterFreq * 0.5;
                        filter.Q.value = 3;
                        
                        filter.frequency.setValueAtTime(filterFreq * 0.5, now);
                        filter.frequency.exponentialRampToValueAtTime(filterFreq, now + 0.1);
                        filter.frequency.exponentialRampToValueAtTime(filterFreq * 0.7, now + duration);
                        
                        const masterGain = ctx.createGain();
                        
                        oscillators.forEach((osc, i) => {
                            osc.connect(gains[i]);
                            gains[i].connect(filter);
                        });
                        filter.connect(masterGain);
                        masterGain.connect(ctx.destination);
                        
                        // Lead ADSR
                        const attack = duration * 0.1;
                        const decay = duration * 0.2;
                        const sustain = 0.6;
                        const release = duration * 0.3;
                        
                        gains.forEach((gain, i) => {
                            const vol = i === 3 ? 0.006 : 0.01;
                            gain.gain.setValueAtTime(0, now);
                            gain.gain.linearRampToValueAtTime(vol, now + attack);
                            gain.gain.linearRampToValueAtTime(vol * sustain, now + attack + decay);
                            gain.gain.setValueAtTime(vol * sustain, now + duration - release);
                            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                        });
                        
                        masterGain.gain.setValueAtTime(1, now);
                        
                        // LFO vibrato
                        const lfo = ctx.createOscillator();
                        const lfoGain = ctx.createGain();
                        lfo.frequency.value = 5;
                        lfoGain.gain.value = 2;
                        
                        lfo.connect(lfoGain);
                        oscillators.forEach(osc => lfoGain.connect(osc.detune));
                        
                        oscillators.forEach(osc => {
                            osc.start(now);
                            osc.stop(now + duration);
                        });
                        lfo.start(now);
                        lfo.stop(now + duration);
                    }, delay);
                };
                
                // Create percussion (kick and hi-hat)
                const createPercussion = (duration, delay = 0) => {
                    setTimeout(() => {
                        const settings = getGameSettings();
                        if (!settings.music) return;
                        
                        const now = ctx.currentTime;
                        
                        // Kick drum
                        const kickOsc = ctx.createOscillator();
                        const kickGain = ctx.createGain();
                        
                        kickOsc.frequency.setValueAtTime(150, now);
                        kickOsc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
                        
                        kickGain.gain.setValueAtTime(0.15, now);
                        kickGain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                        
                        kickOsc.connect(kickGain);
                        kickGain.connect(ctx.destination);
                        
                        kickOsc.start(now);
                        kickOsc.stop(now + 0.3);
                        
                        // Hi-hat on offbeat
                        const hihatOsc = ctx.createOscillator();
                        const hihatGain = ctx.createGain();
                        const hihatFilter = ctx.createBiquadFilter();
                        
                        hihatOsc.type = 'square';
                        hihatOsc.frequency.value = 8000;
                        
                        hihatFilter.type = 'highpass';
                        hihatFilter.frequency.value = 7000;
                        
                        hihatOsc.connect(hihatFilter);
                        hihatFilter.connect(hihatGain);
                        hihatGain.connect(ctx.destination);
                        
                        hihatGain.gain.setValueAtTime(0.02, now + duration * 0.5);
                        hihatGain.gain.exponentialRampToValueAtTime(0.001, now + duration * 0.5 + 0.05);
                        
                        hihatOsc.start(now + duration * 0.5);
                        hihatOsc.stop(now + duration * 0.5 + 0.05);
                        
                    }, delay);
                };
                
                // Create pad/atmosphere
                const createPad = (frequency, duration, delay = 0) => {
                    setTimeout(() => {
                        const settings = getGameSettings();
                        if (!settings.music) return;
                        
                        const now = ctx.currentTime;
                        
                        // Soft pad with multiple voices
                        for (let i = 0; i < 3; i++) {
                            const padOsc = ctx.createOscillator();
                            const padGain = ctx.createGain();
                            const padFilter = ctx.createBiquadFilter();
                            
                            padOsc.type = 'sine';
                            padOsc.frequency.value = frequency * (1 + i * 0.5);
                            padOsc.detune.value = (i - 1) * 5;
                            
                            padFilter.type = 'lowpass';
                            padFilter.frequency.value = 600;
                            
                            padOsc.connect(padFilter);
                            padFilter.connect(padGain);
                            padGain.connect(ctx.destination);
                            
                            // Very slow attack for pad
                            padGain.gain.setValueAtTime(0, now);
                            padGain.gain.linearRampToValueAtTime(0.003, now + duration * 0.3);
                            padGain.gain.setValueAtTime(0.003, now + duration - 0.5);
                            padGain.gain.linearRampToValueAtTime(0.001, now + duration);
                            
                            padOsc.start(now);
                            padOsc.stop(now + duration);
                        }
                    }, delay);
                };
                
                let chordIndex = 0;
                let beatCount = 0;
                
                const playChord = () => {
                    const settings = getGameSettings();
                    if (!settings.music) return;
                    
                    const currentTheme = musicThemes[settings.musicTheme || 'ambient'];
                    const freq = currentTheme.chords[chordIndex];
                    const dur = currentTheme.duration;
                    
                    // Layer 1: Bass (always playing)
                    createBass(freq, dur, 0);
                    
                    // Layer 2: Lead synth (main melody)
                    createLead(
                        freq, 
                        dur, 
                        currentTheme.waveType,
                        currentTheme.filterFreq,
                        currentTheme.detune,
                        0
                    );
                    
                    // Layer 3: Pad (atmospheric background)
                    if (beatCount % 2 === 0) { // Every other chord
                        createPad(freq, dur * 2, 0);
                    }
                    
                    // Layer 4: Percussion (rhythm)
                    if (currentTheme.duration <= 2) { // Only for faster themes
                        createPercussion(dur, 0);
                    }
                    
                    chordIndex = (chordIndex + 1) % currentTheme.chords.length;
                    beatCount++;
                };
                
                // Start immediately
                playChord();
                
                // Continue playing chords
                bgMusicInterval = setInterval(playChord, theme.duration * 1000);
                
            } catch (error) {
                console.error('Error starting background music:', error);
            }
        }
        
        function stopBackgroundMusic() {
            if (bgMusicInterval) {
                clearInterval(bgMusicInterval);
                bgMusicInterval = null;
            }
        }
        
        function toggleBackgroundMusic() {
            const settings = getGameSettings();
            if (settings.music) {
                startBackgroundMusic();
            } else {
                stopBackgroundMusic();
            }
        }
        
        // Difficulty-based Innovation Quiz Data (continued)
        const quizQuestions2 = {
            apprentice: [
                { name: "Simple Weave", pattern: [0, 1, 4, 5], points: 10, gridSize: 9 },
                { name: "Basic Cross", pattern: [1, 3, 4, 5, 7], points: 15, gridSize: 9 },
                { name: "Corner Dots", pattern: [0, 2, 6, 8], points: 10, gridSize: 9 },
                { name: "Center Star", pattern: [1, 3, 4, 5, 7], points: 12, gridSize: 9 },
                { name: "Diamond", pattern: [1, 3, 4, 5, 7], points: 15, gridSize: 9 },
                { name: "T-Shape", pattern: [0, 1, 2, 4, 7], points: 12, gridSize: 9 },
                { name: "L-Shape", pattern: [0, 3, 6, 7, 8], points: 10, gridSize: 9 },
                { name: "Plus Sign", pattern: [1, 3, 4, 5, 7], points: 15, gridSize: 9 },
                { name: "Zigzag", pattern: [0, 1, 4, 7, 8], points: 12, gridSize: 9 },
                { name: "Border Frame", pattern: [0, 1, 2, 3, 5, 6, 7, 8], points: 20, gridSize: 9 }
            ],
            artisan: [
                { name: "Mesopotamian Royal", pattern: [0, 1, 4, 5, 8, 9, 12, 13], points: 25, gridSize: 16 },
                { name: "Celtic Knot", pattern: [1, 2, 4, 7, 8, 11, 13, 14], points: 30, gridSize: 16 },
                { name: "Egyptian Pyramid", pattern: [1, 2, 4, 7, 8, 9, 10, 11], points: 28, gridSize: 16 },
                { name: "Greek Key", pattern: [0, 1, 2, 4, 6, 8, 10, 12, 13, 14], points: 30, gridSize: 16 },
                { name: "Persian Flower", pattern: [1, 2, 4, 5, 6, 7, 9, 10, 13, 14], points: 35, gridSize: 16 },
                { name: "Roman Mosaic", pattern: [0, 3, 5, 6, 9, 10, 12, 15], points: 28, gridSize: 16 },
                { name: "Viking Rune", pattern: [1, 4, 5, 6, 7, 9, 10, 13], points: 30, gridSize: 16 },
                { name: "Chinese Dragon", pattern: [0, 1, 4, 6, 7, 8, 9, 11, 14, 15], points: 35, gridSize: 16 },
                { name: "Indian Mandala", pattern: [1, 2, 4, 5, 6, 7, 9, 10, 11, 13, 14], points: 40, gridSize: 16 },
                { name: "African Tribal", pattern: [0, 2, 3, 5, 8, 10, 12, 13, 15], points: 32, gridSize: 16 }
            ],
            master: [
                { name: "Aztec Sun Complex", pattern: [0, 2, 4, 6, 9, 11, 13, 15, 18, 20, 22, 24], points: 50, gridSize: 25 },
                { name: "Byzantine Imperial", pattern: [1, 3, 5, 7, 10, 12, 14, 16, 19, 21, 23], points: 55, gridSize: 25 },
                { name: "Mayan Calendar", pattern: [2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22], points: 52, gridSize: 25 },
                { name: "Japanese Sakura", pattern: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23], points: 55, gridSize: 25 },
                { name: "Nordic Frost", pattern: [0, 4, 5, 9, 10, 14, 15, 19, 20, 24], points: 50, gridSize: 25 },
                { name: "Moroccan Tile", pattern: [2, 3, 4, 7, 10, 11, 12, 13, 14, 17, 20, 21, 22], points: 60, gridSize: 25 },
                { name: "Thai Silk", pattern: [1, 3, 5, 6, 7, 8, 9, 11, 13, 15, 16, 17, 18, 19, 21, 23], points: 65, gridSize: 25 },
                { name: "Turkish Carpet", pattern: [0, 2, 4, 5, 9, 10, 14, 15, 19, 20, 22, 24], points: 52, gridSize: 25 },
                { name: "Incan Textile", pattern: [1, 2, 3, 6, 8, 11, 13, 16, 18, 21, 22, 23], points: 55, gridSize: 25 },
                { name: "Polynesian Tapa", pattern: [0, 1, 3, 4, 6, 8, 10, 12, 14, 16, 18, 20, 21, 23, 24], points: 70, gridSize: 25 }
            ]
        };
        
        
        // Future Challenge Data
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = '#FFD700';
        let designMetrics = { creativity: 0, innovation: 0, functionality: 0 };
        
        // LocalStorage Management
        function getAllPlayers() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : {};
        }
        
        function savePlayer(email, playerInfo) {
            const players = getAllPlayers();
            players[email] = playerInfo;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
        }
        

        
        function getPlayer(email) {
            const players = getAllPlayers();
            return players[email] || null;
        }
        
        function saveCurrentUser(email) {
            localStorage.setItem(CURRENT_USER_KEY, email);
        }
        
        function getCurrentUser() {
            return localStorage.getItem(CURRENT_USER_KEY);
        }
        
        function clearCurrentUser() {
            localStorage.removeItem(CURRENT_USER_KEY);
        }
        
        // Form Toggle Functions
        function showRegisterForm() {
            document.getElementById('register-form').style.display = 'block';
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('show-register').style.background = 'linear-gradient(45deg, #00d4ff, #4ecdc4)';
            document.getElementById('show-login').style.background = 'rgba(255,255,255,0.1)';
        }
        
        function showLoginForm() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('show-login').style.background = 'linear-gradient(45deg, #00d4ff, #4ecdc4)';
            document.getElementById('show-register').style.background = 'rgba(255,255,255,0.1)';
        }
        
        // Registration
        async function registerNewPlayer() {
            playSound('click');
            
            const email = document.getElementById('register-email').value.trim().toLowerCase();
            const name = document.getElementById('register-name').value.trim();
            const password = document.getElementById('register-password').value;
            const level = document.getElementById('register-difficulty').value;
            
            // Validation
            if (!email || !name || !password) {
                playSound('error');
                showNotification('Please fill in all fields!', 'error');
                return;
            }
            
            if (!email.includes('@') || !email.includes('.')) {
                playSound('error');
                showNotification('Please enter a valid email address!', 'error');
                return;
            }
            
            if (password.length < 6) {
                playSound('error');
                showNotification('Password must be at least 6 characters long!', 'error');
                return;
            }
            
            try {
                console.log('Creating user account for:', email);
                
                // Sign up with Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                console.log(' Supabase user created:', authData.user.id);
                
                // Create player data
                const newPlayer = {
                    user_id: authData.user.id,
                    email: email,
                    name: name,
                    level: level,
                    rank: Math.floor(Math.random() * 500) + 50,
                    total_score: 0,
                    coins: 0,
                    challenges: {
                        heritage: { best: 0, completed: false },
                        innovation: { best: 0, completed: false },
                        future: { best: 0, completed: false }
                    },
                    streak: {
                        current: 0,
                        longest: 0,
                        lastCompletedDate: null,
                        todayCompleted: { heritage: false, innovation: false, future: false },
                        streakSaves: 0
                    },
                    created_at: new Date().toISOString(),
                    last_played: new Date().toISOString()
                };
                
                console.log('Saving player data to Supabase:', newPlayer);
                
                // Save to Supabase database
                const { error: dbError } = await supabaseClient
                    .from('players')
                    .insert([newPlayer]);
                
                if (dbError) throw dbError;
                
                console.log(' Player data saved to cloud database');
                
                currentUser = authData.user;
                
                // Load player data (convert snake_case to camelCase for compatibility)
                playerData = {
                    email: newPlayer.email,
                    name: newPlayer.name,
                    level: newPlayer.level,
                    rank: newPlayer.rank,
                    totalScore: newPlayer.total_score,
                    coins: newPlayer.coins,
                    challenges: newPlayer.challenges,
                    streak: newPlayer.streak,
                    createdAt: newPlayer.created_at,
                    lastPlayed: newPlayer.last_played
                };
                
                playSound('success');
                showNotification(`Welcome to Chronoweave, ${name}! Your account has been created.`, 'success', 5000);
                showDashboard();
                startBackgroundMusic();
                
            } catch (error) {
                console.error('Registration error:', error);
                playSound('error');
                
                if (error.message.includes('already registered')) {
                    showNotification('This email is already registered! Please login instead.', 'warning');
                    showLoginForm();
                } else {
                    showNotification('Registration failed: ' + error.message, 'error');
                }
            }
        }
        
        // Login
        async function loginPlayer() {
            playSound('click');
            
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                playSound('error');
                showNotification('Please enter your email and password!', 'error');
                return;
            }
            
            try {
                console.log('Attempting login with email:', email);
                
                // Sign in with Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                console.log(' User authenticated:', authData.user.id);
                
                currentUser = authData.user;
                
                // Get player data from database
                const { data: playerRecords, error: dbError } = await supabaseClient
                    .from('players')
                    .select('*')
                    .eq('user_id', authData.user.id);
                
                if (dbError) throw dbError;
                
                if (!playerRecords || playerRecords.length === 0) {
                    throw new Error('No player data found. Please register first.');
                }
                
                const playerRecord = playerRecords[0];
                
                console.log(' Player data loaded from cloud:', playerRecord);
                
                // Update last played
                await supabaseClient
                    .from('players')
                    .update({ last_played: new Date().toISOString() })
                    .eq('user_id', authData.user.id);
                
                // Load player data (convert snake_case to camelCase)
                playerData = {
                    email: playerRecord.email,
                    name: playerRecord.name,
                    level: playerRecord.level,
                    rank: playerRecord.rank,
                    totalScore: playerRecord.total_score,
                    coins: playerRecord.coins,
                    challenges: playerRecord.challenges,
                    streak: playerRecord.streak || {
                        current: 0,
                        longest: 0,
                        lastCompletedDate: null,
                        todayCompleted: { heritage: false, innovation: false, future: false },
                        streakSaves: 0
                    },
                    createdAt: playerRecord.created_at,
                    lastPlayed: new Date().toISOString()
                };
                
                console.log(' Player data loaded into game:', playerData);
                
                playSound('success');
                showNotification(`Welcome back, ${playerData.name}!`, 'success', 4000);
                showDashboard();
                startBackgroundMusic();
                
            } catch (error) {
                console.error('Login error:', error);
                playSound('error');
                
                if (error.message.includes('Invalid login credentials')) {
                    showNotification('Incorrect email or password! Please try again.', 'error');
                } else if (error.message.includes('Email not confirmed')) {
                    showNotification('Please check your email to confirm your account!', 'warning');
                } else {
                    showNotification('Login failed: ' + error.message, 'error');
                }
            }
        }
        
        function showDashboard() {
            const registration = domCache.get('registration');
            const dashboard = domCache.get('dashboard');
            const welcomeText = domCache.get('welcome-text');
            const playerEmail = domCache.get('player-email');
            const totalScore = domCache.get('total-score');
            const playerLevel = domCache.get('player-level');
            const lastPlayed = domCache.get('last-played');
            
            if (registration) registration.classList.remove('active');
            if (dashboard) dashboard.classList.add('active');
            
            // Display avatar if exists
            if (welcomeText) {
                if (playerData.avatar) {
                    const avatarDisplay = playerData.avatar.accessory 
                        ? `${playerData.avatar.skin}${playerData.avatar.accessory}` 
                        : playerData.avatar.skin;
                    welcomeText.innerHTML = `${avatarDisplay} Welcome, ${playerData.name}!`;
                } else {
                    welcomeText.textContent = `Welcome, ${playerData.name}!`;
                }
            }
            
            if (playerEmail) playerEmail.textContent = playerData.email;
            if (totalScore) totalScore.textContent = playerData.totalScore;
            if (playerLevel) playerLevel.textContent = playerData.level.charAt(0).toUpperCase() + playerData.level.slice(1);
            
            // Calculate actual rank from database
            updatePlayerRank();
            
            // Format last played time
            if (playerData.lastPlayed && lastPlayed) {
                const lastPlayedDate = new Date(playerData.lastPlayed);
                const now = new Date();
                const diffMs = now - lastPlayedDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                let timeText = 'Just now';
                if (diffDays > 0) {
                    timeText = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                } else if (diffHours > 0) {
                    timeText = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else if (diffMins > 0) {
                    timeText = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                }
                
                lastPlayed.textContent = timeText;
            }
            
            updateChallengeStats();
            updateCoinDisplay();
            checkAndUpdateStreak();
            updateStreakDisplay();
            
            // Add challenge card click handlers with event delegation
            const challengeContainer = document.querySelector('.challenges-grid');
            if (challengeContainer && !challengeContainer.hasEventListener) {
                challengeContainer.addEventListener('click', function(e) {
                    const card = e.target.closest('.challenge-card');
                    if (card) {
                        const type = card.getAttribute('data-challenge');
                        startChallenge(type);
                    }
                });
                challengeContainer.hasEventListener = true;
            }
        }
        
        function updateChallengeStats() {
            const heritageBest = domCache.get('heritage-best');
            const innovationBest = domCache.get('innovation-best');
            const futureBest = domCache.get('future-best');
            const challengesCompleted = domCache.get('challenges-completed');
            
            if (heritageBest) heritageBest.textContent = playerData.challenges.heritage.best;
            if (innovationBest) innovationBest.textContent = playerData.challenges.innovation.best;
            if (futureBest) futureBest.textContent = playerData.challenges.future.best;
            
            const completed = Object.values(playerData.challenges).filter(c => c.completed).length;
            if (challengesCompleted) challengesCompleted.textContent = `${completed}/3`;
        }
        
        // Streak System Functions
        function checkAndUpdateStreak() {
            if (!playerData.streak) {
                playerData.streak = {
                    current: 0,
                    longest: 0,
                    lastCompletedDate: null,
                    todayCompleted: { heritage: false, innovation: false, future: false },
                    streakSaves: 0
                };
            }
            
            const today = new Date().toDateString();
            const lastDate = playerData.streak.lastCompletedDate ? new Date(playerData.streak.lastCompletedDate).toDateString() : null;
            
            // Check if it's a new day
            if (lastDate !== today) {
                // Reset today's completed challenges
                playerData.streak.todayCompleted = {
                    heritage: false,
                    innovation: false,
                    future: false
                };
                
                // Check if streak should break
                if (lastDate) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toDateString();
                    
                    if (lastDate !== yesterdayStr) {
                        // Missed a day - check for streak save
                        if (playerData.streak.streakSaves > 0) {
                            playerData.streak.streakSaves--;
                            console.log(' Streak saved! Remaining saves:', playerData.streak.streakSaves);
                            showSuccessMessage(' Streak Save used! Your streak is protected!');
                        } else {
                            // Break streak
                            console.log(' Streak broken!');
                            playerData.streak.current = 0;
                            showErrorMessage(' Streak broken! Complete all 3 challenges daily to maintain your streak.');
                        }
                    }
                }
            }
        }
        
        function updateStreakProgress() {
            const allCompleted = playerData.streak.todayCompleted.heritage && 
                                 playerData.streak.todayCompleted.innovation && 
                                 playerData.streak.todayCompleted.future;
            
            if (allCompleted) {
                const today = new Date().toDateString();
                const lastDate = playerData.streak.lastCompletedDate ? new Date(playerData.streak.lastCompletedDate).toDateString() : null;
                
                // Only increment if we haven't already counted today
                if (lastDate !== today) {
                    playerData.streak.current++;
                    playerData.streak.lastCompletedDate = new Date().toISOString();
                    
                    if (playerData.streak.current > playerData.streak.longest) {
                        playerData.streak.longest = playerData.streak.current;
                    }
                    
                    // Award bonus coins for streak milestones
                    if (playerData.streak.current % 7 === 0) {
                        const bonus = 100 * (playerData.streak.current / 7);
                        awardCoins(bonus, ` ${playerData.streak.current} day streak bonus!`);
                    }
                    
                    console.log(' Streak updated:', playerData.streak.current);
                    showSuccessMessage(` Streak: ${playerData.streak.current} days! Keep it up!`);
                    savePlayerData();
                }
            }
            
            updateStreakDisplay();
        }
        
        function updateStreakDisplay() {
            if (!playerData.streak) return;
            
            document.getElementById('current-streak').textContent = playerData.streak.current;
            document.getElementById('longest-streak').textContent = playerData.streak.longest;
            document.getElementById('streak-saves').textContent = playerData.streak.streakSaves;
            
            // Update today's progress icons
            const heritageIcon = document.getElementById('streak-heritage');
            const innovationIcon = document.getElementById('streak-innovation');
            const futureIcon = document.getElementById('streak-future');
            
            if (heritageIcon) heritageIcon.style.opacity = playerData.streak.todayCompleted.heritage ? '1' : '0.3';
            if (innovationIcon) innovationIcon.style.opacity = playerData.streak.todayCompleted.innovation ? '1' : '0.3';
            if (futureIcon) futureIcon.style.opacity = playerData.streak.todayCompleted.future ? '1' : '0.3';
        }
        
        function buyStreakSave() {
            playSound('click');
            
            const cost = 500;
            
            if (playerData.coins < cost) {
                playSound('error');
                showNotification(`Not enough coins! You need ${cost} coins to buy a Streak Save. You have: ${playerData.coins} coins`, 'error', 5000);
                return;
            }
            
            playerData.coins -= cost;
            playerData.streak.streakSaves++;
            
            updateCoinDisplay();
            updateStreakDisplay();
            savePlayerData();
            
            playSound('success');
            showSuccessMessage(` Streak Save purchased! You now have ${playerData.streak.streakSaves} saves.`);
        }
        
        function saveProgress() {
            if (!playerData.email) {
                showNotification('No player logged in!', 'error');
                return;
            }
            
            playerData.lastPlayed = new Date().toISOString();
            savePlayer(playerData.email, playerData);
            
            showNotification('Progress saved successfully!', 'success');
        }
        
        async function logoutPlayer() {
            console.log('Logout button clicked');
            playSound('click');
            
            if (confirm('Are you sure you want to logout? Make sure your progress is saved!')) {
                console.log('User confirmed logout');
                // Save before logout
                await savePlayerData();
                
                // Sign out from Firebase
                try {
                    await auth.signOut();
                    console.log('User logged out');
                } catch (error) {
                    console.error('Logout error:', error);
                }
                
                // Reset player data
                playerData = {
                    email: '',
                    name: '',
                    level: 'apprentice',
                    rank: 156,
                    totalScore: 0,
                    challenges: {
                        heritage: { best: 0, completed: false },
                        innovation: { best: 0, completed: false },
                        future: { best: 0, completed: false }
                    },
                    lastPlayed: null
                };
                
                // Return to login screen
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('registration').classList.add('active');
                
                // Clear form fields
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                
                showNotification('You have been logged out. See you next time!', 'info', 4000);
            }
        }
        
        // Avatar Builder - Full body customization
        let avatarData = {
            head: '',
            hair: '',
            top: '',
            bottom: '',
            shoes: '',
            accessory: '',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
        };
        
        // Shop items with prices and unlock status
        const shopItems = {
            heads: [
                { emoji: '', name: 'Happy', price: 0, locked: false },
                { emoji: '', name: 'Cool', price: 0, locked: false },
                { emoji: '', name: 'Nerd', price: 50, locked: true },
                { emoji: '', name: 'Angel', price: 100, locked: true },
                { emoji: '', name: 'Cowboy', price: 150, locked: true },
                { emoji: '', name: 'Party', price: 200, locked: true },
                { emoji: '', name: 'Robot', price: 300, locked: true },
                { emoji: '', name: 'Alien', price: 500, locked: true }
            ],
            hair: [
                { emoji: '', name: 'Curly', price: 0, locked: false },
                { emoji: '', name: 'Short', price: 0, locked: false },
                { emoji: '', name: 'Long', price: 50, locked: true },
                { emoji: '', name: 'Beard', price: 75, locked: true },
                { emoji: '', name: 'Red Hair', price: 100, locked: true },
                { emoji: '', name: 'Afro', price: 100, locked: true },
                { emoji: '', name: 'Gray', price: 150, locked: true },
                { emoji: '', name: 'Bald', price: 50, locked: true }
            ],
            tops: [
                { emoji: '', name: 'T-Shirt', price: 0, locked: false },
                { emoji: '', name: 'Tie', price: 50, locked: true },
                { emoji: '', name: 'Tank Top', price: 75, locked: true },
                { emoji: '', name: 'Lab Coat', price: 150, locked: true },
                { emoji: '', name: 'Safety Vest', price: 100, locked: true },
                { emoji: '', name: 'Dress', price: 200, locked: true },
                { emoji: '', name: 'Sari', price: 250, locked: true },
                { emoji: '', name: 'Tuxedo', price: 400, locked: true }
            ],
            bottoms: [
                { emoji: '', name: 'Jeans', price: 0, locked: false },
                { emoji: '', name: 'Shorts', price: 50, locked: true },
                { emoji: '', name: 'Skirt', price: 75, locked: true },
                { emoji: '', name: 'Swimsuit', price: 100, locked: true },
                { emoji: '', name: 'Athletic', price: 125, locked: true },
                { emoji: '', name: 'Kimono', price: 300, locked: true }
            ],
            shoes: [
                { emoji: '', name: 'Sneakers', price: 0, locked: false },
                { emoji: '', name: 'Dress Shoes', price: 50, locked: true },
                { emoji: '', name: 'Heels', price: 100, locked: true },
                { emoji: '', name: 'Boots', price: 150, locked: true },
                { emoji: '', name: 'Sandals', price: 75, locked: true },
                { emoji: '', name: 'High Boots', price: 200, locked: true }
            ],
            accessories: [
                { emoji: '', name: 'None', price: 0, locked: false },
                { emoji: '', name: 'Glasses', price: 0, locked: false },
                { emoji: '', name: 'Sunglasses', price: 100, locked: true },
                { emoji: '', name: 'Top Hat', price: 200, locked: true },
                { emoji: '', name: 'Crown', price: 500, locked: true },
                { emoji: '', name: 'Grad Cap', price: 150, locked: true },
                { emoji: '', name: 'Cap', price: 75, locked: true },
                { emoji: '', name: 'Helmet', price: 125, locked: true },
                { emoji: '', name: 'Bow', price: 100, locked: true },
                { emoji: '', name: 'Mask', price: 300, locked: true },
                { emoji: '', name: 'Army Helmet', price: 250, locked: true }
            ],
            backgrounds: [
                { value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', name: 'Purple Dream', price: 0, locked: false },
                { value: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', name: 'Pink Sunset', price: 100, locked: true },
                { value: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', name: 'Ocean Blue', price: 100, locked: true },
                { value: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', name: 'Mint Fresh', price: 150, locked: true },
                { value: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', name: 'Sunrise', price: 150, locked: true },
                { value: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)', name: 'Deep Space', price: 200, locked: true },
                { value: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', name: 'Cotton Candy', price: 200, locked: true },
                { value: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', name: 'Lavender', price: 250, locked: true },
                { value: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', name: 'Peach', price: 250, locked: true },
                { value: 'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)', name: 'Coral Reef', price: 300, locked: true },
                { value: 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)', name: 'Sky Dream', price: 300, locked: true },
                { value: 'linear-gradient(135deg, #f77062 0%, #fe5196 100%)', name: 'Fire', price: 400, locked: true }
            ]
        };
        
        function openAvatarBuilder() {
            playSound('click');
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('avatar-builder').classList.add('active');
            
            // Load saved avatar
            if (playerData.avatar) {
                avatarData = { ...playerData.avatar };
            }
            
            updateAvatarPreview();
            
            // Add event listeners to avatar options
            document.querySelectorAll('.avatar-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const value = this.getAttribute('data-value');
                    
                    playSound('click');
                    
                    // Remove selected class from siblings
                    this.parentElement.querySelectorAll('.avatar-option').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // Update avatar data
                    if (type === 'background') {
                        avatarData.background = value;
                    } else {
                        avatarData[type] = value;
                    }
                    updateAvatarPreview();
                });
            });
        }
        
        function closeAvatarBuilder() {
            playSound('click');
            document.getElementById('avatar-builder').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
        }
        
        function updateAvatarPreview() {
            const preview = document.getElementById('avatar-preview');
            const display = document.getElementById('avatar-display');
            
            // Fix: Apply background to preview container
            preview.style.background = avatarData.background || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            preview.style.borderRadius = '20px';
            preview.style.padding = '2rem';
            
            if (avatarData.accessory) {
                display.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <div>${avatarData.skin}</div>
                        <div style="position: absolute; top: -40px; left: 50%; transform: translateX(-50%); font-size: 80px;">
                            ${avatarData.accessory}
                        </div>
                    </div>
                `;
            } else {
                display.innerHTML = avatarData.skin;
            }
        }
        

        
        // Simple preset avatars - user has full control
        function applyPreset(presetName) {
            playSound('click');
            
            const presets = {
                classic: {
                    skin: '',
                    accessory: '',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                },
                cool: {
                    skin: '',
                    accessory: '',
                    background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
                },
                royal: {
                    skin: '',
                    accessory: '',
                    background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
                },
                scholar: {
                    skin: '',
                    accessory: '',
                    background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
                },
                casual: {
                    skin: '',
                    accessory: '',
                    background: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)'
                }
            };
            
            if (presets[presetName]) {
                avatarData = { ...presets[presetName] };
                updateAvatarPreview();
                
                // Highlight selected options
                document.querySelectorAll('.avatar-option').forEach(btn => {
                    const type = btn.getAttribute('data-type');
                    const value = btn.getAttribute('data-value');
                    if (avatarData[type] === value || (type === 'background' && avatarData.background === value)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
        }
        
        function saveAvatar() {
            playSound('success');
            playerData.avatar = { ...avatarData };
            autoSaveProgress();
            showNotification('Avatar saved successfully!', 'success');
            
            // Update dashboard avatar display
            updateDashboardAvatar();
        }
        
        function updateDashboardAvatar() {
            // Add avatar to welcome message if it exists
            if (playerData.avatar) {
                const welcomeText = document.getElementById('welcome-text');
                const avatarDisplay = playerData.avatar.accessory 
                    ? `${playerData.avatar.skin}${playerData.avatar.accessory}` 
                    : playerData.avatar.skin;
                welcomeText.innerHTML = `${avatarDisplay} Welcome, ${playerData.name}!`;
            }
        }
        
        // Settings Functions
        // Start Challenge
        function startChallenge(type) {
            playSound('click');
            currentChallenge = type;
            
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById(`${type}-challenge`).classList.add('active');
            
            // Start appropriate challenge
            if (type === 'heritage') {
                initHeritageChallenge();
            } else if (type === 'innovation') {
                initInnovationChallenge();
            } else if (type === 'future') {
                initFutureChallenge();
            }
        }
        
        // Update player rank from database
        async function updatePlayerRank() {
            try {
                const { data: allPlayers, error } = await supabaseClient
                    .from('players')
                    .select('email, total_score')
                    .order('total_score', { ascending: false });
                
                if (error) throw error;
                
                if (allPlayers && allPlayers.length > 0) {
                    const rank = allPlayers.findIndex(p => p.email === playerData.email) + 1;
                    if (rank > 0) {
                        playerData.rank = rank;
                        document.getElementById('player-rank').textContent = `#${rank}`;
                    }
                }
            } catch (error) {
                console.error('Error updating rank:', error);
                // Fallback to stored rank
                document.getElementById('player-rank').textContent = `#${playerData.rank}`;
            }
        }
        
        // Leaderboard Functions
        async function openLeaderboard() {
            playSound('click');
            
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('leaderboard').classList.add('active');
            
            await loadLeaderboard();
        }
        
        function closeLeaderboard() {
            playSound('click');
            document.getElementById('leaderboard').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
        }
        
        async function loadLeaderboard() {
            try {
                // Get start of current week (Monday)
                const now = new Date();
                const dayOfWeek = now.getDay();
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Adjust to Monday
                const monday = new Date(now);
                monday.setDate(now.getDate() + diff);
                monday.setHours(0, 0, 0, 0);
                
                console.log('Loading leaderboard for week starting:', monday);
                
                // Get all players and their weekly scores
                const { data: allPlayers, error } = await supabaseClient
                    .from('players')
                    .select('name, total_score, email, last_played')
                    .order('total_score', { ascending: false });
                
                if (error) throw error;
                
                if (!allPlayers || allPlayers.length === 0) {
                    document.getElementById('leaderboard-list').innerHTML = `
                        <div style="text-align: center; color: #a0a0a0; padding: 2rem;">
                            No players found. Be the first to play!
                        </div>
                    `;
                    return;
                }
                
                // Find current player's rank
                const currentPlayerEmail = playerData.email;
                let playerRank = allPlayers.findIndex(p => p.email === currentPlayerEmail) + 1;
                
                if (playerRank === 0) playerRank = allPlayers.length;
                
                // Update player's rank display
                document.getElementById('leaderboard-your-rank').textContent = `#${playerRank}`;
                document.getElementById('leaderboard-your-score').textContent = playerData.totalScore;
                
                // Get players to display (5 above, current, 5 below)
                const startIndex = Math.max(0, playerRank - 6);
                const endIndex = Math.min(allPlayers.length, playerRank + 5);
                const playersToShow = allPlayers.slice(startIndex, endIndex);
                
                // Build leaderboard HTML
                let leaderboardHTML = '';
                
                playersToShow.forEach((player, index) => {
                    const actualRank = startIndex + index + 1;
                    const isCurrentPlayer = player.email === currentPlayerEmail;
                    
                    // Medal for top 3
                    let rankDisplay = `#${actualRank}`;
                    if (actualRank === 1) rankDisplay = '';
                    else if (actualRank === 2) rankDisplay = '';
                    else if (actualRank === 3) rankDisplay = '';
                    
                    const bgColor = isCurrentPlayer ? 'rgba(0, 212, 255, 0.3)' : 'rgba(255, 255, 255, 0.05)';
                    const borderColor = isCurrentPlayer ? 'rgba(0, 212, 255, 0.6)' : 'rgba(255, 255, 255, 0.1)';
                    
                    leaderboardHTML += `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1rem;
                            margin: 0.5rem 0;
                            background: ${bgColor};
                            border: 2px solid ${borderColor};
                            border-radius: 10px;
                            transition: all 0.3s ease;
                        ">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <div style="font-size: 1.5rem; font-weight: 700; min-width: 50px; text-align: center;">
                                    ${rankDisplay}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: ${isCurrentPlayer ? '#00d4ff' : '#fff'};">
                                        ${player.name} ${isCurrentPlayer ? '(You)' : ''}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a0a0a0;">
                                        Last played: ${formatTimeAgo(player.last_played)}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: #ffd700;">
                                    ${player.total_score}
                                </div>
                                <div style="font-size: 0.8rem; color: #a0a0a0;">
                                    points
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('leaderboard-list').innerHTML = leaderboardHTML;
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboard-list').innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 2rem;">
                        Failed to load leaderboard. Please try again.
                    </div>
                `;
            }
        }
        
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Never';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            if (diffMins > 0) return `${diffMins}m ago`;
            return 'Just now';
        }
        
        function openSettings() {
            console.log('Opening settings...');
            
            try {
                const dashboard = document.getElementById('dashboard');
                const settings = document.getElementById('settings');
                
                console.log('Dashboard element:', dashboard);
                console.log('Settings element:', settings);
                
                if (!dashboard || !settings) {
                    console.error('Dashboard or Settings element not found!');
                    showNotification('Error: Settings page not found. Please refresh the page.', 'error');
                    return;
                }
                
                dashboard.classList.remove('active');
                settings.classList.add('active');
                
                console.log('Screen switched to settings');
                
                // Load current settings
                const emailInput = document.getElementById('settings-email');
                const nameInput = document.getElementById('settings-name');
                const levelSelect = document.getElementById('settings-level');
                
                if (emailInput) emailInput.value = playerData.email;
                if (nameInput) nameInput.value = playerData.name;
                if (levelSelect) levelSelect.value = playerData.level;
                
                // Load game settings from localStorage
                const gameSettings = getGameSettings();
                
                const soundCheck = document.getElementById('settings-sound');
                const musicCheck = document.getElementById('settings-music');
                const musicThemeSelect = document.getElementById('settings-music-theme');
                const autosaveCheck = document.getElementById('settings-autosave');
                
                if (soundCheck) soundCheck.checked = gameSettings.sound !== false;
                if (musicCheck) musicCheck.checked = gameSettings.music !== false;
                if (musicThemeSelect) musicThemeSelect.value = gameSettings.musicTheme || 'ambient';
                if (autosaveCheck) autosaveCheck.checked = gameSettings.autosave !== false;
                
                // Load statistics
                loadStatistics();
                
                console.log('Settings loaded successfully');
            } catch (error) {
                console.error('Error opening settings:', error);
                showNotification('Error opening settings: ' + error.message, 'error');
            }
        }
        
        function closeSettings() {
            document.getElementById('settings').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            
            // Clear password fields
            document.getElementById('settings-current-password').value = '';
            document.getElementById('settings-new-password').value = '';
            document.getElementById('settings-confirm-password').value = '';
        }
        
        function updateAccountSettings() {
            const newName = document.getElementById('settings-name').value.trim();
            const newLevel = document.getElementById('settings-level').value;
            
            if (!newName) {
                showNotification('Player name cannot be empty!', 'error');
                return;
            }
            
            const oldLevel = playerData.level;
            
            playerData.name = newName;
            playerData.level = newLevel;
            
            autoSaveProgress();
            
            if (oldLevel !== newLevel) {
                showNotification(`Account updated! Difficulty changed to ${newLevel}. Your next challenges will use this difficulty level.`, 'success', 6000);
            } else {
                showNotification('Account settings updated successfully!', 'success');
            }
            
            refreshDashboardStats();
        }
        
        function updateGameSettings() {
            const gameSettings = {
                sound: document.getElementById('settings-sound').checked,
                music: document.getElementById('settings-music').checked,
                musicTheme: document.getElementById('settings-music-theme').value,
                autosave: document.getElementById('settings-autosave').checked
            };
            
            localStorage.setItem('chronoweave_game_settings', JSON.stringify(gameSettings));
            
            // Restart background music with new theme
            stopBackgroundMusic();
            if (gameSettings.music) {
                startBackgroundMusic();
            }
            
            playSound('success');
            showNotification(`Game settings saved! Music theme: ${musicThemes[gameSettings.musicTheme].name}`, 'success');
        }
        
        async function changePassword() {
            playSound('click');
            
            const currentPassword = document.getElementById('settings-current-password').value;
            const newPassword = document.getElementById('settings-new-password').value;
            const confirmPassword = document.getElementById('settings-confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                playSound('error');
                showNotification('Please fill in all password fields!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                playSound('error');
                showNotification('New password must be at least 6 characters long!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                playSound('error');
                showNotification('New passwords do not match!', 'error');
                return;
            }
            
            // Show confirmation notification
            showNotification('Changing password...', 'info', 2000);
            
            try {
                console.log(' Attempting to change password...');
                
                // Update password in Supabase (this will send a confirmation email if email confirmation is enabled)
                const { error: updateError } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });
                
                if (updateError) {
                    throw updateError;
                }
                
                // Clear fields
                document.getElementById('settings-current-password').value = '';
                document.getElementById('settings-new-password').value = '';
                document.getElementById('settings-confirm-password').value = '';
                
                playSound('success');
                showNotification('Password changed successfully! You can now use your new password to log in.', 'success', 5000);
                
                console.log(' Password changed successfully');
                
            } catch (error) {
                console.error(' Password change error:', error);
                playSound('error');
                
                let errorMessage = 'Failed to change password.';
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'Current password is incorrect!';
                } else if (error.message.includes('Password should be at least')) {
                    errorMessage = 'Password must be at least 6 characters long!';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        }
        
        function validatePasswordFields() {
            const newPassword = document.getElementById('settings-new-password').value;
            const confirmPassword = document.getElementById('settings-confirm-password').value;
            const indicator = document.getElementById('password-match-indicator');
            const changeBtn = document.getElementById('change-password-btn');
            
            if (!newPassword || !confirmPassword) {
                indicator.textContent = '';
                return;
            }
            
            if (newPassword.length < 6) {
                indicator.innerHTML = ' Password must be at least 6 characters';
                indicator.style.color = '#ff6b6b';
                if (changeBtn) changeBtn.disabled = true;
                return;
            }
            
            if (newPassword === confirmPassword) {
                indicator.innerHTML = ' Passwords match';
                indicator.style.color = '#4caf50';
                if (changeBtn) changeBtn.disabled = false;
            } else {
                indicator.innerHTML = ' Passwords do not match';
                indicator.style.color = '#ff6b6b';
                if (changeBtn) changeBtn.disabled = true;
            }
        }
        
        function loadStatistics() {
            // Account created date
            if (playerData.createdAt) {
                const created = new Date(playerData.createdAt);
                document.getElementById('stats-created').textContent = created.toLocaleDateString();
            }
            
            // Total playtime (estimate based on challenges completed)
            const completed = Object.values(playerData.challenges).filter(c => c.completed).length;
            const estimatedMinutes = completed * 5; // Rough estimate
            document.getElementById('stats-playtime').textContent = `~${estimatedMinutes} min`;
            
            // Challenges completed
            document.getElementById('stats-completed').textContent = `${completed}/3`;
            
            // Highest score
            const highestScore = Math.max(
                playerData.challenges.heritage.best,
                playerData.challenges.innovation.best,
                playerData.challenges.future.best
            );
            document.getElementById('stats-highest').textContent = highestScore;
        }
        
        function resetProgress() {
            if (!confirm(' Are you sure you want to reset ALL your progress?\n\nThis will:\n- Reset all scores to 0\n- Reset your rank\n- Mark all challenges as incomplete\n\nYour account will remain active.\n\nThis cannot be undone!')) {
                return;
            }
            
            if (!confirm('Final confirmation: Reset all progress?')) {
                return;
            }
            
            // Reset progress but keep account info
            playerData.rank = Math.floor(Math.random() * 500) + 50;
            playerData.totalScore = 0;
            playerData.challenges = {
                heritage: { best: 0, completed: false },
                innovation: { best: 0, completed: false },
                future: { best: 0, completed: false }
            };
            
            autoSaveProgress();
            refreshDashboardStats();
            
            showNotification('All progress has been reset. Good luck on your new journey!', 'info', 5000);
            closeSettings();
        }
        
        function deleteAccount() {
            if (!confirm(' DANGER: Delete your account permanently?\n\nThis will:\n- Delete ALL your data\n- Remove your account completely\n- Cannot be recovered\n\nAre you absolutely sure?')) {
                return;
            }
            
            const confirmEmail = prompt('Type your email address to confirm deletion:');
            
            if (confirmEmail !== playerData.email) {
                showNotification('Email does not match. Account deletion cancelled.', 'warning');
                return;
            }
            
            // Delete from localStorage
            const players = getAllPlayers();
            delete players[playerData.email];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
            clearCurrentUser();
            
            // Reset player data
            playerData = {
                email: '',
                name: '',
                level: 'apprentice',
                rank: 156,
                totalScore: 0,
                challenges: {
                    heritage: { best: 0, completed: false },
                    innovation: { best: 0, completed: false },
                    future: { best: 0, completed: false }
                },
                lastPlayed: null
            };
            
            // Return to login
            document.getElementById('settings').classList.remove('active');
            document.getElementById('registration').classList.add('active');
            
            showNotification('Your account has been permanently deleted. Thank you for playing Chronoweave!', 'info', 6000);
        }
        
        function returnToDashboard() {
            if (challengeTimer) {
                clearInterval(challengeTimer);
                challengeTimer = null;
            }
            
            // Auto-save when returning to dashboard
            autoSaveProgress();
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            currentChallenge = null;
            
            // Refresh all dashboard stats
            refreshDashboardStats();
        }
        
        // Refresh dashboard statistics
        function refreshDashboardStats() {
            document.getElementById('player-rank').textContent = `#${playerData.rank}`;
            document.getElementById('total-score').textContent = playerData.totalScore;
            document.getElementById('player-level').textContent = playerData.level.charAt(0).toUpperCase() + playerData.level.slice(1);
            updateChallengeStats();
            updateCoinDisplay();
            updateStreakIcons();
            
            // Update streak numbers
            if (playerData.streak) {
                document.getElementById('current-streak').textContent = playerData.streak.current || 0;
                document.getElementById('longest-streak').textContent = playerData.streak.longest || 0;
                document.getElementById('streak-saves').textContent = playerData.streak.streakSaves || 0;
            }
        }
        
        // Auto-save function with visual feedback
        async function autoSaveProgress() {
            if (currentUser && playerData) {
                playerData.lastPlayed = new Date().toISOString();
                await savePlayerData();
                console.log(' Progress auto-saved at', new Date().toLocaleTimeString());
                
                // Show visual feedback
                showSaveNotification();
            }
        }
        
        // Show save notification
        // Enhanced Notification System
        let notificationContainer = null;
        let notificationQueue = [];
        let isShowingNotification = false;
        
        function createNotificationContainer() {
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    pointer-events: none;
                `;
                document.body.appendChild(notificationContainer);
            }
        }
        
        function showNotification(message, type = 'info', duration = 4000) {
            createNotificationContainer();
            
            const notification = document.createElement('div');
            notification.className = 'game-notification';
            
            // Set colors and icons based on type
            let backgroundColor, icon, textColor = '#fff';
            switch (type) {
                case 'success':
                    backgroundColor = 'rgba(76, 175, 80, 0.95)';
                    icon = '';
                    break;
                case 'error':
                    backgroundColor = 'rgba(244, 67, 54, 0.95)';
                    icon = '';
                    break;
                case 'warning':
                    backgroundColor = 'rgba(255, 152, 0, 0.95)';
                    icon = '';
                    break;
                case 'info':
                default:
                    backgroundColor = 'rgba(33, 150, 243, 0.95)';
                    icon = '';
                    break;
            }
            
            notification.style.cssText = `
                background: ${backgroundColor};
                color: ${textColor};
                padding: 1rem 1.5rem;
                border-radius: 12px;
                font-family: 'Orbitron', monospace;
                font-weight: 600;
                font-size: 0.95rem;
                margin-bottom: 10px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                transform: translateX(100%);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                pointer-events: auto;
                cursor: pointer;
                max-width: 350px;
                word-wrap: break-word;
            `;
            
            notification.innerHTML = `${icon} ${message}`;
            
            // Add click to dismiss
            notification.addEventListener('click', () => {
                dismissNotification(notification);
            });
            
            notificationContainer.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Auto dismiss
            setTimeout(() => {
                dismissNotification(notification);
            }, duration);
        }
        
        function dismissNotification(notification) {
            if (notification && notification.parentNode) {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }
        }
        
        function showSaveNotification() {
            showNotification('Progress Saved', 'success', 2000);
        }
        
        // Update player score and streak
        function updatePlayerScore(score, challengeType) {
            // Update total score
            playerData.totalScore += score;
            
            // Update best score for this challenge
            if (score > playerData.challenges[challengeType].best) {
                playerData.challenges[challengeType].best = score;
            }
            
            // Mark challenge as completed
            playerData.challenges[challengeType].completed = true;
            
            // Update streak
            updateStreak(challengeType);
            
            // Update UI
            updateChallengeStats();
            refreshDashboardStats();
        }
        
        // Update streak system
        function updateStreak(challengeType) {
            console.log('=== UPDATE STREAK ===');
            console.log('Challenge type:', challengeType);
            console.log('Current streak data:', playerData.streak);
            
            const today = new Date().toDateString();
            console.log('Today:', today);
            
            // Mark today's challenge as completed
            playerData.streak.todayCompleted[challengeType] = true;
            console.log('Marked as completed:', challengeType);
            console.log('Today completed:', playerData.streak.todayCompleted);
            
            // Update streak icon
            const iconElement = document.getElementById(`streak-${challengeType}`);
            console.log('Icon element:', iconElement);
            if (iconElement) {
                iconElement.style.opacity = '1';
                iconElement.style.transform = 'scale(1.2)';
                iconElement.style.filter = 'drop-shadow(0 0 10px rgba(255, 215, 0, 0.8))';
                console.log(' Icon updated');
            } else {
                console.error(' Icon element not found!');
            }
            
            // Check if all challenges completed today
            const allCompleted = playerData.streak.todayCompleted.heritage && 
                                 playerData.streak.todayCompleted.innovation && 
                                 playerData.streak.todayCompleted.future;
            console.log('All completed?', allCompleted);
            console.log('Heritage:', playerData.streak.todayCompleted.heritage);
            console.log('Innovation:', playerData.streak.todayCompleted.innovation);
            console.log('Future:', playerData.streak.todayCompleted.future);
            
            if (allCompleted) {
                // Check if this is a new day
                console.log('Last completed date:', playerData.streak.lastCompletedDate);
                console.log('Today:', today);
                console.log('Are they different?', playerData.streak.lastCompletedDate !== today);
                
                if (playerData.streak.lastCompletedDate !== today) {
                    playerData.streak.current++;
                    playerData.streak.lastCompletedDate = today;
                    
                    // Update longest streak
                    if (playerData.streak.current > playerData.streak.longest) {
                        playerData.streak.longest = playerData.streak.current;
                    }
                    
                    console.log(' Streak increased to:', playerData.streak.current);
                    
                    // Save immediately
                    autoSaveProgress();
                    
                    // Show streak notification with more details
                    playSound('success');
                    setTimeout(() => {
                        showNotification(` DAILY STREAK COMPLETE! All 3 challenges completed today! Current Streak: ${playerData.streak.current} day${playerData.streak.current > 1 ? 's' : ''}, Longest: ${playerData.streak.longest} day${playerData.streak.longest > 1 ? 's' : ''}. Keep it up! `, 'success', 8000);
                    }, 500);
                } else {
                    console.log(' All challenges already completed today');
                }
            } else {
                console.log(' Not all challenges completed yet');
                const remaining = [];
                if (!playerData.streak.todayCompleted.heritage) remaining.push('Heritage');
                if (!playerData.streak.todayCompleted.innovation) remaining.push('Innovation');
                if (!playerData.streak.todayCompleted.future) remaining.push('Engineering');
                console.log('Remaining challenges:', remaining.join(', '));
            }
            
            // Update streak display
            document.getElementById('current-streak').textContent = playerData.streak.current;
            document.getElementById('longest-streak').textContent = playerData.streak.longest;
            document.getElementById('streak-saves').textContent = playerData.streak.streakSaves || 0;
            
            console.log('=== STREAK UPDATE COMPLETE ===');
        }
        
        // Check and update streak icons on dashboard load
        function updateStreakIcons() {
            const icons = {
                heritage: document.getElementById('streak-heritage'),
                innovation: document.getElementById('streak-innovation'),
                future: document.getElementById('streak-future')
            };
            
            // Update each icon based on completion status
            Object.keys(icons).forEach(type => {
                const icon = icons[type];
                if (icon && playerData.streak && playerData.streak.todayCompleted) {
                    if (playerData.streak.todayCompleted[type]) {
                        icon.style.opacity = '1';
                        icon.style.transform = 'scale(1.2)';
                        icon.style.filter = 'drop-shadow(0 0 10px rgba(255, 215, 0, 0.8))';
                    } else {
                        icon.style.opacity = '0.3';
                        icon.style.transform = 'scale(1)';
                        icon.style.filter = 'none';
                    }
                }
            });
        }
        
        // TEST FUNCTION - Call from console to test streak
        window.testStreak = function(challengeType) {
            console.log(' TESTING STREAK FOR:', challengeType);
            updatePlayerScore(100, challengeType);
        };
        
        // TEST FUNCTION - Reset today's completions
        window.resetTodayCompletions = function() {
            console.log(' Resetting today\'s completions');
            playerData.streak.todayCompleted = {
                heritage: false,
                innovation: false,
                future: false
            };
            updateStreakIcons();
            autoSaveProgress();
            console.log(' Reset complete');
        };
        
        // Challenge Management - removed function, using event listeners only
        
        let timerElements = {};
        function startTimer(type, seconds) {
            // Clear existing timer
            if (challengeTimer) {
                clearInterval(challengeTimer);
            }
            
            let timeLeft = seconds;
            let lastTickTime = 0;
            
            // Cache timer element
            if (!timerElements[type]) {
                timerElements[type] = document.getElementById(`${type}-timer`);
            }
            
            const updateTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                const timerEl = timerElements[type];
                
                if (timerEl) {
                    timerEl.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
                }
                
                // Play tick sound when time is running low (throttled)
                if (timeLeft <= 10 && timeLeft > 0 && timeLeft !== lastTickTime) {
                    playSound('tick');
                    lastTickTime = timeLeft;
                }
                
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(challengeTimer);
                    
                    // Special handling for heritage speed run
                    if (type === 'heritage') {
                        endHeritageSpeedRun();
                    } else {
                        playSound('error');
                        showNotification(`Time's up! ${getDifficultyMessage()}`, 'warning', 5000);
                        returnToDashboard();
                    }
                }
            };
            
            updateTimer(); // Update immediately
            challengeTimer = setInterval(updateTimer, 1000);
        }
        
        function endHeritageSpeedRun() {
            playSound('complete');
            
            // Calculate coins based on performance
            const coinsEarned = Math.floor(heritageSpeedRun.totalScore / 3) + 25;
            awardCoins(coinsEarned, `Pattern Speed Run completed!`);
            
            // Update player score
            updatePlayerScore(heritageSpeedRun.totalScore, 'heritage');
            
            // Show results
            showNotification(` Speed Run Complete! Patterns: ${heritageSpeedRun.patternsCompleted}, Score: ${heritageSpeedRun.totalScore}, Average: ${heritageSpeedRun.patternsCompleted > 0 ? Math.floor(heritageSpeedRun.totalScore / heritageSpeedRun.patternsCompleted) : 0}, Coins Earned: ${coinsEarned} `, 'success', 6000);
            
            // Show historical summary
            showHistoricalSummary();
            
            autoSaveProgress();
            returnToDashboard();
        }
        
        function getDifficultyMessage() {
            const messages = {
                apprentice: "Don't worry, practice makes perfect!",
                artisan: "Good effort! Try again to improve your score.",
                master: "Master level is challenging - every second counts!"
            };
            return messages[playerData.level];
        }
        
        // Heritage Challenge with Video
        function initHeritageChallenge() {
            // Show video first
            document.getElementById('heritage-video').style.display = 'block';
            document.getElementById('heritage-game').style.display = 'none';
            
            // Start video sequence
            startHeritageVideo();
        }
        
        function startHeritageVideo() {
            // Clear any existing timer
            if (heritageVideoTimer) {
                clearInterval(heritageVideoTimer);
            }
            
            let timeLeft = 20;
            heritageSceneIndex = 1;
            heritageVideoPaused = false;
            
            const timerElement = document.getElementById('heritage-video-timer');
            const progressElement = document.getElementById('heritage-video-progress');
            
            console.log('Starting heritage video...');
            
            if (!timerElement || !progressElement) {
                console.error('Video elements not found!');
                return;
            }
            
            // Use requestAnimationFrame for smoother updates
            let lastUpdate = Date.now();
            
            function updateVideo() {
                if (heritageVideoPaused) {
                    heritageVideoTimer = requestAnimationFrame(updateVideo);
                    return;
                }
                
                const now = Date.now();
                if (now - lastUpdate >= 1000) {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    const progress = ((20 - timeLeft) / 20) * 100;
                    progressElement.style.width = progress + '%';
                    
                    // Change scenes every 6.6 seconds (3 scenes in 20 seconds)
                    const sceneTime = Math.floor((20 - timeLeft) / 6.6) + 1;
                    if (sceneTime !== heritageSceneIndex && sceneTime <= 3) {
                        changeHeritageScene(sceneTime);
                    }
                    
                    timeLeft--;
                    lastUpdate = now;
                    
                    if (timeLeft < 0) {
                        startHeritageChallenge();
                        return;
                    }
                }
                
                heritageVideoTimer = requestAnimationFrame(updateVideo);
            }
            
            heritageVideoTimer = requestAnimationFrame(updateVideo);
        }
        
        function changeHeritageScene(sceneNumber) {
            document.getElementById(`heritage-scene-${heritageSceneIndex}`).classList.remove('active');
            heritageSceneIndex = sceneNumber;
            document.getElementById(`heritage-scene-${heritageSceneIndex}`).classList.add('active');
        }
        
        let savedHeritageTime = 0;
        
        function previousHeritageScene() {
            console.log(' Previous button clicked!');
            console.log('Current scene:', heritageSceneIndex);
            playSound('click');
            if (heritageSceneIndex > 1) {
                const currentScene = document.getElementById(`heritage-scene-${heritageSceneIndex}`);
                if (currentScene) currentScene.classList.remove('active');
                heritageSceneIndex--;
                const prevScene = document.getElementById(`heritage-scene-${heritageSceneIndex}`);
                if (prevScene) prevScene.classList.add('active');
                console.log('Moved to scene:', heritageSceneIndex);
            } else {
                console.log('Already at first scene');
            }
        }
        
        function nextHeritageScene() {
            console.log('Next clicked, current scene:', heritageSceneIndex);
            playSound('click');
            if (heritageSceneIndex < 3) {
                const currentScene = document.getElementById(`heritage-scene-${heritageSceneIndex}`);
                if (currentScene) currentScene.classList.remove('active');
                heritageSceneIndex++;
                const nextScene = document.getElementById(`heritage-scene-${heritageSceneIndex}`);
                if (nextScene) nextScene.classList.add('active');
                console.log('Moved to scene:', heritageSceneIndex);
            } else {
                console.log('Already at last scene');
            }
        }
        
        function pauseHeritageVideo() {
            console.log('Pause clicked, currently paused:', heritageVideoPaused);
            playSound('click');
            const pauseBtn = document.getElementById('heritage-pause-btn');
            if (!pauseBtn) {
                console.error('Pause button not found!');
                return;
            }
            
            if (heritageVideoPaused) {
                // Resume
                heritageVideoPaused = false;
                pauseBtn.textContent = ' Pause';
                console.log('Video resumed');
            } else {
                // Pause
                heritageVideoPaused = true;
                pauseBtn.textContent = ' Resume';
                console.log('Video paused');
            }
        }
        
        function skipHeritageVideo() {
            if (heritageVideoTimer) {
                clearInterval(heritageVideoTimer);
            }
            startHeritageChallenge();
        }
        
        function startHeritageChallenge() {
            console.log(' Start Challenge button clicked!');
            document.getElementById('heritage-video').style.display = 'none';
            document.getElementById('heritage-game').style.display = 'block';
            
            // Initialize speed run state
            heritageSpeedRun = {
                patternsCompleted: 0,
                totalScore: 0,
                usedPatterns: []
            };
            
            // Start the timer NOW (when video ends)
            const timers = {
                apprentice: { heritage: 60, innovation: 240, future: 480 },
                artisan: { heritage: 60, innovation: 180, future: 360 },
                master: { heritage: 60, innovation: 120, future: 300 }
            };
            startTimer('heritage', timers[playerData.level].heritage);
            
            // Load first pattern
            loadNextPattern();
        }
        
        function loadNextPattern() {
            // Get available patterns for current level
            const levelPatterns = heritagePatterns[playerData.level];
            let availablePatterns = levelPatterns.filter((p, i) => !heritageSpeedRun.usedPatterns.includes(i));
            
            // If all patterns used, reset but keep the last pattern to avoid immediate repetition
            if (availablePatterns.length === 0) {
                const lastPatternIndex = heritageSpeedRun.usedPatterns[heritageSpeedRun.usedPatterns.length - 1];
                heritageSpeedRun.usedPatterns = [];
                
                // If there are multiple patterns, exclude the last one to prevent immediate repetition
                if (levelPatterns.length > 1) {
                    heritageSpeedRun.usedPatterns.push(lastPatternIndex);
                    availablePatterns = levelPatterns.filter((p, i) => i !== lastPatternIndex);
                } else {
                    availablePatterns = levelPatterns;
                }
            }
            
            // Pick random pattern from available ones
            const randomIndex = Math.floor(Math.random() * availablePatterns.length);
            currentPattern = availablePatterns[randomIndex];
            const patternIndex = levelPatterns.indexOf(currentPattern);
            heritageSpeedRun.usedPatterns.push(patternIndex);
            
            // Reset player pattern
            playerPattern = [];
            
            // Cache DOM elements for better performance
            const patternNameEl = document.getElementById('pattern-name');
            const patternPointsEl = document.getElementById('pattern-points');
            const patternProgressEl = document.getElementById('pattern-progress');
            
            // Update UI efficiently
            if (patternNameEl) patternNameEl.textContent = currentPattern.name;
            if (patternPointsEl) patternPointsEl.textContent = currentPattern.points;
            
            // Update pattern info with historical context
            updatePatternInfo(currentPattern);
            
            // Update speed run stats
            updateSpeedRunStats();
            
            // Create grids
            createTargetGrid();
            createPlayerGrid();
            updatePatternProgress();
            
            // Show pattern info notification with historical context
            showNotification(`${currentPattern.name} (${currentPattern.culture}, ${currentPattern.period})`, 'info', 4000);
        }
        
        function updateSpeedRunStats() {
            const patternsCompletedEl = document.getElementById('patterns-completed');
            const totalScoreEl = document.getElementById('total-speedrun-score');
            
            if (patternsCompletedEl) patternsCompletedEl.textContent = heritageSpeedRun.patternsCompleted;
            if (totalScoreEl) totalScoreEl.textContent = heritageSpeedRun.totalScore;
            
            // Show pattern progress info
            const totalPatterns = heritagePatterns[playerData.level].length;
            const remainingPatterns = totalPatterns - heritageSpeedRun.usedPatterns.length;
            
            console.log(` Pattern Progress: ${heritageSpeedRun.usedPatterns.length}/${totalPatterns} used, ${remainingPatterns} remaining`);
        }
        
        function updatePatternInfo(pattern) {
            // Update pattern information display
            const patternInfo = document.querySelector('.pattern-info');
            if (patternInfo) {
                // Update the existing pattern info structure
                const progressP = patternInfo.querySelector('p:first-of-type');
                if (progressP) {
                    progressP.innerHTML = `<strong>Points:</strong> <span id="pattern-points">${pattern.points}</span> | <strong>Progress:</strong> <span id="pattern-progress">0/${pattern.pattern.length}</span>`;
                }
                
                // Add or update historical information
                let historyP = patternInfo.querySelector('.pattern-history');
                if (!historyP) {
                    historyP = document.createElement('p');
                    historyP.className = 'pattern-history';
                    historyP.style.cssText = `
                        color: #a0a0a0; 
                        font-size: 0.85rem; 
                        margin-top: 1rem; 
                        line-height: 1.4;
                        background: rgba(255,255,255,0.05);
                        padding: 0.8rem;
                        border-radius: 8px;
                        border-left: 3px solid #00d4ff;
                    `;
                    patternInfo.appendChild(historyP);
                }
                
                historyP.innerHTML = `
                    <strong style="color: #00d4ff;"> ${pattern.culture} (${pattern.period})</strong><br>
                    ${pattern.history}
                `;
            }
            
            console.log(` Historical Pattern: ${pattern.name} from ${pattern.culture} (${pattern.period})`);
        }
        
        function showHistoricalAchievement(pattern, isPerfect = true) {
            const achievementType = isPerfect ? 'mastered' : 'learned';
            const message = ` You ${achievementType} the ${pattern.name}! This ancient pattern from ${pattern.culture} (${pattern.period}) represents a significant piece of textile history.`;
            
            showNotification(message, isPerfect ? 'success' : 'info', 6000);
            
            // Log detailed historical information
            console.log(` Historical Achievement: ${pattern.name}`);
            console.log(` Culture: ${pattern.culture}`);
            console.log(` Period: ${pattern.period}`);
            console.log(` History: ${pattern.history}`);
        }
        
        function showHistoricalSummary() {
            const levelPatterns = heritagePatterns[playerData.level];
            const completedPatterns = heritageSpeedRun.usedPatterns.map(index => levelPatterns[index]);
            
            if (completedPatterns.length > 0) {
                const cultures = [...new Set(completedPatterns.map(p => p.culture))];
                const periods = completedPatterns.map(p => p.period).join(', ');
                
                const summaryMessage = ` Heritage Journey Complete! You explored ${completedPatterns.length} ancient patterns from ${cultures.length} different cultures: ${cultures.join(', ')}. Each pattern carries thousands of years of human creativity and cultural significance.`;
                
                setTimeout(() => {
                    showNotification(summaryMessage, 'info', 8000);
                }, 2000);
                
                console.log(` Heritage Challenge Summary:`);
                console.log(` Patterns Completed: ${completedPatterns.length}`);
                console.log(` Cultures Explored: ${cultures.join(', ')}`);
                completedPatterns.forEach(pattern => {
                    console.log(`   ${pattern.name} (${pattern.culture}, ${pattern.period})`);
                });
            }
        }
        
        function createTargetGrid() {
            const grid = document.getElementById('target-grid');
            
            // Only recreate if grid size changed
            const gridSizes = { 9: 3, 16: 4, 25: 5 };
            const cols = gridSizes[currentPattern.gridSize];
            const currentCols = grid.style.gridTemplateColumns;
            const expectedCols = `repeat(${cols}, 1fr)`;
            
            if (currentCols !== expectedCols || grid.children.length !== currentPattern.gridSize) {
                grid.innerHTML = '';
                grid.style.gridTemplateColumns = expectedCols;
                grid.style.gap = '8px';
                grid.style.maxWidth = '280px';
                
                // Create cells with document fragment for better performance
                const fragment = document.createDocumentFragment();
                for (let i = 0; i < currentPattern.gridSize; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    fragment.appendChild(cell);
                }
                grid.appendChild(fragment);
            }
            
            // Update cell states without recreating
            const cells = grid.children;
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                if (currentPattern.pattern.includes(i)) {
                    cell.classList.add('target');
                    cell.innerHTML = '';
                } else {
                    cell.classList.remove('target');
                    cell.innerHTML = '';
                }
            }
        }
        
        function createPlayerGrid() {
            const grid = document.getElementById('player-grid');
            
            // Only recreate if grid size changed
            const gridSizes = { 9: 3, 16: 4, 25: 5 };
            const cols = gridSizes[currentPattern.gridSize];
            const currentCols = grid.style.gridTemplateColumns;
            const expectedCols = `repeat(${cols}, 1fr)`;
            
            if (currentCols !== expectedCols || grid.children.length !== currentPattern.gridSize) {
                grid.innerHTML = '';
                grid.style.gridTemplateColumns = expectedCols;
                grid.style.gap = '8px';
                grid.style.maxWidth = '280px';
                
                // Create cells with document fragment for better performance
                const fragment = document.createDocumentFragment();
                for (let i = 0; i < currentPattern.gridSize; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    
                    // Use event delegation instead of individual listeners
                    if (playerData.level === 'master') {
                        cell.style.background = 'rgba(255, 255, 255, 0.05)';
                    }
                    
                    fragment.appendChild(cell);
                }
                grid.appendChild(fragment);
                
                // Add single event listener to grid for delegation
                grid.removeEventListener('click', handleGridClick);
                grid.addEventListener('click', handleGridClick);
            }
            
            // Reset cell states
            const cells = grid.children;
            for (let i = 0; i < cells.length; i++) {
                cells[i].classList.remove('selected', 'correct');
            }
        }
        
        function handleGridClick(event) {
            const cell = event.target.closest('.grid-cell');
            if (cell && cell.dataset.index !== undefined) {
                togglePatternCell(parseInt(cell.dataset.index));
            }
        }
        
        function togglePatternCell(index) {
            playSound('click');
            
            const grid = document.getElementById('player-grid');
            const cell = grid.children[index];
            
            if (playerPattern.includes(index)) {
                playerPattern = playerPattern.filter(i => i !== index);
                cell.classList.remove('selected');
            } else {
                playerPattern.push(index);
                cell.classList.add('selected');
            }
            
            updatePatternProgress();
        }
        
        let progressElement = null;
        function updatePatternProgress() {
            const correct = playerPattern.filter(i => currentPattern.pattern.includes(i)).length;
            if (!progressElement) {
                progressElement = document.getElementById('pattern-progress');
            }
            if (progressElement) {
                progressElement.textContent = `${correct}/${currentPattern.pattern.length}`;
            }
        }
        
        let isCheckingPattern = false;
        function checkHeritagePattern() {
            if (isCheckingPattern) return; // Prevent rapid clicking
            isCheckingPattern = true;
            
            playSound('click');
            
            const sortedPlayer = [...playerPattern].sort((a, b) => a - b);
            const sortedTarget = [...currentPattern.pattern].sort((a, b) => a - b);
            
            let score = 0;
            let isPerfect = false;
            
            if (JSON.stringify(sortedPlayer) === JSON.stringify(sortedTarget)) {
                score = currentPattern.points;
                isPerfect = true;
                playSound('success');
                
                // Mark cells as correct efficiently
                const grid = document.getElementById('player-grid');
                const cells = grid.children;
                for (let i = 0; i < cells.length; i++) {
                    if (cells[i].classList.contains('selected')) {
                        cells[i].classList.add('correct');
                    }
                }
                
                // Update speed run stats
                heritageSpeedRun.patternsCompleted++;
                heritageSpeedRun.totalScore += score;
                
                // Show quick feedback with historical context
                showQuickFeedback(` Perfect! +${score} pts`);
                showHistoricalAchievement(currentPattern);
                
                // Load next pattern after short delay
                setTimeout(() => {
                    loadNextPattern();
                    isCheckingPattern = false;
                }, 600);
                
            } else {
                const accuracy = calculateAccuracy(playerPattern, currentPattern.pattern);
                score = Math.floor(currentPattern.points * accuracy);
                
                if (accuracy > 0.7) {
                    playSound('success');
                    heritageSpeedRun.patternsCompleted++;
                    heritageSpeedRun.totalScore += score;
                    showQuickFeedback(`Good! ${Math.floor(accuracy * 100)}% - +${score} pts`);
                    showHistoricalAchievement(currentPattern, false);
                    
                    setTimeout(() => {
                        loadNextPattern();
                        isCheckingPattern = false;
                    }, 600);
                } else {
                    playSound('error');
                    showQuickFeedback(`Try again! ${Math.floor(accuracy * 100)}% accuracy`);
                    isCheckingPattern = false;
                }
            }
        }
        
        let feedbackTimeout;
        function showQuickFeedback(message) {
            // Clear any existing timeout
            if (feedbackTimeout) {
                clearTimeout(feedbackTimeout);
            }
            
            // Create or update feedback element
            let feedback = document.getElementById('pattern-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'pattern-feedback';
                feedback.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 212, 255, 0.95);
                    color: #000;
                    padding: 2rem 3rem;
                    border-radius: 15px;
                    font-size: 1.5rem;
                    font-weight: 700;
                    z-index: 10000;
                    box-shadow: 0 0 30px rgba(0, 212, 255, 0.6);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(feedback);
            }
            
            feedback.textContent = message;
            feedback.style.opacity = '1';
            
            feedbackTimeout = setTimeout(() => {
                feedback.style.opacity = '0';
            }, 500);
        }
        
        function resetHeritagePattern() {
            playerPattern = [];
            document.querySelectorAll('#player-grid .grid-cell').forEach(cell => {
                cell.classList.remove('selected', 'correct');
            });
            updatePatternProgress();
        }
        
        function calculateAccuracy(player, target) {
            const correct = player.filter(cell => target.includes(cell)).length;
            const incorrect = player.filter(cell => !target.includes(cell)).length;
            const missed = target.filter(cell => !player.includes(cell)).length;
            
            console.log('=== ACCURACY CALCULATION ===');
            console.log('Correct cells:', correct);
            console.log('Incorrect cells:', incorrect);
            console.log('Missed cells:', missed);
            console.log('Target length:', target.length);
            
            // More fair scoring: correct cells / total target cells, with penalty for wrong selections
            const baseAccuracy = correct / target.length;
            const penalty = (incorrect * 0.1); // 10% penalty per wrong cell
            const finalAccuracy = Math.max(0, baseAccuracy - penalty);
            
            console.log('Base accuracy:', baseAccuracy);
            console.log('Penalty:', penalty);
            console.log('Final accuracy:', finalAccuracy);
            console.log('========================');
            
            return finalAccuracy;
        }
        
        // Innovation Challenge with Narrative Video
        function initInnovationChallenge() {
            console.log(' Initializing Innovation Challenge...');
            currentQuestionIndex = 0;
            quizScore = 0;
            quizStreak = 0;
            currentScene = 1;
            videoPaused = false;
            
            // Get difficulty-based questions
            currentQuestions = quizQuestions[playerData.level];
            
            // Show narrative video for all levels
            document.getElementById('innovation-video').style.display = 'block';
            document.getElementById('quiz-container-main').style.display = 'none';
            console.log('Starting narrative video...');
            startNarrativeVideo();
        }
        
        function startNarrativeVideo() {
            // Determine which scenes to show based on difficulty
            let scenesToShow = [];
            let totalTime = 0;
            let sceneClass = '';
            
            if (playerData.level === 'apprentice') {
                scenesToShow = ['scene-1', 'scene-2', 'scene-3', 'scene-final'];
                totalTime = 32; // 8 seconds per scene (increased from 5)
                sceneClass = 'apprentice-scene';
            } else if (playerData.level === 'artisan') {
                scenesToShow = ['scene-4', 'scene-5', 'scene-6', 'scene-7', 'scene-final'];
                totalTime = 40; // 8 seconds per scene (increased from 5)
                sceneClass = 'artisan-scene';
            } else { // master
                scenesToShow = ['scene-8', 'scene-9', 'scene-10', 'scene-11', 'scene-12', 'scene-final'];
                totalTime = 48; // 8 seconds per scene (increased from 5)
                sceneClass = 'master-scene';
            }
            
            let timeLeft = totalTime;
            const timerElement = document.getElementById('narrative-timer');
            const progressElement = document.getElementById('narrative-progress');
            
            // Hide all scenes first
            document.querySelectorAll('.video-scene').forEach(scene => scene.classList.remove('active'));
            
            // Show first scene for this level
            document.getElementById(scenesToShow[0]).classList.add('active');
            currentScene = 0;
            
            // Update scene indicators
            updateSceneIndicators(scenesToShow.length);
            
            // Clear existing timer
            if (narrativeTimer) {
                clearInterval(narrativeTimer);
            }
            
            const updateNarrativeTimer = () => {
                if (!videoPaused) {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Update progress bar
                    const progress = ((totalTime - timeLeft) / totalTime) * 100;
                    progressElement.style.width = progress + '%';
                    
                    // Change scenes every 8 seconds
                    const sceneIndex = Math.floor((totalTime - timeLeft) / 8);
                    if (sceneIndex !== currentScene && sceneIndex < scenesToShow.length) {
                        changeSceneByLevel(scenesToShow, sceneIndex);
                    }
                    
                    timeLeft--;
                    
                    if (timeLeft < 0) {
                        clearInterval(narrativeTimer);
                        startQuizAfterVideo();
                    }
                }
            };
            
            updateNarrativeTimer(); // Update immediately
            narrativeTimer = setInterval(updateNarrativeTimer, 1000);
        }
        
        function changeSceneByLevel(scenesToShow, sceneIndex) {
            if (sceneIndex === currentScene || sceneIndex >= scenesToShow.length) return;
            
            // Hide current scene
            document.getElementById(scenesToShow[currentScene]).classList.remove('active');
            
            // Show new scene
            currentScene = sceneIndex;
            document.getElementById(scenesToShow[currentScene]).classList.add('active');
            
            // Update indicators
            updateSceneIndicators(scenesToShow.length);
        }
        

        
        function updateSceneIndicators(totalScenes) {
            const indicatorsContainer = document.querySelector('.scene-indicators');
            if (!indicatorsContainer) return;
            
            // Create dots based on number of scenes
            if (totalScenes) {
                indicatorsContainer.innerHTML = '';
                for (let i = 0; i < totalScenes; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'scene-dot';
                    if (i === currentScene) {
                        dot.classList.add('active');
                    }
                    indicatorsContainer.appendChild(dot);
                }
            } else {
                // Just update existing dots
                document.querySelectorAll('.scene-dot').forEach((dot, index) => {
                    if (index === currentScene) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
        }
        
        function pauseVideo() {
            videoPaused = !videoPaused;
            const pauseBtn = document.getElementById('pause-btn');
            
            if (videoPaused) {
                pauseBtn.innerHTML = '<span> Play</span>';
            } else {
                pauseBtn.innerHTML = '<span> Pause</span>';
            }
        }
        
        function skipVideo() {
            console.log('Skipping video...');
            if (narrativeTimer) {
                clearInterval(narrativeTimer);
                narrativeTimer = null;
            }
            startQuizAfterVideo();
        }
        
        function startQuizAfterVideo() {
            console.log('=== STARTING QUIZ ===');
            console.log('Player level:', playerData.level);
            
            // Hide video
            const videoElement = document.getElementById('innovation-video');
            if (videoElement) {
                videoElement.style.display = 'none';
                console.log('Video hidden');
            }
            
            // Show quiz
            const quizElement = document.getElementById('quiz-container-main');
            if (quizElement) {
                quizElement.style.display = 'block';
                console.log('Quiz container shown');
            }
            
            // Ensure we have questions
            if (!currentQuestions || currentQuestions.length === 0) {
                console.log('No current questions, loading for level:', playerData.level);
                currentQuestions = quizQuestions[playerData.level];
                console.log('Loaded questions:', currentQuestions);
            }
            
            // Reset quiz state
            currentQuestionIndex = 0;
            quizScore = 0;
            quizStreak = 0;
            
            console.log('Current questions:', currentQuestions);
            console.log('Question index:', currentQuestionIndex);
            console.log('Total questions:', currentQuestions ? currentQuestions.length : 0);
            
            // Start the main quiz timer
            const timers = {
                apprentice: { heritage: 60, innovation: 240, future: 480 },
                artisan: { heritage: 60, innovation: 180, future: 360 },
                master: { heritage: 60, innovation: 120, future: 300 }
            };
            startTimer('innovation', timers[playerData.level].innovation);
            
            updateQuizStats();
            
            console.log('Calling displayQuestion...');
            displayQuestion();
            console.log('=== QUIZ START COMPLETE ===');
        }
        
        function displayQuestion() {
            console.log('Displaying question', currentQuestionIndex);
            
            if (!currentQuestions || currentQuestions.length === 0) {
                console.error('No questions available for level:', playerData.level);
                showNotification('Error: No questions available for your difficulty level!', 'error');
                returnToDashboard();
                return;
            }
            
            if (currentQuestionIndex >= currentQuestions.length) {
                completeInnovationChallenge();
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            console.log('Current question:', question);
            
            const questionElement = document.getElementById('question-text');
            if (questionElement) {
                questionElement.textContent = question.question;
            }
            
            const optionsContainer = document.getElementById('quiz-options');
            if (!optionsContainer) {
                console.error('Quiz options container not found!');
                return;
            }
            
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = option;
                optionElement.dataset.index = index; // Store index for debugging
                optionElement.addEventListener('click', () => {
                    console.log('Option clicked:', index, '-', option);
                    selectAnswer(index);
                });
                optionsContainer.appendChild(optionElement);
                console.log(`Added option ${index}:`, option);
            });
            
            updateQuizStats();
            
            console.log('Question display complete');
        }
        
        function selectAnswer(selectedIndex) {
            const question = currentQuestions[currentQuestionIndex];
            const options = document.querySelectorAll('.quiz-option');
            
            console.log('=== ANSWER CHECK ===');
            console.log('Question:', question.question);
            console.log('Selected index:', selectedIndex);
            console.log('Correct index:', question.correct);
            console.log('Selected answer:', question.options[selectedIndex]);
            console.log('Correct answer:', question.options[question.correct]);
            console.log('Is correct?', selectedIndex === question.correct);
            console.log('==================');
            
            const isCorrect = selectedIndex === question.correct;
            
            // Play sound based on correctness
            if (isCorrect) {
                playSound('success');
            } else {
                playSound('error');
            }
            
            options.forEach((option, index) => {
                option.style.pointerEvents = 'none';
                if (index === question.correct) {
                    option.classList.add('correct');
                    console.log('Marking as correct:', option.textContent);
                } else if (index === selectedIndex && index !== question.correct) {
                    option.classList.add('incorrect');
                    console.log('Marking as incorrect:', option.textContent);
                }
            });
            
            if (isCorrect) {
                quizStreak++;
                const streakBonus = quizStreak * (playerData.level === 'master' ? 10 : 5);
                quizScore += question.points + streakBonus;
                console.log(' CORRECT! Score:', quizScore, 'Streak:', quizStreak);
            } else {
                quizStreak = 0;
                // Penalty for wrong answers on higher difficulties
                if (playerData.level === 'master') {
                    quizScore = Math.max(0, quizScore - 10);
                }
                console.log(' INCORRECT! Score:', quizScore, 'Streak reset');
            }
            
            updateQuizStats();
            
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, playerData.level === 'master' ? 1000 : 2000); // Faster pace for masters
        }
        
        function updateQuizStats() {
            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = currentQuestions.length;
            document.getElementById('quiz-score').textContent = quizScore;
            document.getElementById('quiz-streak').textContent = quizStreak;
        }
        
        function completeInnovationChallenge() {
            playSound('complete');
            updatePlayerScore(quizScore, 'innovation');
            
            // Award coins based on score
            const coinsEarned = Math.floor(quizScore / 2); // 50% of score as coins
            awardCoins(coinsEarned, `Innovation Quiz completed!`);
            
            autoSaveProgress(); // Auto-save after completing quiz
            showNotification(`Quiz complete! Final score: ${quizScore} points! Coins earned: ${coinsEarned} `, 'success', 5000);
            
            setTimeout(() => {
                returnToDashboard();
            }, 2000);
        }
        
        // Smart Textile Engineering Challenge
        function initFutureChallenge() {
            console.log(' Initializing Engineering Challenge...');
            // Show video first
            const videoElement = document.getElementById('engineering-video');
            const gameElement = document.getElementById('engineering-game');
            
            console.log('Video element:', videoElement);
            console.log('Game element:', gameElement);
            
            if (videoElement && gameElement) {
                videoElement.style.display = 'block';
                gameElement.style.display = 'none';
                console.log('Starting engineering video...');
                startEngineeringVideo();
            } else {
                console.error('Video elements not found!');
                startEngineeringChallenge();
            }
        }
        
        function startEngineeringVideo() {
            let timeLeft = 20; // Increased from 10 to 20 seconds
            engineeringSceneIndex = 1;
            
            const timerElement = document.getElementById('engineering-video-timer');
            const progressElement = document.getElementById('engineering-video-progress');
            
            if (!timerElement || !progressElement) {
                startEngineeringChallenge();
                return;
            }
            
            // Clear existing timer
            if (engineeringVideoTimer) {
                clearInterval(engineeringVideoTimer);
            }
            
            const updateEngineeringTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = ((20 - timeLeft) / 20) * 100;
                progressElement.style.width = progress + '%';
                
                const sceneTime = Math.floor((20 - timeLeft) / 6.6) + 1;
                if (sceneTime !== engineeringSceneIndex && sceneTime <= 3) {
                    changeEngineeringScene(sceneTime);
                }
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(engineeringVideoTimer);
                    startEngineeringChallenge();
                }
            };
            
            updateEngineeringTimer(); // Update immediately
            engineeringVideoTimer = setInterval(updateEngineeringTimer, 1000);
        }
        
        function changeEngineeringScene(sceneNumber) {
            const oldScene = document.getElementById(`eng-scene-${engineeringSceneIndex}`);
            const newScene = document.getElementById(`eng-scene-${sceneNumber}`);
            
            if (oldScene) oldScene.classList.remove('active');
            if (newScene) newScene.classList.add('active');
            
            engineeringSceneIndex = sceneNumber;
        }
        
        function skipEngineeringVideo() {
            if (engineeringVideoTimer) {
                clearInterval(engineeringVideoTimer);
            }
            startEngineeringChallenge();
        }
        
        function previousInnovationScene() {
            console.log(' Innovation previous clicked');
        }
        
        function nextInnovationScene() {
            console.log(' Innovation next clicked');
        }
        
        function previousEngineeringScene() {
            console.log(' Engineering previous clicked');
        }
        
        function nextEngineeringScene() {
            console.log(' Engineering next clicked');
        }
        
        function pauseEngineeringVideo() {
            console.log(' Engineering video pause clicked');
        }
        
        function startEngineeringChallenge() {
            const videoElement = document.getElementById('engineering-video');
            const gameElement = document.getElementById('engineering-game');
            
            if (videoElement) videoElement.style.display = 'none';
            if (gameElement) gameElement.style.display = 'block';
            
            // Reset composition
            engineeringComposition = { carbon: 0, silver: 0, polymer: 0, cotton: 0 };
            
            // Set difficulty-based requirements
            setEngineeringRequirements();
            
            // Reset sliders
            document.querySelectorAll('.slider').forEach(slider => {
                slider.value = 0;
            });
            
            // Start the main challenge timer
            const timers = {
                apprentice: { heritage: 60, innovation: 240, future: 480 },
                artisan: { heritage: 60, innovation: 180, future: 360 },
                master: { heritage: 60, innovation: 120, future: 300 }
            };
            startTimer('future', timers[playerData.level].future);
            
            updateComposition();
        }
        
        function setEngineeringRequirements() {
            const requirements = {
                apprentice: {
                    conductivity: 50,
                    weight: 300,
                    durability: 60,
                    cost: 70,
                    hint: "Try: 40% Polymer + 60% Cotton for a balanced, affordable design"
                },
                artisan: {
                    conductivity: 65,
                    weight: 220,
                    durability: 75,
                    cost: 55,
                    hint: "Try: 30% Carbon + 30% Polymer + 40% Cotton for good performance"
                },
                master: {
                    conductivity: 80,
                    weight: 180,
                    durability: 85,
                    cost: 45,
                    hint: "Optimize carefully: Balance high-performance materials with cost"
                }
            };
            
            const req = requirements[playerData.level];
            document.getElementById('target-conductivity').textContent = ` ${req.conductivity}%`;
            document.getElementById('target-weight').textContent = ` ${req.weight}g/m`;
            document.getElementById('target-durability').textContent = ` ${req.durability}%`;
            document.getElementById('budget-limit').textContent = ` $${req.cost}/m`;
            
            // Add hint for apprentice and artisan levels
            if (playerData.level !== 'master') {
                const missionDesc = document.getElementById('mission-description');
                missionDesc.innerHTML = `Design a smart athletic wear fabric that must meet specific performance requirements.<br><br><strong> Hint:</strong> ${req.hint}`;
            }
        }
        
        function updateComposition() {
            // Get slider values
            engineeringComposition.carbon = parseInt(document.getElementById('carbon-slider').value);
            engineeringComposition.silver = parseInt(document.getElementById('silver-slider').value);
            engineeringComposition.polymer = parseInt(document.getElementById('polymer-slider').value);
            engineeringComposition.cotton = parseInt(document.getElementById('cotton-slider').value);
            
            // Update display values
            document.getElementById('carbon-value').textContent = engineeringComposition.carbon + '%';
            document.getElementById('silver-value').textContent = engineeringComposition.silver + '%';
            document.getElementById('polymer-value').textContent = engineeringComposition.polymer + '%';
            document.getElementById('cotton-value').textContent = engineeringComposition.cotton + '%';
            
            // Check total composition
            const total = engineeringComposition.carbon + engineeringComposition.silver + 
                         engineeringComposition.polymer + engineeringComposition.cotton;
            
            const warningElement = document.getElementById('composition-warning');
            const submitButton = document.getElementById('submit-engineering');
            
            if (total === 100) {
                warningElement.textContent = ' Composition valid: 100%';
                warningElement.classList.add('valid');
                submitButton.disabled = false;
                calculateResults();
            } else {
                warningElement.textContent = ` Total composition: ${total}% (must equal 100%)`;
                warningElement.classList.remove('valid');
                submitButton.disabled = true;
            }
        }
        
        function calculateResults() {
            // Material properties
            const materials = {
                carbon: { conductivity: 95, weight: 50, durability: 90, cost: 30 },
                silver: { conductivity: 100, weight: 80, durability: 70, cost: 45 },
                polymer: { conductivity: 60, weight: 40, durability: 95, cost: 15 },
                cotton: { conductivity: 0, weight: 120, durability: 85, cost: 5 }
            };
            
            // Calculate weighted averages
            engineeringResults.conductivity = 0;
            engineeringResults.weight = 0;
            engineeringResults.durability = 0;
            engineeringResults.cost = 0;
            
            Object.keys(engineeringComposition).forEach(material => {
                const percentage = engineeringComposition[material] / 100;
                engineeringResults.conductivity += materials[material].conductivity * percentage;
                engineeringResults.weight += materials[material].weight * percentage;
                engineeringResults.durability += materials[material].durability * percentage;
                engineeringResults.cost += materials[material].cost * percentage;
            });
            
            // Update display
            updateResultsDisplay();
        }
        
        function updateResultsDisplay() {
            const requirements = {
                apprentice: { conductivity: 60, weight: 250, durability: 70, cost: 60 },
                artisan: { conductivity: 75, weight: 200, durability: 80, cost: 50 },
                master: { conductivity: 85, weight: 150, durability: 90, cost: 40 }
            };
            
            const req = requirements[playerData.level];
            
            // Conductivity
            document.getElementById('result-conductivity').style.width = engineeringResults.conductivity + '%';
            document.getElementById('conductivity-text').textContent = Math.round(engineeringResults.conductivity) + '%';
            document.getElementById('conductivity-status').textContent = 
                engineeringResults.conductivity >= req.conductivity ? '' : '';
            
            // Weight (inverse - lower is better)
            const weightPercent = Math.min(100, (engineeringResults.weight / 300) * 100);
            document.getElementById('result-weight').style.width = weightPercent + '%';
            document.getElementById('weight-text').textContent = Math.round(engineeringResults.weight) + ' g/m';
            document.getElementById('weight-status').textContent = 
                engineeringResults.weight <= req.weight ? '' : '';
            
            // Durability
            document.getElementById('result-durability').style.width = engineeringResults.durability + '%';
            document.getElementById('durability-text').textContent = Math.round(engineeringResults.durability) + '%';
            document.getElementById('durability-status').textContent = 
                engineeringResults.durability >= req.durability ? '' : '';
            
            // Cost (inverse - lower is better)
            const costPercent = Math.min(100, (engineeringResults.cost / 60) * 100);
            document.getElementById('result-cost').style.width = costPercent + '%';
            document.getElementById('cost-text').textContent = '$' + Math.round(engineeringResults.cost) + '/m';
            document.getElementById('cost-status').textContent = 
                engineeringResults.cost <= req.cost ? '' : '';
            
            // Calculate overall score
            calculateEngineeringScore(req);
        }
        
        function calculateEngineeringScore(req) {
            let score = 0;
            let breakdown = [];
            let passedCount = 0;
            
            // Conductivity (25 points) - More forgiving
            if (engineeringResults.conductivity >= req.conductivity) {
                const bonus = Math.min(15, ((engineeringResults.conductivity - req.conductivity) / 10) * 3);
                score += 25 + bonus;
                breakdown.push(`Conductivity: ${Math.round(25 + bonus)}pts`);
                passedCount++;
            } else {
                // Less harsh penalty
                const penalty = ((req.conductivity - engineeringResults.conductivity) / req.conductivity) * 15;
                score += Math.max(10, 25 - penalty);
                breakdown.push(`Conductivity: ${Math.round(Math.max(10, 25 - penalty))}pts`);
            }
            
            // Weight (25 points) - More forgiving
            if (engineeringResults.weight <= req.weight) {
                const bonus = Math.min(15, ((req.weight - engineeringResults.weight) / 50) * 3);
                score += 25 + bonus;
                breakdown.push(`Weight: ${Math.round(25 + bonus)}pts`);
                passedCount++;
            } else {
                const penalty = ((engineeringResults.weight - req.weight) / req.weight) * 15;
                score += Math.max(10, 25 - penalty);
                breakdown.push(`Weight: ${Math.round(Math.max(10, 25 - penalty))}pts`);
            }
            
            // Durability (25 points) - More forgiving
            if (engineeringResults.durability >= req.durability) {
                const bonus = Math.min(15, ((engineeringResults.durability - req.durability) / 10) * 3);
                score += 25 + bonus;
                breakdown.push(`Durability: ${Math.round(25 + bonus)}pts`);
                passedCount++;
            } else {
                const penalty = ((req.durability - engineeringResults.durability) / req.durability) * 15;
                score += Math.max(10, 25 - penalty);
                breakdown.push(`Durability: ${Math.round(Math.max(10, 25 - penalty))}pts`);
            }
            
            // Cost (25 points) - More forgiving
            if (engineeringResults.cost <= req.cost) {
                const bonus = Math.min(15, ((req.cost - engineeringResults.cost) / 10) * 3);
                score += 25 + bonus;
                breakdown.push(`Cost: ${Math.round(25 + bonus)}pts`);
                passedCount++;
            } else {
                const penalty = ((engineeringResults.cost - req.cost) / req.cost) * 15;
                score += Math.max(10, 25 - penalty);
                breakdown.push(`Cost: ${Math.round(Math.max(10, 25 - penalty))}pts`);
            }
            
            // Bonus for meeting multiple requirements
            if (passedCount >= 3) {
                score += 10;
                breakdown.push(`Bonus: +10pts`);
            }
            
            document.getElementById('engineering-score').textContent = Math.round(score);
            document.getElementById('score-breakdown').textContent = breakdown.join(' | ');
        }
        
        function submitEngineering() {
            const score = parseInt(document.getElementById('engineering-score').textContent);
            const passedCount = Array.from(document.querySelectorAll('.metric-status')).filter(el => el.textContent === '').length;
            
            updatePlayerScore(score * 10, 'future'); // Multiply by 10 for final score
            
            // Award coins based on score (100-200 coins)
            const coinsEarned = Math.floor(score * 1.5) + 50; // 50 base + up to 150 bonus
            awardCoins(coinsEarned, `Future Challenge completed!`);
            
            autoSaveProgress(); // Auto-save after completing engineering challenge
            
            let message = '';
            if (score >= 100) {
                message = ` PERFECT! Outstanding engineering! You met all requirements with bonuses!\nScore: ${score * 10} points!\nCoins earned: ${coinsEarned} `;
            } else if (score >= 85) {
                message = ` Excellent! Great optimization!\nYou passed ${passedCount}/4 requirements.\nScore: ${score * 10} points!\nCoins earned: ${coinsEarned} `;
            } else if (score >= 70) {
                message = ` Good work! Solid design.\nYou passed ${passedCount}/4 requirements.\nScore: ${score * 10} points!\nCoins earned: ${coinsEarned} `;
            } else if (score >= 50) {
                message = ` Nice try! You're getting there.\nYou passed ${passedCount}/4 requirements.\nScore: ${score * 10} points!\nCoins earned: ${coinsEarned} \n\nTip: Try adjusting your material ratios to meet more requirements.`;
            } else {
                message = ` Keep experimenting!\nYou passed ${passedCount}/4 requirements.\nScore: ${score * 10} points!\nCoins earned: ${coinsEarned} \n\nTip: ${getEngineeringTip()}`;
            }
            
            showNotification(message, 'success', 5000);
            
            setTimeout(() => {
                returnToDashboard();
            }, 2000);
        }
        
        function getEngineeringTip() {
            const tips = [
                "Carbon Nanotubes give high conductivity but are expensive.",
                "Polymer is a good balance of properties at moderate cost.",
                "Cotton is cheap and durable but doesn't conduct electricity.",
                "Silver has the best conductivity but is heavy and costly.",
                "Try mixing materials to balance different requirements."
            ];
            return tips[Math.floor(Math.random() * tips.length)];
        }
        
        function resetEngineering() {
            engineeringComposition = { carbon: 0, silver: 0, polymer: 0, cotton: 0 };
            document.querySelectorAll('.slider').forEach(slider => {
                slider.value = 0;
            });
            updateComposition();
            
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Select first color
            document.querySelector('.color-btn').classList.add('active');
            
            designMetrics = { creativity: 0, innovation: 0, functionality: 0 };
            updateDesignMetrics();
        }
        
        function addDifficultyRequirements() {
            const requirements = {
                apprentice: "Create any pattern using at least 2 colors",
                artisan: "Create a symmetrical pattern using at least 3 colors with smooth curves",
                master: "Create a complex geometric pattern using all 5 colors with mathematical precision"
            };
            
            const briefElement = document.querySelector('.canvas-container h3 + p');
            briefElement.textContent = requirements[playerData.level];
            
            // Master level: Add grid overlay for precision
            if (playerData.level === 'master') {
                addGridOverlay();
            }
        }
        
        function addGridOverlay() {
            const gridCanvas = document.createElement('canvas');
            gridCanvas.width = 600;
            gridCanvas.height = 400;
            gridCanvas.style.position = 'absolute';
            gridCanvas.style.top = '0';
            gridCanvas.style.left = '0';
            gridCanvas.style.pointerEvents = 'none';
            gridCanvas.style.opacity = '0.3';
            
            const gridCtx = gridCanvas.getContext('2d');
            gridCtx.strokeStyle = '#00FFFF';
            gridCtx.lineWidth = 1;
            
            // Draw grid
            for (let x = 0; x <= 600; x += 30) {
                gridCtx.beginPath();
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, 400);
                gridCtx.stroke();
            }
            for (let y = 0; y <= 400; y += 30) {
                gridCtx.beginPath();
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(600, y);
                gridCtx.stroke();
            }
            
            canvas.parentNode.style.position = 'relative';
            canvas.parentNode.appendChild(gridCanvas);
        }
        
        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
        }
        
        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.shadowColor = currentColor;
            ctx.shadowBlur = 10;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
            
            // Update metrics
            designMetrics.creativity = Math.min(100, designMetrics.creativity + 0.5);
            designMetrics.innovation = Math.min(100, designMetrics.innovation + 0.3);
            designMetrics.functionality = Math.min(100, designMetrics.functionality + 0.2);
            updateDesignMetrics();
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
            }
        }
        
        function clearCanvas() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            designMetrics = { creativity: 0, innovation: 0, functionality: 0 };
            updateDesignMetrics();
        }
        
        function updateDesignMetrics() {
            document.getElementById('creativity-score').textContent = Math.floor(designMetrics.creativity);
            document.getElementById('innovation-score').textContent = Math.floor(designMetrics.innovation);
            document.getElementById('functionality-score').textContent = Math.floor(designMetrics.functionality);
        }
        
        function submitDesign() {
            const totalScore = Math.floor((designMetrics.creativity + designMetrics.innovation + designMetrics.functionality) * 2);
            updatePlayerScore(totalScore, 'future');
            
            showNotification(`Design submitted! Score: ${totalScore} points!`, 'success', 4000);
            
            setTimeout(() => {
                returnToDashboard();
            }, 2000);
        }
        
        // Score Management
        function updatePlayerScore(score, challenge) {
            console.log('=== UPDATING SCORE ===');
            console.log('Challenge:', challenge);
            console.log('Raw score:', score);
            console.log('Current total:', playerData.totalScore);
            
            // Apply difficulty multipliers
            const multipliers = {
                apprentice: 1.0,
                artisan: 1.5,
                master: 2.0
            };
            
            const finalScore = Math.floor(score * multipliers[playerData.level]);
            playerData.totalScore += finalScore;
            
            console.log('Final score with multiplier:', finalScore);
            console.log('New total score:', playerData.totalScore);
            
            if (finalScore > playerData.challenges[challenge].best) {
                playerData.challenges[challenge].best = finalScore;
                console.log('New best score for', challenge, ':', finalScore);
            }
            playerData.challenges[challenge].completed = true;
            
            // Mark challenge as completed today for streak
            if (playerData.streak && playerData.streak.todayCompleted) {
                playerData.streak.todayCompleted[challenge] = true;
                console.log('Marked', challenge, 'as completed today');
                updateStreakProgress();
            }
            
            // Improve rank based on difficulty
            const rankImprovement = Math.floor(finalScore / (playerData.level === 'master' ? 25 : 50));
            if (rankImprovement > 0) {
                playerData.rank = Math.max(1, playerData.rank - rankImprovement);
                console.log('Rank improved to:', playerData.rank);
            }
            
            // Save to database
            savePlayerData();
            
            // Update ALL stats immediately
            updateChallengeStats();
            refreshDashboardStats();
            
            // ALWAYS auto-save progress after scoring
            autoSaveProgress();
            
            console.log('=== SCORE UPDATE COMPLETE ===');
            
            // Show difficulty bonus message
            if (multipliers[playerData.level] > 1.0) {
                setTimeout(() => {
                    showNotification(`${playerData.level.toUpperCase()} BONUS! Score multiplied by ${multipliers[playerData.level]}x = ${finalScore} points!`, 'success', 5000);
                }, 1000);
            }
        }
        
        // Live Updates - Optimized
        let liveStatsInterval, competitionInterval;
        let livePlayersEl, competitionTimerEl;
        
        function updateLiveStats() {
            // Cache DOM elements
            livePlayersEl = livePlayersEl || document.getElementById('live-players');
            competitionTimerEl = competitionTimerEl || document.getElementById('competition-timer');
            
            // Clear existing intervals
            if (liveStatsInterval) clearInterval(liveStatsInterval);
            if (competitionInterval) clearInterval(competitionInterval);
            
            // Update player count less frequently
            liveStatsInterval = setInterval(() => {
                if (livePlayersEl) {
                    const players = 247 + Math.floor(Math.random() * 20) - 10;
                    livePlayersEl.textContent = Math.max(200, players);
                }
            }, 10000); // Reduced frequency to 10 seconds
            
            // Competition timer
            let timeLeft = 5 * 3600 + 23 * 60 + 45;
            competitionInterval = setInterval(() => {
                if (competitionTimerEl) {
                    const hours = Math.floor(timeLeft / 3600);
                    const minutes = Math.floor((timeLeft % 3600) / 60);
                    const seconds = timeLeft % 60;
                    
                    competitionTimerEl.textContent = 
                        `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                timeLeft--;
                if (timeLeft < 0) timeLeft = 24 * 3600;
            }, 1000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Validate pattern uniqueness
            validatePatternUniqueness();
            
            // Auto-login is handled by auth.onAuthStateChanged() above
            
            // Show login form by default
            showLoginForm();
            
            updateLiveStats();
            
            // Periodic auto-save every 60 seconds (reduced frequency)
            let autoSaveInterval = setInterval(() => {
                if (playerData.email && document.getElementById('dashboard').classList.contains('active')) {
                    autoSaveProgress();
                }
            }, 60000);
            
            // Add event listeners to challenge cards
            console.log('Adding challenge card event listeners...');
            const challengeCards = document.querySelectorAll('.challenge-card');
            challengeCards.forEach((card) => {
                card.addEventListener('click', function(e) {
                    const type = card.getAttribute('data-challenge');
                    console.log('Challenge clicked:', type);
                    
                    playSound('click');
                    currentChallenge = type;
                    
                    document.getElementById('dashboard').classList.remove('active');
                    document.getElementById(`${type}-challenge`).classList.add('active');
                    
                    // Get difficulty-based timer durations
                    const timers = {
                        apprentice: { heritage: 60, innovation: 240, future: 480 },
                        artisan: { heritage: 60, innovation: 180, future: 360 },
                        master: { heritage: 60, innovation: 120, future: 300 }
                    };
                    
                    // Start appropriate challenge
                    if (type === 'heritage') {
                        initHeritageChallenge();
                        // Timer will start when video ends (in startHeritageChallenge)
                    } else if (type === 'innovation') {
                        initInnovationChallenge();
                        startTimer('innovation', timers[playerData.level].innovation);
                    } else if (type === 'future') {
                        initFutureChallenge();
                        startTimer('future', timers[playerData.level].future);
                    }
                });
            });
            console.log('Event listeners added to', challengeCards.length, 'cards');
        });
        
        // Save progress when user leaves the page
        window.addEventListener('beforeunload', function(e) {
            if (playerData.email) {
                autoSaveProgress();
                console.log('Progress saved before page unload');
            }
        });
        
        // Save progress when page visibility changes (tab switch, minimize)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && playerData.email) {
                autoSaveProgress();
                console.log('Progress saved on visibility change');
            }
        });
        
        // Test functions
        function testJoin() {
            document.getElementById('player-name').value = 'TestPlayer';
            registerPlayer();
        }
        
        function testQuiz() {
            // Quick test function to go directly to quiz
            playerData.name = 'TestPlayer';
            playerData.level = 'apprentice';
            currentQuestions = quizQuestions[playerData.level];
            currentQuestionIndex = 0;
            quizScore = 0;
            quizStreak = 0;
            
            document.getElementById('registration').classList.remove('active');
            document.getElementById('innovation-challenge').classList.add('active');
            document.getElementById('innovation-video').style.display = 'none';
            document.getElementById('quiz-container-main').style.display = 'block';
            
            displayQuestion();
        }
        
        function forceStartQuiz() {
            console.log('Force starting quiz...');
            console.log('Player level:', playerData.level);
            console.log('Quiz questions:', quizQuestions);
            
            // Ensure we have questions
            if (!currentQuestions || currentQuestions.length === 0) {
                currentQuestions = quizQuestions[playerData.level] || quizQuestions.apprentice;
                console.log('Set current questions:', currentQuestions);
            }
            
            currentQuestionIndex = 0;
            quizScore = 0;
            quizStreak = 0;
            
            console.log('Calling displayQuestion...');
            displayQuestion();
        }
        
        // Test function to verify settings button
        function testSettings() {
            console.log('Test: Settings button clicked');
            console.log('Dashboard exists:', !!document.getElementById('dashboard'));
            console.log('Settings exists:', !!document.getElementById('settings'));
            console.log('Player data:', playerData);
        }
        
        // Test function for challenge buttons
        function testChallenge(type) {
            console.log('Test: Challenge button clicked for', type);
            console.log('Heritage challenge exists:', !!document.getElementById('heritage-challenge'));
            console.log('Innovation challenge exists:', !!document.getElementById('innovation-challenge'));
            console.log('Future challenge exists:', !!document.getElementById('future-challenge'));
            console.log('startChallenge function exists:', typeof startChallenge);
        }
        
        // Speed Run Quiz Questions
        const speedRunQuestions = [
            { q: "Which ancient civilization invented the loom?", a: ["Mesopotamia", "Egypt", "Greece", "Rome"], c: 0, cat: "Ancient History" },
            { q: "What year was the Spinning Jenny invented?", a: ["1764", "1800", "1650", "1900"], c: 0, cat: "Industrial Revolution" },
            { q: "Which fiber comes from sheep?", a: ["Wool", "Cotton", "Silk", "Linen"], c: 0, cat: "Natural Fibers" },
            { q: "What is the strongest natural fiber?", a: ["Spider silk", "Cotton", "Wool", "Linen"], c: 0, cat: "Material Science" },
            { q: "Which country is famous for silk production?", a: ["China", "India", "Japan", "Italy"], c: 0, cat: "Geography" },
            { q: "What does 'textile' mean in Latin?", a: ["Woven", "Cloth", "Thread", "Fabric"], c: 0, cat: "Etymology" },
            { q: "Which invention automated weaving?", a: ["Power Loom", "Spinning Wheel", "Cotton Gin", "Sewing Machine"], c: 0, cat: "Technology" },
            { q: "What is denim made from?", a: ["Cotton", "Polyester", "Wool", "Silk"], c: 0, cat: "Modern Textiles" },
            { q: "Which fiber is synthetic?", a: ["Nylon", "Cotton", "Wool", "Silk"], c: 0, cat: "Synthetic Materials" },
            { q: "What is batik?", a: ["Wax-resist dyeing", "Weaving technique", "Embroidery", "Printing"], c: 0, cat: "Techniques" },
            { q: "Which plant produces linen?", a: ["Flax", "Cotton", "Hemp", "Jute"], c: 0, cat: "Natural Fibers" },
            { q: "What is a warp thread?", a: ["Vertical thread", "Horizontal thread", "Decorative thread", "Binding thread"], c: 0, cat: "Weaving Basics" },
            { q: "Who invented the sewing machine?", a: ["Elias Howe", "Isaac Singer", "Thomas Edison", "James Watt"], c: 0, cat: "Inventions" },
            { q: "What is tweed?", a: ["Wool fabric", "Cotton fabric", "Silk fabric", "Synthetic fabric"], c: 0, cat: "Fabric Types" },
            { q: "Which dye comes from insects?", a: ["Cochineal", "Indigo", "Madder", "Woad"], c: 0, cat: "Natural Dyes" },
            { q: "What is jacquard?", a: ["Patterned weave", "Plain weave", "Knit fabric", "Felt"], c: 0, cat: "Weaving Patterns" },
            { q: "Which fiber is waterproof?", a: ["Wool", "Cotton", "Linen", "Silk"], c: 0, cat: "Properties" },
            { q: "What is mercerization?", a: ["Cotton treatment", "Wool cleaning", "Silk processing", "Dyeing method"], c: 0, cat: "Processing" },
            { q: "Which country invented denim?", a: ["France", "USA", "Italy", "England"], c: 0, cat: "Fashion History" },
            { q: "What is a shuttle?", a: ["Weaving tool", "Cutting tool", "Dyeing tool", "Spinning tool"], c: 0, cat: "Tools" },
            { q: "Which fiber is strongest when wet?", a: ["Linen", "Cotton", "Wool", "Silk"], c: 0, cat: "Properties" },
            { q: "What is ikat?", a: ["Resist dyeing", "Weaving style", "Embroidery", "Printing"], c: 0, cat: "Techniques" },
            { q: "Which fiber is most elastic?", a: ["Wool", "Cotton", "Linen", "Silk"], c: 0, cat: "Properties" },
            { q: "What is a bobbin?", a: ["Thread holder", "Weaving frame", "Cutting tool", "Dyeing vat"], c: 0, cat: "Tools" },
            { q: "Which fabric is reversible?", a: ["Double cloth", "Plain weave", "Satin", "Twill"], c: 0, cat: "Fabric Types" }
        ];

        // Speed Run State
        let speedRunState = {
            timeLeft: 60,
            score: 0,
            correct: 0,
            streak: 0,
            answered: 0,
            currentQuestion: null,
            usedQuestions: [],
            timer: null
        };

        console.log('Chronoweave ready!');
    </script>
    
    <!-- 3D Avatar System Script -->
    <script src="avatar-3d.js"></script>
    <script>
        // 3D Avatar Integration Functions
        let avatar3DInitialized = false;

        function openAvatarBuilder() {
            playSound('click');
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('avatar-builder').classList.add('active');
            
            // Load shop state from localStorage
            loadShopState();
            
            // Render shop items
            renderAvatarShop();
            
            // Fix button visibility
            fixAvatarBuilderButtons();
            
            // Initialize 3D avatar on first open
            if (!avatar3DInitialized) {
                setTimeout(() => {
                    init3DAvatar('avatar-3d-container');
                    avatar3DInitialized = true;
                    
                    // Load saved avatar (username-specific)
                    const avatarKey = `chronoweave-3d-avatar-${playerData.email}`;
                    const saved = localStorage.getItem(avatarKey);
                    if (saved) {
                        const config = JSON.parse(saved);
                        Object.keys(config).forEach(key => {
                            updateAvatarPart(key, config[key]);
                        });
                    }
                }, 100);
            }
            
            // Update coin display
            updateCoinDisplay();
        }

        // Render avatar shop with all items
        function renderAvatarShop() {
            if (typeof avatarShop === 'undefined') {
                console.error('Avatar shop not loaded yet');
                return;
            }

            // Render skin colors (always free)
            renderShopCategory('skinColors', 'skin-colors-grid', (item) => {
                return `<div class="avatar-color-option" style="background: #${item.color.toString(16).padStart(6, '0')};" onclick="selectShopItem('skinColors', '${item.id}', this)"></div>`;
            });

            // Render hair styles
            renderShopCategory('hairStyles', 'hair-styles-grid', (item) => {
                const icons = {none: '', short: '', long: '', curly: '', spiky: '', mohawk: '', ponytail: '', bun: ''};
                const locked = !item.unlocked;
                const lockClass = locked ? 'locked shop-item' : '';
                const priceTag = locked ? `<div class="price-tag">${item.price} </div>` : '';
                return `<div class="avatar-style-option ${lockClass}" onclick="selectShopItem('hairStyles', '${item.id}', this)">
                    <div style="font-size: 2rem;">${icons[item.id] || ''}</div>
                    <div style="font-size: 0.7rem; color: #a0a0a0;">${item.name}</div>
                    ${priceTag}
                </div>`;
            });

            // Render hair colors
            renderShopCategory('hairColors', 'hair-colors-grid', (item) => {
                const locked = !item.unlocked;
                const lockClass = locked ? 'locked shop-item' : '';
                const priceTag = locked ? `<div class="price-tag">${item.price} </div>` : '';
                return `<div class="avatar-color-option ${lockClass}" style="background: #${item.color.toString(16).padStart(6, '0')};" onclick="selectShopItem('hairColors', '${item.id}', this)">${priceTag}</div>`;
            });

            // Render top colors
            renderShopCategory('topColors', 'top-colors-grid', (item) => {
                const locked = !item.unlocked;
                const lockClass = locked ? 'locked shop-item' : '';
                const priceTag = locked ? `<div class="price-tag">${item.price} </div>` : '';
                return `<div class="avatar-color-option ${lockClass}" style="background: #${item.color.toString(16).padStart(6, '0')};" onclick="selectShopItem('topColors', '${item.id}', this)">${priceTag}</div>`;
            });

            // Render bottom colors
            renderShopCategory('bottomColors', 'bottom-colors-grid', (item) => {
                const locked = !item.unlocked;
                const lockClass = locked ? 'locked shop-item' : '';
                const priceTag = locked ? `<div class="price-tag">${item.price} </div>` : '';
                return `<div class="avatar-color-option ${lockClass}" style="background: #${item.color.toString(16).padStart(6, '0')};" onclick="selectShopItem('bottomColors', '${item.id}', this)">${priceTag}</div>`;
            });

            // Render accessories
            renderShopCategory('accessories', 'accessories-grid', (item) => {
                const icons = {none: '', glasses: '', hat: '', crown: '', headphones: '', cap: '', bandana: '', visor: ''};
                const locked = !item.unlocked;
                const lockClass = locked ? 'locked shop-item' : '';
                const priceTag = locked ? `<div class="price-tag">${item.price} </div>` : '';
                return `<div class="avatar-style-option ${lockClass}" onclick="selectShopItem('accessories', '${item.id}', this)">
                    <div style="font-size: 2rem;">${icons[item.id] || ''}</div>
                    <div style="font-size: 0.7rem; color: #a0a0a0;">${item.name}</div>
                    ${priceTag}
                </div>`;
            });
        }

        function renderShopCategory(category, gridId, renderFunc) {
            const grid = document.getElementById(gridId);
            if (!grid || !avatarShop[category]) return;
            
            grid.innerHTML = avatarShop[category].map(renderFunc).join('');
        }

        function purchaseAvatarItem(category, itemId) {
            const item = avatarShop[category].find(i => i.id === itemId);
            if (!item) {
                return { success: false, message: 'Item not found!' };
            }
            
            if (item.unlocked) {
                return { success: false, message: 'Already unlocked!' };
            }
            
            if (playerData.coins < item.price) {
                return { success: false, message: `Not enough coins! Need ${item.price} ` };
            }
            
            // Deduct coins
            playerData.coins -= item.price;
            
            // Unlock item
            item.unlocked = true;
            
            // Save shop state to localStorage (username-specific)
            const shopKey = `chronoweave-shop-${playerData.email}`;
            localStorage.setItem(shopKey, JSON.stringify(avatarShop));
            
            // Save player data
            savePlayerData();
            
            return { success: true, message: `Unlocked ${item.name} for ${item.price} coins!` };
        }

        function loadShopState() {
            // Load shop state for current user
            const shopKey = `chronoweave-shop-${playerData.email}`;
            const savedShop = localStorage.getItem(shopKey);
            
            if (savedShop && typeof avatarShop !== 'undefined') {
                const shopData = JSON.parse(savedShop);
                // Merge saved unlock states with current shop
                Object.keys(shopData).forEach(category => {
                    if (avatarShop[category]) {
                        shopData[category].forEach(savedItem => {
                            const item = avatarShop[category].find(i => i.id === savedItem.id);
                            if (item) {
                                item.unlocked = savedItem.unlocked;
                            }
                        });
                    }
                });
            } else {
                // Reset all items to default locked state for new user
                if (typeof avatarShop !== 'undefined') {
                    Object.keys(avatarShop).forEach(category => {
                        avatarShop[category].forEach(item => {
                            // Keep free items unlocked
                            if (item.price === 0) {
                                item.unlocked = true;
                            } else {
                                item.unlocked = false;
                            }
                        });
                    });
                }
            }
        }

        function showSuccessMessage(message) {
            // Create non-blocking notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(76, 175, 80, 0.95);
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = ' ' + message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showErrorMessage(message) {
            // Create non-blocking notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(244, 67, 54, 0.95);
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = ' ' + message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function selectShopItem(category, itemId, element) {
            const item = avatarShop[category].find(i => i.id === itemId);
            if (!item) return;

            // If locked, try to purchase
            if (!item.unlocked) {
                const result = purchaseAvatarItem(category, itemId);
                if (result.success) {
                    console.log('Purchase successful, updating UI...');
                    
                    // Force immediate visual update
                    const priceTag = element.querySelector('.price-tag');
                    if (priceTag) {
                        priceTag.style.display = 'none';
                        priceTag.remove();
                    }
                    
                    // Remove locked class and update styling
                    element.classList.remove('locked', 'shop-item');
                    element.style.opacity = '1';
                    element.style.filter = 'none';
                    
                    // Update coin display immediately
                    updateCoinDisplay();
                    
                    console.log('Coins updated, applying item...');
                    
                    // Apply the item immediately
                    applyShopItem(category, item);
                    
                    // Show success message (non-blocking)
                    showSuccessMessage(result.message);
                    
                    console.log('Re-rendering shop...');
                    
                    // Force complete re-render
                    renderAvatarShop();
                    fixAvatarBuilderButtons();
                    
                    console.log('UI update complete!');
                } else {
                    showErrorMessage(result.message);
                }
                return;
            }

            // If unlocked, apply it
            applyShopItem(category, item);
            
            // Update selection visual
            const parent = element.parentElement;
            parent.querySelectorAll('.avatar-color-option, .avatar-style-option').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function applyShopItem(category, item) {
            switch(category) {
                case 'skinColors':
                    updateAvatarPart('skinColor', item.color);
                    break;
                case 'hairStyles':
                    updateAvatarPart('hairStyle', item.style);
                    break;
                case 'hairColors':
                    updateAvatarPart('hairColor', item.color);
                    break;
                case 'topColors':
                    updateAvatarPart('topColor', item.color);
                    break;
                case 'bottomColors':
                    updateAvatarPart('bottomColor', item.color);
                    break;
                case 'accessories':
                    updateAvatarPart('accessory', item.type);
                    break;
            }
        }

        // Fix avatar builder button visibility
        function fixAvatarBuilderButtons() {
            setTimeout(() => {
                // Fix color option buttons
                const colorOptions = document.querySelectorAll('.avatar-color-option');
                colorOptions.forEach(btn => {
                    btn.style.width = '100%';
                    btn.style.height = '60px';
                    btn.style.minHeight = '60px';
                    btn.style.display = 'block';
                    btn.style.cursor = 'pointer';
                    btn.style.border = '3px solid rgba(255, 255, 255, 0.2)';
                    btn.style.borderRadius = '10px';
                    btn.style.transition = 'all 0.3s ease';
                });

                // Fix style option buttons
                const styleOptions = document.querySelectorAll('.avatar-style-option');
                styleOptions.forEach(btn => {
                    btn.style.width = '100%';
                    btn.style.height = '90px';
                    btn.style.minHeight = '90px';
                    btn.style.display = 'flex';
                    btn.style.flexDirection = 'column';
                    btn.style.alignItems = 'center';
                    btn.style.justifyContent = 'center';
                    btn.style.cursor = 'pointer';
                    btn.style.background = 'rgba(255, 255, 255, 0.1)';
                    btn.style.border = '3px solid rgba(255, 255, 255, 0.2)';
                    btn.style.borderRadius = '10px';
                    btn.style.padding = '0.5rem';
                    btn.style.transition = 'all 0.3s ease';
                });

                console.log('Fixed', colorOptions.length, 'color buttons and', styleOptions.length, 'style buttons');
            }, 50);
        }

        function closeAvatarBuilder() {
            playSound('click');
            document.getElementById('avatar-builder').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
        }

        // Update functions for 3D avatar
        function update3DSkin(color, element) {
            updateSelection3D(element, 'avatar-color-option');
            updateAvatarPart('skinColor', color);
        }

        function update3DHairStyle(style, element) {
            updateSelection3D(element, 'avatar-style-option');
            updateAvatarPart('hairStyle', style);
        }

        function update3DHairColor(color, element) {
            updateSelection3D(element, 'avatar-color-option');
            updateAvatarPart('hairColor', color);
        }

        function update3DTopColor(color, element) {
            updateSelection3D(element, 'avatar-color-option');
            updateAvatarPart('topColor', color);
        }

        function update3DBottomColor(color, element) {
            updateSelection3D(element, 'avatar-color-option');
            updateAvatarPart('bottomColor', color);
        }

        function update3DAccessory(accessory, element) {
            updateSelection3D(element, 'avatar-style-option');
            updateAvatarPart('accessory', accessory);
        }

        function updateSelection3D(element, className) {
            const parent = element.parentElement;
            parent.querySelectorAll('.' + className).forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function save3DAvatar() {
            if (typeof currentConfig !== 'undefined') {
                const avatarKey = `chronoweave-3d-avatar-${playerData.email}`;
                localStorage.setItem(avatarKey, JSON.stringify(currentConfig));
                showSuccessMessage(' Avatar saved successfully!');
                playSound('success');
            }
        }

        function randomize3DAvatar() {
            if (typeof avatarShop === 'undefined') {
                console.error('Avatar shop not loaded');
                return;
            }
            
            // Load shop state first to ensure we have current unlock status
            loadShopState();
            
            console.log('Randomizing from unlocked items only...');
            
            // Get only unlocked items from each category
            const unlockedSkinColors = avatarShop.skinColors.filter(item => item.unlocked);
            const unlockedHairStyles = avatarShop.hairStyles.filter(item => item.unlocked);
            const unlockedHairColors = avatarShop.hairColors.filter(item => item.unlocked);
            const unlockedTopColors = avatarShop.topColors.filter(item => item.unlocked);
            const unlockedBottomColors = avatarShop.bottomColors.filter(item => item.unlocked);
            const unlockedAccessories = avatarShop.accessories.filter(item => item.unlocked);
            
            console.log('Unlocked items:', {
                skinColors: unlockedSkinColors.length,
                hairStyles: unlockedHairStyles.length,
                hairColors: unlockedHairColors.length,
                topColors: unlockedTopColors.length,
                bottomColors: unlockedBottomColors.length,
                accessories: unlockedAccessories.length
            });
            
            // Only randomize if there are unlocked items
            if (unlockedSkinColors.length > 0) {
                const item = unlockedSkinColors[Math.floor(Math.random() * unlockedSkinColors.length)];
                updateAvatarPart('skinColor', item.color);
            }
            if (unlockedHairStyles.length > 0) {
                const item = unlockedHairStyles[Math.floor(Math.random() * unlockedHairStyles.length)];
                updateAvatarPart('hairStyle', item.style);
            }
            if (unlockedHairColors.length > 0) {
                const item = unlockedHairColors[Math.floor(Math.random() * unlockedHairColors.length)];
                updateAvatarPart('hairColor', item.color);
            }
            if (unlockedTopColors.length > 0) {
                const item = unlockedTopColors[Math.floor(Math.random() * unlockedTopColors.length)];
                updateAvatarPart('topColor', item.color);
            }
            if (unlockedBottomColors.length > 0) {
                const item = unlockedBottomColors[Math.floor(Math.random() * unlockedBottomColors.length)];
                updateAvatarPart('bottomColor', item.color);
            }
            if (unlockedAccessories.length > 0) {
                const item = unlockedAccessories[Math.floor(Math.random() * unlockedAccessories.length)];
                updateAvatarPart('accessory', item.type);
            }
            
            playSound('click');
        }

        function updateCoinDisplay() {
            const coins = playerData.coins || 0;
            const coinElements = document.querySelectorAll('#avatar-coins, #player-coins');
            coinElements.forEach(el => {
                if (el) el.textContent = coins;
            });
        }

        // Award coins to player
        function awardCoins(amount, reason) {
            if (!playerData.coins) playerData.coins = 0;
            playerData.coins += amount;
            updateCoinDisplay();
            savePlayerData();
            
            const message = reason ? `+${amount} coins! ${reason}` : `+${amount} coins earned!`;
            showSuccessMessage(message);
            
            console.log(`Awarded ${amount} coins. Total: ${playerData.coins}`);
        }

        // Make awardCoins globally available
        window.awardCoins = awardCoins;
    </script>
</body>
</html>